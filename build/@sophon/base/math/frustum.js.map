{"version":3,"file":"frustum.js","sources":["../../../../libs/base/src/math/frustum.ts"],"sourcesContent":["import { Plane } from './plane';\nimport { Matrix4x4, Vector3 } from './vector';\nimport { BoxSide } from './clip_test';\nimport { BoundingBoxData } from './box_data';\n\nexport class Frustum {\n  static readonly CORNER_LEFT_TOP_NEAR = 0;\n  static readonly CORNER_LEFT_TOP_FAR = 1;\n  static readonly CORNER_RIGHT_TOP_FAR = 2;\n  static readonly CORNER_RIGHT_TOP_NEAR = 3;\n  static readonly CORNER_LEFT_BOTTOM_NEAR = 4;\n  static readonly CORNER_LEFT_BOTTOM_FAR = 5;\n  static readonly CORNER_RIGHT_BOTTOM_FAR = 6;\n  static readonly CORNER_RIGHT_BOTTOM_NEAR = 7;\n  /** @internal */\n  private _worldMatrix: Matrix4x4;\n  /** @internal */\n  private _viewProjMatrix: Matrix4x4;\n  /** @internal */\n  private _planes: Plane[];\n  /** @internal */\n  private _corners: Vector3[];\n  /** @internal */\n  private _matrixDirty: boolean;\n  constructor();\n  constructor(viewProjMatrix: Matrix4x4, worldMatrix?: Matrix4x4);\n  constructor(other: Frustum);\n  constructor(arg0?: Matrix4x4 | Frustum, arg1?: Matrix4x4) {\n    this._planes = null;\n    this._corners = null;\n    if (arg0 instanceof Frustum) {\n      this.setMatrix(arg0.viewProjectionMatrix, arg0.worldMatrix);\n    } else {\n      this.setMatrix(arg0, arg1);\n    }\n    this._viewProjMatrix.setChangeCallback(() => this._invalidate());\n    this._worldMatrix.setChangeCallback(() => this._invalidate());\n  }\n  get worldMatrix() {\n    return this._worldMatrix;\n  }\n  set worldMatrix(m: Matrix4x4) {\n    this.setWorldMatrix(m);\n  }\n  setWorldMatrix(m: Matrix4x4) {\n    this._worldMatrix = (this._worldMatrix || new Matrix4x4()).assign((m || Matrix4x4.identity()).getArray());\n    this._invalidate();\n    return this;\n  }\n  get viewProjectionMatrix() {\n    return this._viewProjMatrix;\n  }\n  set viewProjectionMatrix(m: Matrix4x4) {\n    this.setViewProjectionMatrix(m);\n  }\n  setViewProjectionMatrix(m: Matrix4x4) {\n    this._viewProjMatrix = (this._viewProjMatrix || new Matrix4x4()).assign(\n      (m || Matrix4x4.identity()).getArray(),\n    );\n    this._invalidate();\n    return this;\n  }\n  setMatrix(viewProjMatrix: Matrix4x4, worldMatrix: Matrix4x4) {\n    this.setViewProjectionMatrix(viewProjMatrix);\n    this.setWorldMatrix(worldMatrix);\n    return this;\n  }\n  transform(m: Matrix4x4) {\n    if (m) {\n      this._worldMatrix.multiplyLeft(m);\n      this._matrixDirty = true;\n    }\n    return this;\n  }\n  get planes() {\n    if (this._matrixDirty) {\n      this._matrixDirty = false;\n      this._initWithMatrix();\n    }\n    return this._planes;\n  }\n  get corners() {\n    if (this._matrixDirty) {\n      this._matrixDirty = false;\n      this._initWithMatrix();\n    }\n    return this._corners;\n  }\n  getCorner(pos: number) {\n    return this.corners[pos];\n  }\n  /** @internal */\n  private _invalidate() {\n    this._matrixDirty = true;\n  }\n  /** @internal */\n  private _initWithMatrix() {\n    const matrix = Matrix4x4.multiply(this._viewProjMatrix, this._worldMatrix);\n    this._planes = this._planes || Array.from({ length: 6 }).map(() => new Plane());\n    this._planes[BoxSide.LEFT]\n      .set(\n        matrix.m30 + matrix.m00,\n        matrix.m31 + matrix.m01,\n        matrix.m32 + matrix.m02,\n        matrix.m33 + matrix.m03,\n      )\n      .inplaceNormalize();\n    this._planes[BoxSide.RIGHT]\n      .set(\n        matrix.m30 - matrix.m00,\n        matrix.m31 - matrix.m01,\n        matrix.m32 - matrix.m02,\n        matrix.m33 - matrix.m03,\n      )\n      .inplaceNormalize();\n    this._planes[BoxSide.BOTTOM]\n      .set(\n        matrix.m30 + matrix.m10,\n        matrix.m31 + matrix.m11,\n        matrix.m32 + matrix.m12,\n        matrix.m33 + matrix.m13,\n      )\n      .inplaceNormalize();\n    this._planes[BoxSide.TOP]\n      .set(\n        matrix.m30 - matrix.m10,\n        matrix.m31 - matrix.m11,\n        matrix.m32 - matrix.m12,\n        matrix.m33 - matrix.m13,\n      )\n      .inplaceNormalize();\n    this._planes[BoxSide.FRONT]\n      .set(\n        matrix.m30 + matrix.m20,\n        matrix.m31 + matrix.m21,\n        matrix.m32 + matrix.m22,\n        matrix.m33 + matrix.m23,\n      )\n      .inplaceNormalize();\n    this._planes[BoxSide.BACK]\n      .set(\n        matrix.m30 - matrix.m20,\n        matrix.m31 - matrix.m21,\n        matrix.m32 - matrix.m22,\n        matrix.m33 - matrix.m23,\n      )\n      .inplaceNormalize();\n    const invMatrix = Matrix4x4.inverse(matrix);\n    const ndcVertices: Vector3[] = BoundingBoxData.ndcVertices.map(\n      (v) => new Vector3(v[0], v[1], v[2]),\n    );\n    this._corners = this._corners || [];\n    for (let i = 0; i < 8; i++) {\n      const v = invMatrix.transformPoint(ndcVertices[i]);\n      this._corners[i] = v.scaleBy(1 / v.w).xyz();\n    }\n    return this;\n  }\n  containsPoint(pt: Vector3): boolean {\n    for (const p of this.planes) {\n      if (p.distanceToPoint(pt) < 0) {\n        return false;\n      }\n    }\n    return true;\n  }\n}\n"],"names":[],"mappings":"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"}
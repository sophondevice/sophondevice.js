{"version":3,"file":"sampler_webgl.js","sources":["../../../../../libs/device/src/device/webgl/sampler_webgl.ts"],"sourcesContent":["import { WebGLGPUObject } from './gpuobject_webgl';\r\nimport { WebGLEnum } from './webgl_enum';\r\nimport { TextureWrapping, TextureFilter } from '../base_types';\r\nimport { textureTargetMap, textureWrappingMap, textureMagFilterToWebGL, textureMinFilterToWebGL, compareFuncMap } from './constants_webgl';\r\nimport type { SamplerOptions, TextureSampler } from '../gpuobject';\r\nimport type { WebGLBaseTexture } from './basetexture_webgl';\r\nimport type { WebGLDevice } from './device_webgl';\r\nimport { isWebGL2 } from './utils';\r\n\r\nexport class WebGLTextureSampler extends WebGLGPUObject<WebGLSampler> implements TextureSampler<WebGLSampler>\r\n{\r\n  private _options: SamplerOptions;\r\n  constructor(device: WebGLDevice, options: SamplerOptions) {\r\n    super(device);\r\n    this._options = Object.assign({\r\n      addressU: TextureWrapping.ClampToEdge,\r\n      addressV: TextureWrapping.ClampToEdge,\r\n      addressW: TextureWrapping.ClampToEdge,\r\n      magFilter: TextureFilter.Nearest,\r\n      minFilter: TextureFilter.Nearest,\r\n      mipFilter: TextureFilter.None,\r\n      lodMin: 0,\r\n      lodMax: 32,\r\n      compare: null,\r\n      maxAnisotropy: 1\r\n    }, options || {});\r\n    this._load();\r\n  }\r\n  get addressModeU() {\r\n    return this._options.addressU;\r\n  }\r\n  get addressModeV() {\r\n    return this._options.addressV;\r\n  }\r\n  get addressModeW() {\r\n    return this._options.addressW;\r\n  }\r\n  get magFilter() {\r\n    return this._options.magFilter;\r\n  }\r\n  get minFilter() {\r\n    return this._options.minFilter;\r\n  }\r\n  get mipFilter() {\r\n    return this._options.mipFilter;\r\n  }\r\n  get lodMin() {\r\n    return this._options.lodMin;\r\n  }\r\n  get lodMax() {\r\n    return this._options.lodMax;\r\n  }\r\n  get compare() {\r\n    return this._options.compare;\r\n  }\r\n  get maxAnisotropy() {\r\n    return this._options.maxAnisotropy;\r\n  }\r\n  destroy() {\r\n    if (this._object && isWebGL2(this._device.context)) {\r\n      (this._device.context as WebGL2RenderingContext).deleteSampler(this._object);\r\n    }\r\n    this._object = null;\r\n  }\r\n  async restore() {\r\n    if (!this._object && !this._device.isContextLost()) {\r\n      this._load();\r\n    }\r\n  }\r\n  apply(texture: WebGLBaseTexture) {\r\n    if (texture?.object && !this._device.isWebGL2 && !this._device.isContextLost()) {\r\n      const gl = this._device.context;\r\n      const target = textureTargetMap[texture.target];\r\n      gl.bindTexture(target, texture.object);\r\n      gl.texParameteri(target, WebGLEnum.TEXTURE_WRAP_S, textureWrappingMap[this._options.addressU]);\r\n      gl.texParameteri(target, WebGLEnum.TEXTURE_WRAP_T, textureWrappingMap[this._options.addressV]);\r\n      gl.texParameteri(target, WebGLEnum.TEXTURE_MAG_FILTER, textureMagFilterToWebGL(this._options.magFilter));\r\n      gl.texParameteri(target, WebGLEnum.TEXTURE_MIN_FILTER, textureMinFilterToWebGL(this._options.minFilter, this._options.mipFilter));\r\n      if (this._device.getTextureCaps().supportAnisotropicFiltering) {\r\n        gl.texParameterf(target, WebGLEnum.TEXTURE_MAX_ANISOTROPY, this._options.maxAnisotropy);\r\n      }\r\n    }\r\n  }\r\n  private _load(): boolean {\r\n    if (!isWebGL2(this._device.context)) {\r\n      this._object = {};\r\n      return true;\r\n    }\r\n    if (!this._device.isContextLost()) {\r\n      const gl = this._device.context;\r\n      if (!this._object) {\r\n        this._object = gl.createSampler();\r\n      }\r\n      gl.samplerParameteri(this._object, WebGLEnum.TEXTURE_WRAP_S, textureWrappingMap[this._options.addressU]);\r\n      gl.samplerParameteri(this._object, WebGLEnum.TEXTURE_WRAP_T, textureWrappingMap[this._options.addressV]);\r\n      gl.samplerParameteri(this._object, WebGLEnum.TEXTURE_WRAP_R, textureWrappingMap[this._options.addressW]);\r\n      gl.samplerParameteri(this._object, WebGLEnum.TEXTURE_MAG_FILTER, textureMagFilterToWebGL(this._options.magFilter));\r\n      gl.samplerParameteri(this._object, WebGLEnum.TEXTURE_MIN_FILTER, textureMinFilterToWebGL(this._options.minFilter, this._options.mipFilter));\r\n      gl.samplerParameterf(this._object, WebGLEnum.TEXTURE_MIN_LOD, this._options.lodMin);\r\n      gl.samplerParameterf(this._object, WebGLEnum.TEXTURE_MAX_LOD, this._options.lodMax);\r\n      if (this._options.compare === null) {\r\n        gl.samplerParameteri(this._object, WebGLEnum.TEXTURE_COMPARE_MODE, WebGLEnum.NONE);\r\n      } else {\r\n        gl.samplerParameteri(this._object, WebGLEnum.TEXTURE_COMPARE_MODE, WebGLEnum.COMPARE_REF_TO_TEXTURE);\r\n        gl.samplerParameteri(this._object, WebGLEnum.TEXTURE_COMPARE_FUNC, compareFuncMap[this._options.compare]);\r\n      }\r\n      if (this._device.getTextureCaps().supportAnisotropicFiltering) {\r\n        gl.samplerParameterf(this._object, WebGLEnum.TEXTURE_MAX_ANISOTROPY, this._options.maxAnisotropy);\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n  isSampler(): boolean {\r\n    return true;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
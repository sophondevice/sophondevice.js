{"version":3,"file":"framebuffer_webgl.js","sources":["../../../../../libs/device/src/device/webgl/framebuffer_webgl.ts"],"sourcesContent":["import { CubeFace } from '@sophon/base';\r\nimport { WebGLGPUObject } from './gpuobject_webgl';\r\nimport { WebGLEnum } from './webgl_enum';\r\nimport { BaseTexture, IFrameBufferTextureAttachment, FrameBuffer, IFrameBufferOptions, GPUResourceUsageFlags } from '../gpuobject';\r\nimport { cubeMapFaceMap } from './constants_webgl';\r\nimport type { WebGLDevice } from './device_webgl';\r\nimport { hasStencilChannel } from '../base_types';\r\n\r\nconst STATUS_UNCHECKED = 0;\r\nconst STATUS_OK = 1;\r\nconst STATUS_FAILED = 2;\r\nexport class WebGLFrameBuffer extends WebGLGPUObject<WebGLFramebuffer> implements FrameBuffer<WebGLFramebuffer> {\r\n  private _options: IFrameBufferOptions;\r\n  private _viewport: number[];\r\n  private _scissor: [number, number, number, number];\r\n  private _needBindBuffers: boolean;\r\n  private _status: number;\r\n  private _width: number;\r\n  private _height: number;\r\n  private _isMRT: boolean;\r\n  private _drawBuffers: number[];\r\n  constructor(device: WebGLDevice, opt?: IFrameBufferOptions) {\r\n    super(device);\r\n    this._object = null;\r\n    this._viewport = [0, 0, 0, 0];\r\n    this._scissor = null;\r\n    this._needBindBuffers = false;\r\n    this._status = STATUS_UNCHECKED;\r\n    this._options = {\r\n      colorAttachments: opt?.colorAttachments\r\n        ? opt.colorAttachments.map((value) => Object.assign({\r\n          texture: null,\r\n          face: 0,\r\n          layer: 0,\r\n          level: 0\r\n        }, value))\r\n        : null,\r\n      depthAttachment: opt?.depthAttachment ? Object.assign({}, opt.depthAttachment) : null\r\n    };\r\n    this._width = 0;\r\n    this._height = 0;\r\n    this._drawBuffers = this._options.colorAttachments.map((val, index) => val.texture ? WebGLEnum.COLOR_ATTACHMENT0 + index : WebGLEnum.NONE);\r\n    this._isMRT = this._drawBuffers.length > 1;\r\n    this._init();\r\n  }\r\n  getViewport(): number[] {\r\n    return this._viewport;\r\n  }\r\n  setViewport(vp: number[]): void {\r\n    this._viewport = [...vp];\r\n  }\r\n  getScissorRect(): number[] {\r\n    return this._scissor;\r\n  }\r\n  setScissorRect(scissor: [number, number, number, number]): void {\r\n    this._scissor = scissor ? [...scissor] : null;\r\n  }\r\n  isMRT(): boolean {\r\n    return this._isMRT;\r\n  }\r\n  getWidth(): number {\r\n    return this._width;\r\n  }\r\n  getHeight(): number {\r\n    return this._height;\r\n  }\r\n  async restore() {\r\n    if (!this._object && !this._device.isContextLost()) {\r\n      if (this._options?.depthAttachment?.texture?.disposed) {\r\n        await this._options.depthAttachment.texture.reload();\r\n      }\r\n      if (this._options?.colorAttachments) {\r\n        for (const k of this._options.colorAttachments) {\r\n          if (k?.texture?.disposed) {\r\n            await k.texture.reload();\r\n          }\r\n        }\r\n      }\r\n    }\r\n    this._init();\r\n  }\r\n  destroy() {\r\n    if (this._object) {\r\n      this._device.context.deleteFramebuffer(this._object);\r\n      this._object = null;\r\n    }\r\n  }\r\n  setCubeTextureFace(index: number, face: CubeFace) {\r\n    const k = this._options.colorAttachments[index];\r\n    if (k && k.face !== face) {\r\n      k.face = face;\r\n      this._needBindBuffers = true;\r\n      if (this._device.context._currentFramebuffer === this) {\r\n        this.bind();\r\n      }\r\n    }\r\n  }\r\n  setTextureLevel(index: number, level: number) {\r\n    const k = this._options.colorAttachments[index];\r\n    if (k && k.level !== level) {\r\n      k.level = level;\r\n      this._needBindBuffers = true;\r\n      if (this._device.context._currentFramebuffer === this) {\r\n        this.bind();\r\n      }\r\n    }\r\n  }\r\n  setTextureLayer(index: number, layer: number) {\r\n    const k = this._options.colorAttachments[index];\r\n    if (k && k.layer !== layer) {\r\n      k.layer = layer;\r\n      this._needBindBuffers = true;\r\n      if (this._device.context._currentFramebuffer === this) {\r\n        this.bind();\r\n      }\r\n    }\r\n  }\r\n  setDepthTextureLayer(layer: number) {\r\n    const k = this._options.depthAttachment;\r\n    if (k && k.layer !== layer) {\r\n      k.layer = layer;\r\n      this._needBindBuffers = true;\r\n      if (this._device.context._currentFramebuffer === this) {\r\n        this.bind();\r\n      }\r\n    }\r\n  }\r\n  getDepthAttachment(): BaseTexture {\r\n    return this._options?.depthAttachment?.texture || null;\r\n  }\r\n  getColorAttachments(): BaseTexture[] {\r\n    return this._options.colorAttachments?.map(val => val.texture || null) || [];\r\n  }\r\n  bind(): boolean {\r\n    if (this._object) {\r\n      this._device.context.bindFramebuffer(WebGLEnum.FRAMEBUFFER, this._object);\r\n      this._device.context._currentFramebuffer = this;\r\n      if (this._needBindBuffers) {\r\n        this._needBindBuffers = false;\r\n        if (!this._bindBuffers()) {\r\n          this._device.context.bindFramebuffer(WebGLEnum.FRAMEBUFFER, null);\r\n          this._device.context._currentFramebuffer = null;\r\n          return false;\r\n        }\r\n      }\r\n      const drawBuffersExt = this._device.drawBuffersExt;\r\n      if (drawBuffersExt) {\r\n        drawBuffersExt.drawBuffers(this._drawBuffers);\r\n      } else if (this._isMRT) {\r\n        console.error('device does not support multiple framebuffer color attachments');\r\n      }\r\n      this._device.setViewport();\r\n      this._device.setScissor();\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n  unbind(): void {\r\n    if (this._device.context._currentFramebuffer === this) {\r\n      this._device.context.bindFramebuffer(WebGLEnum.FRAMEBUFFER, null);\r\n      this._device.context._currentFramebuffer = null;\r\n      this._device.setViewport();\r\n      this._device.setScissor();\r\n      const drawBuffersExt = this._device.drawBuffersExt;\r\n      if (drawBuffersExt) {\r\n        drawBuffersExt.drawBuffers([WebGLEnum.BACK]);\r\n      }\r\n    }\r\n  }\r\n  private _load(): void {\r\n    if (this._device.isContextLost()) {\r\n      return;\r\n    }\r\n    this._object = this._device.context.createFramebuffer();\r\n    this._device.context.bindFramebuffer(WebGLEnum.FRAMEBUFFER, this._object);\r\n    if (!this._bindBuffers()) {\r\n      this.dispose();\r\n    }\r\n    this._device.context.bindFramebuffer(WebGLEnum.FRAMEBUFFER, null);\r\n    this._device.context._currentFramebuffer = null;\r\n  }\r\n  private _bindAttachment(attachment: number, info: IFrameBufferTextureAttachment): boolean {\r\n    if (info.texture) {\r\n      if (info.texture.isTexture2D()) {\r\n        this._device.context.framebufferTexture2D(\r\n          WebGLEnum.FRAMEBUFFER,\r\n          attachment,\r\n          WebGLEnum.TEXTURE_2D,\r\n          info.texture.object,\r\n          info.level ?? 0\r\n        );\r\n      } else if (info.texture.isTextureCube()) {\r\n        this._device.context.framebufferTexture2D(\r\n          WebGLEnum.FRAMEBUFFER,\r\n          attachment,\r\n          cubeMapFaceMap[info.face ?? CubeFace.PX],\r\n          info.texture.object,\r\n          info.level ?? 0,\r\n        );\r\n      } else if (info.texture.isTexture2DArray() || info.texture.isTexture3D()) {\r\n        (this._device.context as WebGL2RenderingContext).framebufferTextureLayer(\r\n          WebGLEnum.FRAMEBUFFER,\r\n          attachment,\r\n          info.texture.object,\r\n          info.level ?? 0,\r\n          info.layer ?? 0\r\n        );\r\n      } else {\r\n        return false;\r\n      }\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n  private _bindBuffers(): boolean {\r\n    if (this._options.depthAttachment?.texture) {\r\n      let target: number;\r\n      if (hasStencilChannel(this._options.depthAttachment.texture.format)) {\r\n        target = WebGLEnum.DEPTH_STENCIL_ATTACHMENT;\r\n      } else {\r\n        target = WebGLEnum.DEPTH_ATTACHMENT;\r\n      }\r\n      if (!this._bindAttachment(target, this._options.depthAttachment)) {\r\n        return false;\r\n      }\r\n    }\r\n    for (let i = 0; i < this._options.colorAttachments.length; i++) {\r\n      const opt = this._options.colorAttachments[i];\r\n      if (opt.texture) {\r\n        if (!this._bindAttachment(WebGLEnum.COLOR_ATTACHMENT0 + i, opt)) {\r\n          return false;\r\n        }\r\n      }\r\n    }\r\n    if (this._status === STATUS_UNCHECKED) {\r\n      const status = this._device.context.checkFramebufferStatus(WebGLEnum.FRAMEBUFFER);\r\n      if (status !== WebGLEnum.FRAMEBUFFER_COMPLETE) {\r\n        console.error(`Framebuffer not complete: ${status}`);\r\n        this._status = STATUS_FAILED;\r\n      } else {\r\n        this._status = STATUS_OK;\r\n      }\r\n    }\r\n    return this._status === STATUS_OK;\r\n  }\r\n  private _init(): void {\r\n    this._width = 0;\r\n    this._height = 0;\r\n    for (const colorAttachment of this._options.colorAttachments) {\r\n      if (colorAttachment.texture) {\r\n        if (this._width === 0) {\r\n          this._width = colorAttachment.texture.width;\r\n        }\r\n        if (this._height === 0) {\r\n          this._height = colorAttachment.texture.height;\r\n        }\r\n        if (this._width !== colorAttachment.texture.width || this._height !== colorAttachment.texture.height) {\r\n          console.error('init frame buffer failed: color attachment textures must have same size');\r\n          return;\r\n        }\r\n      }\r\n    }\r\n    if (this._width === 0 || this._height === 0) {\r\n      console.error('init frame buffer failed: can not create frame buffer with zero size');\r\n    }\r\n    this._load();\r\n    this._viewport = [0, 0, this._width, this._height];\r\n  }\r\n  isFramebuffer(): boolean {\r\n    return true;\r\n  }\r\n  getSampleCount(): number {\r\n    return 1;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
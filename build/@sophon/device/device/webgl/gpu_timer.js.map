{"version":3,"file":"gpu_timer.js","sources":["../../../../../libs/device/src/device/webgl/gpu_timer.ts"],"sourcesContent":["import {isWebGL2} from './utils';\nimport {WebGLEnum} from './webgl_enum';\nimport type {ITimer} from '../timer';\nimport type {WebGLDevice} from './device_webgl';\n\nconst GPU_DISJOINT_EXT = 0x8fbb;\nconst TIME_ELAPSED_EXT = 0x88bf;\n\nconst enum QueryState {\n  QUERY_STATE_NONE = 0,\n  QUERY_STATE_QUERYING = 1,\n  QUERY_STATE_FINISHED = 2,\n}\n\ninterface ITimerQuery {\n  createQuery: () => unknown;\n  deleteQuery: (query: unknown) => void;\n  isQuery: (query: unknown) => boolean;\n  beginQuery: (target: number, query: unknown) => void;\n  endQuery: (target: number) => void;\n  getQuery: (target: number, pname: number) => unknown;\n  getQueryObject: (query: unknown, pname: number) => unknown;\n  queryCounter: (query: unknown, target: number) => void;\n}\n\nexport class GPUTimer implements ITimer {\n  private _device: WebGLDevice;\n  private _query: unknown;\n  private _state: QueryState;\n  private _timerQuery: ITimerQuery;\n  private _gpuTime: number;\n  constructor(device: WebGLDevice) {\n    this._device = device;\n    this._state = QueryState.QUERY_STATE_NONE;\n    this._gpuTime = null;\n    const gl = this._device.context;\n    if (isWebGL2(gl)) {\n      const ext = gl.getExtension('EXT_disjoint_timer_query_webgl2');\n      if (ext) {\n        this._timerQuery = {\n          createQuery: gl.createQuery.bind(gl),\n          deleteQuery: gl.deleteQuery.bind(gl),\n          beginQuery: gl.beginQuery.bind(gl),\n          endQuery: gl.endQuery.bind(gl),\n          isQuery: gl.isQuery.bind(gl),\n          getQuery: gl.getQuery.bind(gl),\n          getQueryObject: gl.getQueryParameter.bind(gl),\n          queryCounter: ext.queryCounterEXT.bind(ext),\n        };\n      }\n    } else {\n      const ext = gl.getExtension('EXT_disjoint_timer_query');\n      if (ext) {\n        this._timerQuery = {\n          createQuery: ext.createQueryEXT.bind(ext),\n          deleteQuery: ext.deleteQueryEXT.bind(ext),\n          beginQuery: ext.beginQueryEXT.bind(ext),\n          endQuery: ext.endQueryEXT.bind(ext),\n          isQuery: ext.isQueryEXT.bind(ext),\n          getQuery: ext.getQueryEXT.bind(ext),\n          getQueryObject: ext.getQueryObjectEXT.bind(ext),\n          queryCounter: ext.queryCounterEXT.bind(ext),\n        };\n      }\n    }\n    this._query = this._timerQuery ? this._timerQuery.createQuery() : null;\n  }\n  get gpuTimerSupported() {\n    return !!this._query;\n  }\n  begin() {\n    if (this._state === QueryState.QUERY_STATE_QUERYING) {\n      this.end();\n    }\n    if (this._query) {\n      this._timerQuery.beginQuery(TIME_ELAPSED_EXT, this._query);\n    }\n    this._gpuTime = null;\n    this._state = QueryState.QUERY_STATE_QUERYING;\n  }\n  end() {\n    if (this._state === QueryState.QUERY_STATE_QUERYING) {\n      if (this._query) {\n        this._timerQuery.endQuery(TIME_ELAPSED_EXT);\n      }\n      this._state = QueryState.QUERY_STATE_FINISHED;\n    }\n  }\n  ended(): boolean {\n    return this._state !== QueryState.QUERY_STATE_QUERYING;\n  }\n  elapsed(): number {\n    if (this._state === QueryState.QUERY_STATE_FINISHED) {\n      if (\n        this._gpuTime === null &&\n        this._query &&\n        this._timerQuery.getQueryObject(this._query, WebGLEnum.QUERY_RESULT_AVAILABLE)\n      ) {\n        const gpuTimerDisjoint = this._device.context.getParameter(GPU_DISJOINT_EXT);\n        if (!gpuTimerDisjoint) {\n          this._gpuTime =\n            Number(this._timerQuery.getQueryObject(this._query, WebGLEnum.QUERY_RESULT)) / 1000000;\n        }\n      }\n    }\n    return this._gpuTime;\n  }\n}\n"],"names":[],"mappings":";;;;AAKA,MAAM,gBAAgB,GAAG,MAAM,CAAC;AAChC,MAAM,gBAAgB,GAAG,MAAM,CAAC;MAmBnB,QAAQ,CAAA;AACX,IAAA,OAAO,CAAc;AACrB,IAAA,MAAM,CAAU;AAChB,IAAA,MAAM,CAAa;AACnB,IAAA,WAAW,CAAc;AACzB,IAAA,QAAQ,CAAS;AACzB,IAAA,WAAA,CAAY,MAAmB,EAAA;AAC7B,QAAA,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC;QACtB,IAAI,CAAC,MAAM,GAAA,CAA8B,CAAC;AAC1C,QAAA,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;AACrB,QAAA,MAAM,EAAE,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC;AAChC,QAAA,IAAI,QAAQ,CAAC,EAAE,CAAC,EAAE;YAChB,MAAM,GAAG,GAAG,EAAE,CAAC,YAAY,CAAC,iCAAiC,CAAC,CAAC;AAC/D,YAAA,IAAI,GAAG,EAAE;gBACP,IAAI,CAAC,WAAW,GAAG;oBACjB,WAAW,EAAE,EAAE,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,CAAC;oBACpC,WAAW,EAAE,EAAE,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,CAAC;oBACpC,UAAU,EAAE,EAAE,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC;oBAClC,QAAQ,EAAE,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE,CAAC;oBAC9B,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC;oBAC5B,QAAQ,EAAE,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE,CAAC;oBAC9B,cAAc,EAAE,EAAE,CAAC,iBAAiB,CAAC,IAAI,CAAC,EAAE,CAAC;oBAC7C,YAAY,EAAE,GAAG,CAAC,eAAe,CAAC,IAAI,CAAC,GAAG,CAAC;iBAC5C,CAAC;AACH,aAAA;AACF,SAAA;AAAM,aAAA;YACL,MAAM,GAAG,GAAG,EAAE,CAAC,YAAY,CAAC,0BAA0B,CAAC,CAAC;AACxD,YAAA,IAAI,GAAG,EAAE;gBACP,IAAI,CAAC,WAAW,GAAG;oBACjB,WAAW,EAAE,GAAG,CAAC,cAAc,CAAC,IAAI,CAAC,GAAG,CAAC;oBACzC,WAAW,EAAE,GAAG,CAAC,cAAc,CAAC,IAAI,CAAC,GAAG,CAAC;oBACzC,UAAU,EAAE,GAAG,CAAC,aAAa,CAAC,IAAI,CAAC,GAAG,CAAC;oBACvC,QAAQ,EAAE,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC;oBACnC,OAAO,EAAE,GAAG,CAAC,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC;oBACjC,QAAQ,EAAE,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC;oBACnC,cAAc,EAAE,GAAG,CAAC,iBAAiB,CAAC,IAAI,CAAC,GAAG,CAAC;oBAC/C,YAAY,EAAE,GAAG,CAAC,eAAe,CAAC,IAAI,CAAC,GAAG,CAAC;iBAC5C,CAAC;AACH,aAAA;AACF,SAAA;AACD,QAAA,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC,WAAW,EAAE,GAAG,IAAI,CAAC;KACxE;AACD,IAAA,IAAI,iBAAiB,GAAA;AACnB,QAAA,OAAO,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC;KACtB;IACD,KAAK,GAAA;AACH,QAAA,IAAI,IAAI,CAAC,MAAM,KAAA,CAAoC,EAAE;YACnD,IAAI,CAAC,GAAG,EAAE,CAAC;AACZ,SAAA;QACD,IAAI,IAAI,CAAC,MAAM,EAAE;YACf,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,gBAAgB,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;AAC5D,SAAA;AACD,QAAA,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACrB,IAAI,CAAC,MAAM,GAAA,CAAkC,CAAC;KAC/C;IACD,GAAG,GAAA;AACD,QAAA,IAAI,IAAI,CAAC,MAAM,KAAA,CAAoC,EAAE;YACnD,IAAI,IAAI,CAAC,MAAM,EAAE;AACf,gBAAA,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,gBAAgB,CAAC,CAAC;AAC7C,aAAA;YACD,IAAI,CAAC,MAAM,GAAA,CAAkC,CAAC;AAC/C,SAAA;KACF;IACD,KAAK,GAAA;AACH,QAAA,OAAO,IAAI,CAAC,MAAM,KAAA,CAAoC,CAAC;KACxD;IACD,OAAO,GAAA;AACL,QAAA,IAAI,IAAI,CAAC,MAAM,KAAA,CAAoC,EAAE;AACnD,YAAA,IACE,IAAI,CAAC,QAAQ,KAAK,IAAI;AACtB,gBAAA,IAAI,CAAC,MAAM;AACX,gBAAA,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,EAAE,SAAS,CAAC,sBAAsB,CAAC,EAC9E;AACA,gBAAA,MAAM,gBAAgB,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,gBAAgB,CAAC,CAAC;gBAC7E,IAAI,CAAC,gBAAgB,EAAE;AACrB,oBAAA,IAAI,CAAC,QAAQ;AACX,wBAAA,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,EAAE,SAAS,CAAC,YAAY,CAAC,CAAC,GAAG,OAAO,CAAC;AAC1F,iBAAA;AACF,aAAA;AACF,SAAA;QACD,OAAO,IAAI,CAAC,QAAQ,CAAC;KACtB;AACF;;;;"}
{"version":3,"file":"gpu_timer.js","sources":["../../../../../libs/device/src/device/webgl/gpu_timer.ts"],"sourcesContent":["import {isWebGL2} from './utils';\r\nimport {WebGLEnum} from './webgl_enum';\r\nimport type {ITimer} from '../timer';\r\nimport type {WebGLDevice} from './device_webgl';\r\n\r\nconst GPU_DISJOINT_EXT = 0x8fbb;\r\nconst TIME_ELAPSED_EXT = 0x88bf;\r\n\r\nconst enum QueryState {\r\n  QUERY_STATE_NONE = 0,\r\n  QUERY_STATE_QUERYING = 1,\r\n  QUERY_STATE_FINISHED = 2,\r\n}\r\n\r\ninterface ITimerQuery {\r\n  createQuery: () => unknown;\r\n  deleteQuery: (query: unknown) => void;\r\n  isQuery: (query: unknown) => boolean;\r\n  beginQuery: (target: number, query: unknown) => void;\r\n  endQuery: (target: number) => void;\r\n  getQuery: (target: number, pname: number) => unknown;\r\n  getQueryObject: (query: unknown, pname: number) => unknown;\r\n  queryCounter: (query: unknown, target: number) => void;\r\n}\r\n\r\nexport class GPUTimer implements ITimer {\r\n  private _device: WebGLDevice;\r\n  private _query: unknown;\r\n  private _state: QueryState;\r\n  private _timerQuery: ITimerQuery;\r\n  private _gpuTime: number;\r\n  constructor(device: WebGLDevice) {\r\n    this._device = device;\r\n    this._state = QueryState.QUERY_STATE_NONE;\r\n    this._gpuTime = null;\r\n    const gl = this._device.context;\r\n    if (isWebGL2(gl)) {\r\n      const ext = gl.getExtension('EXT_disjoint_timer_query_webgl2');\r\n      if (ext) {\r\n        this._timerQuery = {\r\n          createQuery: gl.createQuery.bind(gl),\r\n          deleteQuery: gl.deleteQuery.bind(gl),\r\n          beginQuery: gl.beginQuery.bind(gl),\r\n          endQuery: gl.endQuery.bind(gl),\r\n          isQuery: gl.isQuery.bind(gl),\r\n          getQuery: gl.getQuery.bind(gl),\r\n          getQueryObject: gl.getQueryParameter.bind(gl),\r\n          queryCounter: ext.queryCounterEXT.bind(ext),\r\n        };\r\n      }\r\n    } else {\r\n      const ext = gl.getExtension('EXT_disjoint_timer_query');\r\n      if (ext) {\r\n        this._timerQuery = {\r\n          createQuery: ext.createQueryEXT.bind(ext),\r\n          deleteQuery: ext.deleteQueryEXT.bind(ext),\r\n          beginQuery: ext.beginQueryEXT.bind(ext),\r\n          endQuery: ext.endQueryEXT.bind(ext),\r\n          isQuery: ext.isQueryEXT.bind(ext),\r\n          getQuery: ext.getQueryEXT.bind(ext),\r\n          getQueryObject: ext.getQueryObjectEXT.bind(ext),\r\n          queryCounter: ext.queryCounterEXT.bind(ext),\r\n        };\r\n      }\r\n    }\r\n    this._query = this._timerQuery ? this._timerQuery.createQuery() : null;\r\n  }\r\n  get gpuTimerSupported() {\r\n    return !!this._query;\r\n  }\r\n  begin() {\r\n    if (this._state === QueryState.QUERY_STATE_QUERYING) {\r\n      this.end();\r\n    }\r\n    if (this._query) {\r\n      this._timerQuery.beginQuery(TIME_ELAPSED_EXT, this._query);\r\n    }\r\n    this._gpuTime = null;\r\n    this._state = QueryState.QUERY_STATE_QUERYING;\r\n  }\r\n  end() {\r\n    if (this._state === QueryState.QUERY_STATE_QUERYING) {\r\n      if (this._query) {\r\n        this._timerQuery.endQuery(TIME_ELAPSED_EXT);\r\n      }\r\n      this._state = QueryState.QUERY_STATE_FINISHED;\r\n    }\r\n  }\r\n  ended(): boolean {\r\n    return this._state !== QueryState.QUERY_STATE_QUERYING;\r\n  }\r\n  elapsed(): number {\r\n    if (this._state === QueryState.QUERY_STATE_FINISHED) {\r\n      if (\r\n        this._gpuTime === null &&\r\n        this._query &&\r\n        this._timerQuery.getQueryObject(this._query, WebGLEnum.QUERY_RESULT_AVAILABLE)\r\n      ) {\r\n        const gpuTimerDisjoint = this._device.context.getParameter(GPU_DISJOINT_EXT);\r\n        if (!gpuTimerDisjoint) {\r\n          this._gpuTime =\r\n            Number(this._timerQuery.getQueryObject(this._query, WebGLEnum.QUERY_RESULT)) / 1000000;\r\n        }\r\n      }\r\n    }\r\n    return this._gpuTime;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAKA,MAAM,gBAAgB,GAAG,MAAM,CAAC;AAChC,MAAM,gBAAgB,GAAG,MAAM,CAAC;MAmBnB,QAAQ,CAAA;AACX,IAAA,OAAO,CAAc;AACrB,IAAA,MAAM,CAAU;AAChB,IAAA,MAAM,CAAa;AACnB,IAAA,WAAW,CAAc;AACzB,IAAA,QAAQ,CAAS;AACzB,IAAA,WAAA,CAAY,MAAmB,EAAA;AAC7B,QAAA,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC;QACtB,IAAI,CAAC,MAAM,GAAA,CAA8B,CAAC;AAC1C,QAAA,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;AACrB,QAAA,MAAM,EAAE,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC;AAChC,QAAA,IAAI,QAAQ,CAAC,EAAE,CAAC,EAAE;YAChB,MAAM,GAAG,GAAG,EAAE,CAAC,YAAY,CAAC,iCAAiC,CAAC,CAAC;AAC/D,YAAA,IAAI,GAAG,EAAE;gBACP,IAAI,CAAC,WAAW,GAAG;oBACjB,WAAW,EAAE,EAAE,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,CAAC;oBACpC,WAAW,EAAE,EAAE,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,CAAC;oBACpC,UAAU,EAAE,EAAE,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC;oBAClC,QAAQ,EAAE,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE,CAAC;oBAC9B,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC;oBAC5B,QAAQ,EAAE,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE,CAAC;oBAC9B,cAAc,EAAE,EAAE,CAAC,iBAAiB,CAAC,IAAI,CAAC,EAAE,CAAC;oBAC7C,YAAY,EAAE,GAAG,CAAC,eAAe,CAAC,IAAI,CAAC,GAAG,CAAC;iBAC5C,CAAC;AACH,aAAA;AACF,SAAA;AAAM,aAAA;YACL,MAAM,GAAG,GAAG,EAAE,CAAC,YAAY,CAAC,0BAA0B,CAAC,CAAC;AACxD,YAAA,IAAI,GAAG,EAAE;gBACP,IAAI,CAAC,WAAW,GAAG;oBACjB,WAAW,EAAE,GAAG,CAAC,cAAc,CAAC,IAAI,CAAC,GAAG,CAAC;oBACzC,WAAW,EAAE,GAAG,CAAC,cAAc,CAAC,IAAI,CAAC,GAAG,CAAC;oBACzC,UAAU,EAAE,GAAG,CAAC,aAAa,CAAC,IAAI,CAAC,GAAG,CAAC;oBACvC,QAAQ,EAAE,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC;oBACnC,OAAO,EAAE,GAAG,CAAC,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC;oBACjC,QAAQ,EAAE,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC;oBACnC,cAAc,EAAE,GAAG,CAAC,iBAAiB,CAAC,IAAI,CAAC,GAAG,CAAC;oBAC/C,YAAY,EAAE,GAAG,CAAC,eAAe,CAAC,IAAI,CAAC,GAAG,CAAC;iBAC5C,CAAC;AACH,aAAA;AACF,SAAA;AACD,QAAA,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC,WAAW,EAAE,GAAG,IAAI,CAAC;KACxE;AACD,IAAA,IAAI,iBAAiB,GAAA;AACnB,QAAA,OAAO,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC;KACtB;IACD,KAAK,GAAA;AACH,QAAA,IAAI,IAAI,CAAC,MAAM,KAAA,CAAoC,EAAE;YACnD,IAAI,CAAC,GAAG,EAAE,CAAC;AACZ,SAAA;QACD,IAAI,IAAI,CAAC,MAAM,EAAE;YACf,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,gBAAgB,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;AAC5D,SAAA;AACD,QAAA,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACrB,IAAI,CAAC,MAAM,GAAA,CAAkC,CAAC;KAC/C;IACD,GAAG,GAAA;AACD,QAAA,IAAI,IAAI,CAAC,MAAM,KAAA,CAAoC,EAAE;YACnD,IAAI,IAAI,CAAC,MAAM,EAAE;AACf,gBAAA,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,gBAAgB,CAAC,CAAC;AAC7C,aAAA;YACD,IAAI,CAAC,MAAM,GAAA,CAAkC,CAAC;AAC/C,SAAA;KACF;IACD,KAAK,GAAA;AACH,QAAA,OAAO,IAAI,CAAC,MAAM,KAAA,CAAoC,CAAC;KACxD;IACD,OAAO,GAAA;AACL,QAAA,IAAI,IAAI,CAAC,MAAM,KAAA,CAAoC,EAAE;AACnD,YAAA,IACE,IAAI,CAAC,QAAQ,KAAK,IAAI;AACtB,gBAAA,IAAI,CAAC,MAAM;AACX,gBAAA,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,EAAE,SAAS,CAAC,sBAAsB,CAAC,EAC9E;AACA,gBAAA,MAAM,gBAAgB,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,gBAAgB,CAAC,CAAC;gBAC7E,IAAI,CAAC,gBAAgB,EAAE;AACrB,oBAAA,IAAI,CAAC,QAAQ;AACX,wBAAA,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,EAAE,SAAS,CAAC,YAAY,CAAC,CAAC,GAAG,OAAO,CAAC;AAC1F,iBAAA;AACF,aAAA;AACF,SAAA;QACD,OAAO,IAAI,CAAC,QAAQ,CAAC;KACtB;AACF;;;;"}
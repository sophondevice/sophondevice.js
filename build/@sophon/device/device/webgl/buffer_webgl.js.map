{"version":3,"file":"buffer_webgl.js","sources":["../../../../../libs/device/src/device/webgl/buffer_webgl.ts"],"sourcesContent":["import { WebGLGPUObject } from './gpuobject_webgl';\nimport { WebGLEnum } from './webgl_enum';\nimport { GPUResourceUsageFlags, GPUDataBuffer } from '../gpuobject';\nimport { isWebGL2 } from './utils';\nimport type { TypedArray } from '../../misc';\nimport type { WebGLDevice } from './device_webgl';\n\nexport class WebGLGPUBuffer extends WebGLGPUObject<WebGLBuffer> implements GPUDataBuffer<WebGLBuffer> {\n  protected _size: number;\n  protected _usage: number;\n  protected _systemMemoryBuffer: Uint8Array;\n  protected _systemMemory: boolean;\n  protected _memCost: number;\n  constructor(device: WebGLDevice, usage: number, data: TypedArray | number, systemMemory = false) {\n    super(device);\n    if ((usage & GPUResourceUsageFlags.BF_VERTEX) && (usage & GPUResourceUsageFlags.BF_INDEX)) {\n      throw new Error('buffer usage must not have Vertex and Index simultaneously');\n    }\n    if (!device.isWebGL2 && !(usage & GPUResourceUsageFlags.BF_VERTEX) && !(usage & GPUResourceUsageFlags.BF_INDEX) && !(usage & GPUResourceUsageFlags.BF_UNIFORM)) {\n      throw new Error('no Vertex or Index or Uniform usage set when creating buffer');\n    }\n    if (device.isWebGL2 && !(usage & ~GPUResourceUsageFlags.DYNAMIC)) {\n      throw new Error('buffer usage not set when creating buffer');\n    }\n    if ((usage & GPUResourceUsageFlags.DYNAMIC) && (usage & GPUResourceUsageFlags.MANAGED)) {\n      throw new Error('buffer usage DYNAMIC and MANAGED can not be both set');\n    }\n    this._object = null;\n    this._memCost = 0;\n    this._usage = usage;\n    this._size = typeof data === 'number' ? data : data.byteLength;\n    if (this._size <= 0) {\n      throw new Error('can not create buffer with zero size');\n    }\n    this._systemMemory = !!systemMemory;\n    if (this._systemMemory || (this._usage & GPUResourceUsageFlags.MANAGED)) {\n      this._systemMemoryBuffer = new Uint8Array(this._size);\n      if (data && typeof data !== 'number') {\n        this._systemMemoryBuffer.set(new Uint8Array(data.buffer, data.byteOffset, data.byteLength));\n      }\n    } else {\n      this._systemMemoryBuffer = null;\n    }\n    if (!this._systemMemory) {\n      this.load(this._systemMemoryBuffer || (typeof data === 'number' ? null : data));\n    }\n  }\n  get byteLength() {\n    return this._size;\n  }\n  get systemMemoryBuffer(): ArrayBuffer {\n    return this._systemMemoryBuffer?.buffer || null;\n  }\n  get usage(): number {\n    return this._usage;\n  }\n  bufferSubData(dstByteOffset: number, data: TypedArray, srcPos?: number, srcLength?: number): void {\n    srcPos = Number(srcPos) || 0;\n    dstByteOffset = Number(dstByteOffset) || 0;\n    srcLength = Number(srcLength) || data.length - srcPos;\n    if (srcPos + srcLength > data.length) {\n      throw new Error('bufferSubData() failed: source buffer is too small');\n    }\n    if (dstByteOffset + srcLength * data.BYTES_PER_ELEMENT > this.byteLength) {\n      throw new Error('bufferSubData() failed: dest buffer is too small');\n    }\n    if (this._systemMemory || (this._usage & GPUResourceUsageFlags.MANAGED)) {\n      // copy to system backup buffer if present\n      this._systemMemoryBuffer.set(new Uint8Array(data.buffer, data.byteOffset + srcPos * data.BYTES_PER_ELEMENT, srcLength * data.BYTES_PER_ELEMENT), dstByteOffset);\n    }\n    if (!this._systemMemory && !this.device.isContextLost()) {\n      if (this.disposed) {\n        this.reload();\n      }\n      if (!this._device.isWebGL2 && (srcPos !== 0 || srcLength !== data.length)) {\n        data = data.subarray(srcPos, srcPos + srcLength);\n      }\n      this._device.vaoExt?.bindVertexArray(null);\n      let target: number;\n      if (this._usage & GPUResourceUsageFlags.BF_INDEX) {\n        target = WebGLEnum.ELEMENT_ARRAY_BUFFER;\n      } else if (this._usage & GPUResourceUsageFlags.BF_VERTEX) {\n        target = WebGLEnum.ARRAY_BUFFER\n      } else if (this._usage & GPUResourceUsageFlags.BF_UNIFORM) {\n        target = WebGLEnum.UNIFORM_BUFFER;\n      } else if (this._usage & (GPUResourceUsageFlags.BF_READ | GPUResourceUsageFlags.BF_WRITE)) {\n        target = WebGLEnum.COPY_WRITE_BUFFER;\n      } else {\n        throw new Error(`Invalid buffer usage`);\n      }\n      this._device.context.bindBuffer(target, this._object);\n      if (this._device.isWebGL2) {\n        (this._device.context as WebGL2RenderingContext).bufferSubData(target, dstByteOffset, data, srcPos, srcLength);\n      } else {\n        this._device.context.bufferSubData(target, dstByteOffset, data);\n      }\n    }\n  }\n  async getBufferSubData(dstBuffer?: Uint8Array, offsetInBytes?: number, sizeInBytes?: number): Promise<Uint8Array> {\n    if (this.disposed) {\n      this.reload();\n    }\n    return this._getBufferData(dstBuffer, offsetInBytes, sizeInBytes);\n  }\n  protected async _getBufferData(dstBuffer?: Uint8Array, offsetInBytes?: number, sizeInBytes?: number): Promise<Uint8Array> {\n    offsetInBytes = Number(offsetInBytes) || 0;\n    sizeInBytes = Number(sizeInBytes) || this.byteLength - offsetInBytes;\n    if (offsetInBytes < 0 || offsetInBytes + sizeInBytes > this.byteLength) {\n      throw new Error('data query range out of bounds');\n    }\n    if (dstBuffer && dstBuffer.byteLength < sizeInBytes) {\n      throw new Error('no enough space for querying buffer data');\n    }\n    dstBuffer = dstBuffer || new Uint8Array(sizeInBytes);\n    if (this._systemMemoryBuffer) {\n      dstBuffer.set(new Uint8Array(this._systemMemoryBuffer, offsetInBytes, sizeInBytes));\n    } else {\n      const gl = this._device.context as WebGL2RenderingContext;\n      if (isWebGL2(gl)) {\n        const sync = gl.fenceSync(WebGLEnum.SYNC_GPU_COMMANDS_COMPLETE, 0);\n        gl.flush();\n        await this.clientWaitAsync(gl, sync, 0, 10);\n        gl.deleteSync(sync);\n      }\n      this._device.vaoExt?.bindVertexArray(null);\n      let target: number;\n      if (this._usage & GPUResourceUsageFlags.BF_INDEX) {\n        target = WebGLEnum.ELEMENT_ARRAY_BUFFER;\n      } else if (this._usage & GPUResourceUsageFlags.BF_VERTEX) {\n        target = WebGLEnum.ARRAY_BUFFER\n      } else if (this._usage & GPUResourceUsageFlags.BF_UNIFORM) {\n        target = WebGLEnum.UNIFORM_BUFFER;\n      } else if (this._usage & (GPUResourceUsageFlags.BF_READ | GPUResourceUsageFlags.BF_WRITE)) {\n        target = WebGLEnum.COPY_READ_BUFFER;\n      } else {\n        throw new Error(`Invalid buffer usage`);\n      }\n      gl.bindBuffer(target, this._object);\n      gl.getBufferSubData(target, offsetInBytes, dstBuffer, 0, sizeInBytes);\n      gl.bindBuffer(target, null);\n    }\n    return dstBuffer;\n  }\n  async restore() {\n    if (!this._systemMemory && !this._object && !this._device.isContextLost()) {\n      this.load(this._systemMemoryBuffer);\n    }\n  }\n  destroy() {\n    if (!this._systemMemory && this._object) {\n      this._device.context.deleteBuffer(this._object);\n      this._object = null;\n      this._device.updateVideoMemoryCost(-this._memCost);\n      this._memCost = 0;\n    }\n  }\n  isBuffer(): boolean {\n    return true;\n  }\n  protected load(data?: TypedArray): void {\n    if (!this._device.isContextLost()) {\n      if (!this._object) {\n        this._object = this._device.context.createBuffer();\n      }\n      this._device.vaoExt?.bindVertexArray(null);\n      let usage = (this._usage & GPUResourceUsageFlags.DYNAMIC) ? WebGLEnum.DYNAMIC_DRAW : WebGLEnum.STATIC_DRAW;\n      let target: number;\n      if (this._usage & GPUResourceUsageFlags.BF_INDEX) {\n        target = WebGLEnum.ELEMENT_ARRAY_BUFFER;\n      } else if (this._usage & GPUResourceUsageFlags.BF_VERTEX) {\n        target = WebGLEnum.ARRAY_BUFFER;\n      } else if (this._usage & GPUResourceUsageFlags.BF_UNIFORM) {\n        target = WebGLEnum.UNIFORM_BUFFER;\n      } else if (this._usage & GPUResourceUsageFlags.BF_READ) {\n        target = WebGLEnum.COPY_READ_BUFFER;\n        usage = WebGLEnum.STREAM_READ;\n      } else if (this._usage & GPUResourceUsageFlags.BF_WRITE) {\n        target = WebGLEnum.COPY_WRITE_BUFFER;\n      } else {\n        throw new Error(`WebGLGPUBuffer.load() failed: invalid buffer usage: ${this._usage}`);\n      }\n      this._device.context.bindBuffer(target, this._object);\n      if (data) {\n        this._device.context.bufferData(target, data, usage);\n      } else {\n        this._device.context.bufferData(target, (this._size + 15) & ~15, usage);\n      }\n    }\n    this._device.updateVideoMemoryCost(this._size - this._memCost);\n    this._memCost = this._size;\n  }\n  /** @internal */\n  private async clientWaitAsync(gl: WebGL2RenderingContext, sync: WebGLSync, flags: number, interval_ms: number) {\n    return new Promise<void>((resolve, reject) => {\n      function test() {\n        const res = gl.clientWaitSync(sync, flags, 0);\n        if (res == gl.WAIT_FAILED) {\n          reject();\n          return;\n        }\n        if (res == gl.TIMEOUT_EXPIRED) {\n          setTimeout(test, interval_ms);\n          return;\n        }\n        resolve();\n      }\n      test();\n    });\n  }\n}\n"],"names":[],"mappings":"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"}
{"version":3,"file":"buffer_webgl.js","sources":["../../../../../libs/device/src/device/webgl/buffer_webgl.ts"],"sourcesContent":["import { WebGLGPUObject } from './gpuobject_webgl';\r\nimport { WebGLEnum } from './webgl_enum';\r\nimport { GPUResourceUsageFlags, GPUDataBuffer } from '../gpuobject';\r\nimport { isWebGL2 } from './utils';\r\nimport type { TypedArray } from '../../misc';\r\nimport type { WebGLDevice } from './device_webgl';\r\n\r\nexport class WebGLGPUBuffer extends WebGLGPUObject<WebGLBuffer> implements GPUDataBuffer<WebGLBuffer> {\r\n  protected _size: number;\r\n  protected _usage: number;\r\n  protected _systemMemoryBuffer: Uint8Array;\r\n  protected _systemMemory: boolean;\r\n  protected _memCost: number;\r\n  constructor(device: WebGLDevice, usage: number, data: TypedArray | number, systemMemory = false) {\r\n    super(device);\r\n    if ((usage & GPUResourceUsageFlags.BF_VERTEX) && (usage & GPUResourceUsageFlags.BF_INDEX)) {\r\n      throw new Error('buffer usage must not have Vertex and Index simultaneously');\r\n    }\r\n    if (!device.isWebGL2 && !(usage & GPUResourceUsageFlags.BF_VERTEX) && !(usage & GPUResourceUsageFlags.BF_INDEX) && !(usage & GPUResourceUsageFlags.BF_UNIFORM)) {\r\n      throw new Error('no Vertex or Index or Uniform usage set when creating buffer');\r\n    }\r\n    if (device.isWebGL2 && !(usage & ~GPUResourceUsageFlags.DYNAMIC)) {\r\n      throw new Error('buffer usage not set when creating buffer');\r\n    }\r\n    if ((usage & GPUResourceUsageFlags.DYNAMIC) && (usage & GPUResourceUsageFlags.MANAGED)) {\r\n      throw new Error('buffer usage DYNAMIC and MANAGED can not be both set');\r\n    }\r\n    this._object = null;\r\n    this._memCost = 0;\r\n    this._usage = usage;\r\n    this._size = typeof data === 'number' ? data : data.byteLength;\r\n    if (this._size <= 0) {\r\n      throw new Error('can not create buffer with zero size');\r\n    }\r\n    this._systemMemory = !!systemMemory;\r\n    if (this._systemMemory || (this._usage & GPUResourceUsageFlags.MANAGED)) {\r\n      this._systemMemoryBuffer = new Uint8Array(this._size);\r\n      if (data && typeof data !== 'number') {\r\n        this._systemMemoryBuffer.set(new Uint8Array(data.buffer, data.byteOffset, data.byteLength));\r\n      }\r\n    } else {\r\n      this._systemMemoryBuffer = null;\r\n    }\r\n    if (!this._systemMemory) {\r\n      this.load(this._systemMemoryBuffer || (typeof data === 'number' ? null : data));\r\n    }\r\n  }\r\n  get byteLength() {\r\n    return this._size;\r\n  }\r\n  get systemMemoryBuffer(): ArrayBuffer {\r\n    return this._systemMemoryBuffer?.buffer || null;\r\n  }\r\n  get usage(): number {\r\n    return this._usage;\r\n  }\r\n  bufferSubData(dstByteOffset: number, data: TypedArray, srcPos?: number, srcLength?: number): void {\r\n    srcPos = Number(srcPos) || 0;\r\n    dstByteOffset = Number(dstByteOffset) || 0;\r\n    srcLength = Number(srcLength) || data.length - srcPos;\r\n    if (srcPos + srcLength > data.length) {\r\n      throw new Error('bufferSubData() failed: source buffer is too small');\r\n    }\r\n    if (dstByteOffset + srcLength * data.BYTES_PER_ELEMENT > this.byteLength) {\r\n      throw new Error('bufferSubData() failed: dest buffer is too small');\r\n    }\r\n    if (this._systemMemory || (this._usage & GPUResourceUsageFlags.MANAGED)) {\r\n      // copy to system backup buffer if present\r\n      this._systemMemoryBuffer.set(new Uint8Array(data.buffer, data.byteOffset + srcPos * data.BYTES_PER_ELEMENT, srcLength * data.BYTES_PER_ELEMENT), dstByteOffset);\r\n    }\r\n    if (!this._systemMemory && !this.device.isContextLost()) {\r\n      if (this.disposed) {\r\n        this.reload();\r\n      }\r\n      if (!this._device.isWebGL2 && (srcPos !== 0 || srcLength !== data.length)) {\r\n        data = data.subarray(srcPos, srcPos + srcLength);\r\n      }\r\n      this._device.vaoExt?.bindVertexArray(null);\r\n      let target: number;\r\n      if (this._usage & GPUResourceUsageFlags.BF_INDEX) {\r\n        target = WebGLEnum.ELEMENT_ARRAY_BUFFER;\r\n      } else if (this._usage & GPUResourceUsageFlags.BF_VERTEX) {\r\n        target = WebGLEnum.ARRAY_BUFFER\r\n      } else if (this._usage & GPUResourceUsageFlags.BF_UNIFORM) {\r\n        target = WebGLEnum.UNIFORM_BUFFER;\r\n      } else if (this._usage & (GPUResourceUsageFlags.BF_READ | GPUResourceUsageFlags.BF_WRITE)) {\r\n        target = WebGLEnum.COPY_WRITE_BUFFER;\r\n      } else {\r\n        throw new Error(`Invalid buffer usage`);\r\n      }\r\n      this._device.context.bindBuffer(target, this._object);\r\n      if (this._device.isWebGL2) {\r\n        (this._device.context as WebGL2RenderingContext).bufferSubData(target, dstByteOffset, data, srcPos, srcLength);\r\n      } else {\r\n        this._device.context.bufferSubData(target, dstByteOffset, data);\r\n      }\r\n    }\r\n  }\r\n  async getBufferSubData(dstBuffer?: Uint8Array, offsetInBytes?: number, sizeInBytes?: number): Promise<Uint8Array> {\r\n    if (this.disposed) {\r\n      this.reload();\r\n    }\r\n    return this._getBufferData(dstBuffer, offsetInBytes, sizeInBytes);\r\n  }\r\n  protected async _getBufferData(dstBuffer?: Uint8Array, offsetInBytes?: number, sizeInBytes?: number): Promise<Uint8Array> {\r\n    offsetInBytes = Number(offsetInBytes) || 0;\r\n    sizeInBytes = Number(sizeInBytes) || this.byteLength - offsetInBytes;\r\n    if (offsetInBytes < 0 || offsetInBytes + sizeInBytes > this.byteLength) {\r\n      throw new Error('data query range out of bounds');\r\n    }\r\n    if (dstBuffer && dstBuffer.byteLength < sizeInBytes) {\r\n      throw new Error('no enough space for querying buffer data');\r\n    }\r\n    dstBuffer = dstBuffer || new Uint8Array(sizeInBytes);\r\n    if (this._systemMemoryBuffer) {\r\n      dstBuffer.set(new Uint8Array(this._systemMemoryBuffer, offsetInBytes, sizeInBytes));\r\n    } else {\r\n      const gl = this._device.context as WebGL2RenderingContext;\r\n      if (isWebGL2(gl)) {\r\n        const sync = gl.fenceSync(WebGLEnum.SYNC_GPU_COMMANDS_COMPLETE, 0);\r\n        gl.flush();\r\n        await this.clientWaitAsync(gl, sync, 0, 10);\r\n        gl.deleteSync(sync);\r\n      }\r\n      this._device.vaoExt?.bindVertexArray(null);\r\n      let target: number;\r\n      if (this._usage & GPUResourceUsageFlags.BF_INDEX) {\r\n        target = WebGLEnum.ELEMENT_ARRAY_BUFFER;\r\n      } else if (this._usage & GPUResourceUsageFlags.BF_VERTEX) {\r\n        target = WebGLEnum.ARRAY_BUFFER\r\n      } else if (this._usage & GPUResourceUsageFlags.BF_UNIFORM) {\r\n        target = WebGLEnum.UNIFORM_BUFFER;\r\n      } else if (this._usage & (GPUResourceUsageFlags.BF_READ | GPUResourceUsageFlags.BF_WRITE)) {\r\n        target = WebGLEnum.COPY_READ_BUFFER;\r\n      } else {\r\n        throw new Error(`Invalid buffer usage`);\r\n      }\r\n      gl.bindBuffer(target, this._object);\r\n      gl.getBufferSubData(target, offsetInBytes, dstBuffer, 0, sizeInBytes);\r\n      gl.bindBuffer(target, null);\r\n    }\r\n    return dstBuffer;\r\n  }\r\n  async restore() {\r\n    if (!this._systemMemory && !this._object && !this._device.isContextLost()) {\r\n      this.load(this._systemMemoryBuffer);\r\n    }\r\n  }\r\n  destroy() {\r\n    if (!this._systemMemory && this._object) {\r\n      this._device.context.deleteBuffer(this._object);\r\n      this._object = null;\r\n      this._device.updateVideoMemoryCost(-this._memCost);\r\n      this._memCost = 0;\r\n    }\r\n  }\r\n  isBuffer(): boolean {\r\n    return true;\r\n  }\r\n  protected load(data?: TypedArray): void {\r\n    if (!this._device.isContextLost()) {\r\n      if (!this._object) {\r\n        this._object = this._device.context.createBuffer();\r\n      }\r\n      this._device.vaoExt?.bindVertexArray(null);\r\n      let usage = (this._usage & GPUResourceUsageFlags.DYNAMIC) ? WebGLEnum.DYNAMIC_DRAW : WebGLEnum.STATIC_DRAW;\r\n      let target: number;\r\n      if (this._usage & GPUResourceUsageFlags.BF_INDEX) {\r\n        target = WebGLEnum.ELEMENT_ARRAY_BUFFER;\r\n      } else if (this._usage & GPUResourceUsageFlags.BF_VERTEX) {\r\n        target = WebGLEnum.ARRAY_BUFFER;\r\n      } else if (this._usage & GPUResourceUsageFlags.BF_UNIFORM) {\r\n        target = WebGLEnum.UNIFORM_BUFFER;\r\n      } else if (this._usage & GPUResourceUsageFlags.BF_READ) {\r\n        target = WebGLEnum.COPY_READ_BUFFER;\r\n        usage = WebGLEnum.STREAM_READ;\r\n      } else if (this._usage & GPUResourceUsageFlags.BF_WRITE) {\r\n        target = WebGLEnum.COPY_WRITE_BUFFER;\r\n      } else {\r\n        throw new Error(`WebGLGPUBuffer.load() failed: invalid buffer usage: ${this._usage}`);\r\n      }\r\n      this._device.context.bindBuffer(target, this._object);\r\n      if (data) {\r\n        this._device.context.bufferData(target, data, usage);\r\n      } else {\r\n        this._device.context.bufferData(target, (this._size + 15) & ~15, usage);\r\n      }\r\n    }\r\n    this._device.updateVideoMemoryCost(this._size - this._memCost);\r\n    this._memCost = this._size;\r\n  }\r\n  /** @internal */\r\n  private async clientWaitAsync(gl: WebGL2RenderingContext, sync: WebGLSync, flags: number, interval_ms: number) {\r\n    return new Promise<void>((resolve, reject) => {\r\n      function test() {\r\n        const res = gl.clientWaitSync(sync, flags, 0);\r\n        if (res == gl.WAIT_FAILED) {\r\n          reject();\r\n          return;\r\n        }\r\n        if (res == gl.TIMEOUT_EXPIRED) {\r\n          setTimeout(test, interval_ms);\r\n          return;\r\n        }\r\n        resolve();\r\n      }\r\n      test();\r\n    });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
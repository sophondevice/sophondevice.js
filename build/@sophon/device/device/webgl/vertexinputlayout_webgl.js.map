{"version":3,"file":"vertexinputlayout_webgl.js","sources":["../../../../../libs/device/src/device/webgl/vertexinputlayout_webgl.ts"],"sourcesContent":["import { PrimitiveType } from '../base_types';\r\nimport { WebGLGPUObject } from './gpuobject_webgl';\r\nimport { WebGLEnum } from './webgl_enum';\r\nimport { VertexInputLayout, StructuredBuffer, IndexBuffer, getVertexBufferAttribType, getVertexBufferStride, VertexSemantic } from '../gpuobject';\r\nimport { VertexData } from '../vertexdata';\r\nimport { typeMap } from './constants_webgl';\r\nimport type { WebGLDevice } from './device_webgl';\r\n\r\nexport class WebGLVertexInputLayout\r\n  extends WebGLGPUObject<WebGLVertexArrayObject | WebGLVertexArrayObjectOES>\r\n  implements VertexInputLayout<WebGLVertexArrayObject | WebGLVertexArrayObjectOES>\r\n{\r\n  private _vertexData: VertexData;\r\n  constructor(device: WebGLDevice, vertexData: VertexData) {\r\n    super(device);\r\n    this._vertexData = vertexData.clone();\r\n    this.load();\r\n  }\r\n  destroy() {\r\n    if (this._object && this._device.vaoExt) {\r\n      this._device.vaoExt.deleteVertexArray(this._object);\r\n    }\r\n    this._object = null;\r\n  }\r\n  async restore() {\r\n    if (!this._device.isContextLost()) {\r\n      this.load();\r\n    }\r\n  }\r\n  get vertexBuffers() {\r\n    return this._vertexData.vertexBuffers;\r\n  }\r\n  get indexBuffer() {\r\n    return this._vertexData.indexBuffer;\r\n  }\r\n  getDrawOffset(): number {\r\n    return this._vertexData.getDrawOffset();\r\n  }\r\n  getVertexBuffer(semantic: VertexSemantic): StructuredBuffer {\r\n    return this._vertexData.getVertexBuffer(semantic);\r\n  }\r\n  getIndexBuffer(): IndexBuffer {\r\n    return this._vertexData.getIndexBuffer();\r\n  }\r\n  bind() {\r\n    if (this._object && this._device.vaoExt) {\r\n      this._device.vaoExt.bindVertexArray(this._object);\r\n    } else {\r\n      this.bindBuffers();\r\n    }\r\n  }\r\n  draw(primitiveType: PrimitiveType, first: number, count: number): void {\r\n    this._device.setVertexData(this);\r\n    this._device.draw(primitiveType, first, count);\r\n  }\r\n  drawInstanced(\r\n    primitiveType: PrimitiveType,\r\n    first: number,\r\n    count: number,\r\n    numInstances: number,\r\n  ): void {\r\n    this._device.setVertexData(this);\r\n    this._device.drawInstanced(primitiveType, first, count, numInstances);\r\n  }\r\n  isVAO(): boolean {\r\n    return true;\r\n  }\r\n  private load(): void {\r\n    if (this._device.isContextLost()) {\r\n      return;\r\n    }\r\n    if (this._device.vaoExt) {\r\n      if (!this._object) {\r\n        this._object = this._device.vaoExt.createVertexArray();\r\n        this._device.vaoExt.bindVertexArray(this._object);\r\n        this.bindBuffers();\r\n        this._device.vaoExt.bindVertexArray(null);\r\n      }\r\n    } else {\r\n      this._object = {};\r\n    }\r\n  }\r\n  private bindBuffers() {\r\n    const vertexBuffers = this._vertexData.vertexBuffers;\r\n    const drawOffset = this._vertexData.getDrawOffset();\r\n    const gl = this._device.context;\r\n    for (let loc = 0; loc < vertexBuffers.length; loc++) {\r\n      const bufferInfo = vertexBuffers[loc];\r\n      const buffer = bufferInfo?.buffer;\r\n      if (buffer) {\r\n        if (buffer.disposed) {\r\n          buffer.reload();\r\n        }\r\n        gl.bindBuffer(WebGLEnum.ARRAY_BUFFER, buffer.object);\r\n        gl.enableVertexAttribArray(loc);\r\n        const vertexType = getVertexBufferAttribType(bufferInfo.buffer.structure, loc);\r\n        const stride = getVertexBufferStride(bufferInfo.buffer.structure);\r\n        if (bufferInfo.stepMode === 'instance' && this._device.instancedArraysExt) {\r\n          gl.vertexAttribPointer(\r\n            loc,\r\n            vertexType.cols,\r\n            typeMap[vertexType.scalarType],\r\n            false,\r\n            stride,\r\n            bufferInfo.offset,\r\n          );\r\n          this._device.instancedArraysExt.vertexAttribDivisor(loc, 1);\r\n        } else {\r\n          gl.vertexAttribPointer(\r\n            loc,\r\n            vertexType.cols,\r\n            typeMap[vertexType.scalarType],\r\n            false,\r\n            stride,\r\n            drawOffset * stride + bufferInfo.offset,\r\n          );\r\n        }\r\n      } else {\r\n        gl.disableVertexAttribArray(loc);\r\n      }\r\n    }\r\n    if (this._vertexData.indexBuffer?.disposed) {\r\n      this._vertexData.indexBuffer.reload();\r\n    }\r\n    gl.bindBuffer(\r\n      WebGLEnum.ELEMENT_ARRAY_BUFFER,\r\n      this._vertexData.indexBuffer ? this._vertexData.indexBuffer.object : null,\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
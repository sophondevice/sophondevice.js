{"version":3,"file":"uniformdata.js","sources":["../../../../libs/device/src/device/uniformdata.ts"],"sourcesContent":["import { PBPrimitiveType } from './builder/types';\r\nimport type { StructuredValue, UniformBufferLayout, StructuredBuffer } from './gpuobject';\r\nimport type { TypedArray, TypedArrayConstructor } from '../misc';\r\n\r\n\r\nexport class StructuredBufferData {\r\n  protected _cache: ArrayBuffer;\r\n  protected _buffer: StructuredBuffer;\r\n  protected _size: number;\r\n  protected _uniformMap: { [name: string]: TypedArray };\r\n  protected _uniformPositions: { [name: string]: [number, number] };\r\n  constructor(layout: UniformBufferLayout, buffer?: StructuredBuffer | ArrayBuffer) {\r\n    this._size = (layout.byteSize + 15) & ~15;\r\n    if (this._size <= 0) {\r\n      throw new Error(`UniformBuffer(): invalid uniform buffer byte size: ${this._size}`);\r\n    }\r\n    // this._cache = new ArrayBuffer(size);\r\n    this._uniformMap = {};\r\n    this._uniformPositions = {};\r\n    this._cache = buffer instanceof ArrayBuffer ? buffer : null;\r\n    this._buffer = buffer instanceof ArrayBuffer ? null : buffer;\r\n    this.init(layout, 0, '');\r\n  }\r\n  get byteLength(): number {\r\n    return this._size;\r\n  }\r\n  get buffer(): ArrayBuffer {\r\n    return this._cache;\r\n  }\r\n  get uniforms(): { [name: string]: TypedArray } {\r\n    return this._uniformMap;\r\n  }\r\n  set(name: string, value: StructuredValue) {\r\n    if (value !== undefined) {\r\n      const view = this._uniformMap[name];\r\n      if (view) {\r\n        if (this._cache) {\r\n          if (typeof value === 'number') {\r\n            view[0] = value;\r\n          } else if ((value as any)?._v) {\r\n            view.set((value as any)._v);\r\n          } else if (typeof (value as any)?.length === 'number') {\r\n            view.set(value as any);\r\n          } else {\r\n            throw new Error('invalid uniform value');\r\n          }\r\n        } else {\r\n          if (typeof value === 'number') {\r\n            view[0] = value;\r\n            this._buffer.bufferSubData(this._uniformPositions[name][0], view);\r\n          } else if ((value as any)?._v) {\r\n            this._buffer.bufferSubData(this._uniformPositions[name][0], (value as any)._v);\r\n          } else if (typeof (value as any)?.length === 'number') {\r\n            this._buffer.bufferSubData(this._uniformPositions[name][0], value as TypedArray);\r\n          } else {\r\n            throw new Error('invalid uniform value');\r\n          }\r\n        }\r\n      } else {\r\n        const proto = Object.getPrototypeOf(value);\r\n        if (proto === Object.getPrototypeOf({})) {\r\n          this.setStruct(name, value);\r\n        } else {\r\n          throw new Error('invalid uniform value');\r\n        }\r\n      }\r\n    }\r\n  }\r\n  /** @internal */\r\n  private setStruct(name: string, value: any) {\r\n    for (const k in value) {\r\n      this.set(`${name}.${k}`, value[k]);\r\n    }\r\n  }\r\n  /** @internal */\r\n  private init(layout: UniformBufferLayout, offset: number, prefix: string): number {\r\n    for (const entry of layout.entries) {\r\n      if (entry.subLayout) {\r\n        offset = this.init(entry.subLayout, offset, `${prefix}${entry.name}.`);\r\n      } else {\r\n        const name = `${prefix}${entry.name}`;\r\n        if (this._uniformPositions[name]) {\r\n          throw new Error(`UniformBuffer(): duplicate uniform name: ${name}`);\r\n        }\r\n        if (entry.offset < offset || entry.byteSize < 0) {\r\n          throw new Error('UniformBuffer(): invalid layout');\r\n        }\r\n        this._uniformPositions[name] = [entry.offset, entry.byteSize];\r\n        let viewCtor: TypedArrayConstructor = null;\r\n        switch (entry.type) {\r\n          case PBPrimitiveType.F32:\r\n            viewCtor = Float32Array;\r\n            break;\r\n          case PBPrimitiveType.U32:\r\n          case PBPrimitiveType.BOOL:\r\n            viewCtor = Uint32Array;\r\n            break;\r\n          case PBPrimitiveType.I32:\r\n            viewCtor = Int32Array;\r\n            break;\r\n          case PBPrimitiveType.U16:\r\n          case PBPrimitiveType.U16_NORM:\r\n          case PBPrimitiveType.F16:\r\n            viewCtor = Uint16Array;\r\n            break;\r\n          case PBPrimitiveType.I16:\r\n          case PBPrimitiveType.I16_NORM:\r\n            viewCtor = Int16Array;\r\n            break;\r\n          case PBPrimitiveType.U8:\r\n          case PBPrimitiveType.U8_NORM:\r\n            viewCtor = Uint8Array;\r\n            break;\r\n          case PBPrimitiveType.I8:\r\n          case PBPrimitiveType.I8_NORM:\r\n            viewCtor = Int8Array;\r\n            break;\r\n        }\r\n        if (!viewCtor) {\r\n          throw new Error(`UniformBuffer(): invalid data type for uniform: ${name}`);\r\n        }\r\n        if (entry.byteSize % viewCtor.BYTES_PER_ELEMENT) {\r\n          throw new Error(`UniformBuffer(): invalid byte size for uniform: ${name}`);\r\n        }\r\n        if (this._cache) {\r\n          this._uniformMap[name] = new viewCtor(this._cache, entry.offset, entry.byteSize / viewCtor.BYTES_PER_ELEMENT);\r\n        } else {\r\n          this._uniformMap[name] = new viewCtor(1);\r\n        }\r\n        offset = entry.offset + entry.byteSize;\r\n      }\r\n    }\r\n    return offset;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
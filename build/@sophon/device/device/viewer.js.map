{"version":3,"file":"viewer.js","sources":["../../../../libs/device/src/device/viewer.ts"],"sourcesContent":["import { Device, DeviceOptions, DeviceType, DeviceResizeEvent } from './device';\r\nimport { WebGLDevice } from './webgl/device_webgl';\r\nimport { WebGPUDevice } from './webgpu/device';\r\n\r\nexport class Viewer {\r\n  /** @internal */\r\n  private _device: Device;\r\n  /** @internal */\r\n  private _canvas: HTMLCanvasElement;\r\n  /** @internal */\r\n  private _canvasClientWidth: number;\r\n  /** @internal */\r\n  private _canvasClientHeight: number;\r\n  constructor(cvs: HTMLCanvasElement) {\r\n    this._canvas = cvs;\r\n    this._canvasClientWidth = 0;\r\n    this._canvasClientHeight = 0;\r\n    this._device = null;\r\n  }\r\n  get device(): Device {\r\n    return this._device;\r\n  }\r\n  get canvas() {\r\n    return this._canvas;\r\n  }\r\n  async initDevice(deviceType: DeviceType[] | DeviceType, options?: DeviceOptions) {\r\n    const typelist = Array.isArray(deviceType) ? deviceType : [deviceType];\r\n    for (const type of typelist) {\r\n      try {\r\n        if (type === 'webgl' || type === 'webgl2') {\r\n          this._device = new WebGLDevice(this._canvas, type, options);\r\n        } else if (navigator.gpu) {\r\n          this._device = new WebGPUDevice(this._canvas, options);\r\n        }\r\n        if (this._device) {\r\n          break;\r\n        }\r\n      } catch (err) {\r\n        console.log(`create context '${type}' failed: ${err}`);\r\n        this._device = null;\r\n      }\r\n    }\r\n    if (!this._device) {\r\n      throw new Error('ERR: create device failed');\r\n    }\r\n    await this._device.initContext();\r\n    this._device.setViewport();\r\n    this._device.setScissor();\r\n\r\n    // let the canvas element receive keyboard event\r\n    if (this._canvas instanceof HTMLCanvasElement) {\r\n      this._canvas.style.outline = 'none';\r\n      this._canvas.setAttribute('tabindex', '1');\r\n    }\r\n    this._onresize();\r\n    this._registerEventHandlers();\r\n  }\r\n  /** @internal */\r\n  private _onresize() {\r\n    const canvas = this._canvas;\r\n    if (\r\n      this._canvasClientWidth !== canvas.clientWidth ||\r\n      this._canvasClientHeight !== canvas.clientHeight\r\n    ) {\r\n      this._canvasClientWidth = canvas.clientWidth;\r\n      this._canvasClientHeight = canvas.clientHeight;\r\n      this._device.dispatchEvent(new DeviceResizeEvent(canvas.clientWidth, canvas.clientHeight));\r\n    }\r\n  }\r\n  /** @internal */\r\n  private _registerEventHandlers() {\r\n    const canvas: HTMLCanvasElement = this._canvas;\r\n    const that = this;\r\n    if (window.ResizeObserver) {\r\n      new window.ResizeObserver(entries => {\r\n        that._onresize();\r\n      }).observe(canvas, {})\r\n    } else {\r\n      new MutationObserver(function (mutations) {\r\n        if (mutations.length > 0) {\r\n          that._onresize();\r\n        }\r\n      }).observe(canvas, { attributes: true, attributeFilter: ['style'] });\r\n      window.addEventListener('resize', () => {\r\n        this._onresize();\r\n      });\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
{"version":3,"file":"viewer.js","sources":["../../../../libs/device/src/device/viewer.ts"],"sourcesContent":["import { Device, DeviceOptions, DeviceType, DeviceResizeEvent } from './device';\nimport { WebGLDevice } from './webgl/device_webgl';\nimport { WebGPUDevice } from './webgpu/device';\n\nexport class Viewer {\n  /** @internal */\n  private _device: Device;\n  /** @internal */\n  private _canvas: HTMLCanvasElement;\n  /** @internal */\n  private _canvasClientWidth: number;\n  /** @internal */\n  private _canvasClientHeight: number;\n  constructor(cvs: HTMLCanvasElement) {\n    this._canvas = cvs;\n    this._canvasClientWidth = 0;\n    this._canvasClientHeight = 0;\n    this._device = null;\n  }\n  get device(): Device {\n    return this._device;\n  }\n  get canvas() {\n    return this._canvas;\n  }\n  async initDevice(deviceType: DeviceType[] | DeviceType, options?: DeviceOptions) {\n    const typelist = Array.isArray(deviceType) ? deviceType : [deviceType];\n    for (const type of typelist) {\n      try {\n        if (type === 'webgl' || type === 'webgl2') {\n          this._device = new WebGLDevice(this._canvas, type, options);\n        } else if (navigator.gpu) {\n          this._device = new WebGPUDevice(this._canvas, options);\n        }\n        if (this._device) {\n          break;\n        }\n      } catch (err) {\n        console.log(`create context '${type}' failed: ${err}`);\n        this._device = null;\n      }\n    }\n    if (!this._device) {\n      throw new Error('ERR: create device failed');\n    }\n    await this._device.initContext();\n    this._device.setViewport();\n    this._device.setScissor();\n\n    // let the canvas element receive keyboard event\n    if (this._canvas instanceof HTMLCanvasElement) {\n      this._canvas.style.outline = 'none';\n      this._canvas.setAttribute('tabindex', '1');\n    }\n    this._onresize();\n    this._registerEventHandlers();\n  }\n  /** @internal */\n  private _onresize() {\n    const canvas = this._canvas;\n    if (\n      this._canvasClientWidth !== canvas.clientWidth ||\n      this._canvasClientHeight !== canvas.clientHeight\n    ) {\n      this._canvasClientWidth = canvas.clientWidth;\n      this._canvasClientHeight = canvas.clientHeight;\n      this._device.dispatchEvent(new DeviceResizeEvent(canvas.clientWidth, canvas.clientHeight));\n    }\n  }\n  /** @internal */\n  private _registerEventHandlers() {\n    const canvas: HTMLCanvasElement = this._canvas;\n    const that = this;\n    if (window.ResizeObserver) {\n      new window.ResizeObserver(entries => {\n        that._onresize();\n      }).observe(canvas, {})\n    } else {\n      new MutationObserver(function (mutations) {\n        if (mutations.length > 0) {\n          that._onresize();\n        }\n      }).observe(canvas, { attributes: true, attributeFilter: ['style'] });\n      window.addEventListener('resize', () => {\n        this._onresize();\n      });\n    }\n  }\n}\n"],"names":[],"mappings":"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"}
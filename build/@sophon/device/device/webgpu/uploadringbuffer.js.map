{"version":3,"file":"uploadringbuffer.js","sources":["../../../../../libs/device/src/device/webgpu/uploadringbuffer.ts"],"sourcesContent":["import type { WebGPUDevice } from './device';\n\nexport interface MappedBuffer {\n  buffer: GPUBuffer;\n  size: number;\n  offset: number;\n  used: boolean;\n  mappedRange: ArrayBuffer;\n}\n\nexport interface UploadBuffer {\n  mappedBuffer: MappedBuffer;\n  uploadSize: number;\n  uploadBuffer: GPUBuffer;\n  uploadOffset: number;\n}\n\nexport interface UploadImage {\n  offsetX: number;\n  offsetY: number;\n  offsetZ: number;\n  width: number;\n  height: number;\n  depth: number;\n  mipLevel: number;\n  image: ImageBitmap | HTMLCanvasElement | OffscreenCanvas;\n}\n\nexport interface UploadTexture {\n  mappedBuffer: MappedBuffer;\n  uploadOffsetX: number;\n  uploadOffsetY: number;\n  uploadOffsetZ: number;\n  uploadWidth: number;\n  uploadHeight: number;\n  uploadDepth: number;\n  bufferStride: number;\n  mipLevel: number;\n}\n\nexport class UploadRingBuffer {\n  private _device: WebGPUDevice;\n  private _bufferList: MappedBuffer[];\n  private _defaultSize: number;\n  private _unmappedBufferList: MappedBuffer[];\n  constructor(device: WebGPUDevice, defaultSize = 64 * 1024) {\n    this._device = device;\n    this._bufferList = [];\n    this._defaultSize = defaultSize;\n    this._unmappedBufferList = [];\n  }\n  uploadBuffer(src: ArrayBuffer, dst: GPUBuffer, srcOffset: number, dstOffset: number, uploadSize: number, allowOverlap?: boolean): UploadBuffer {\n    const size = (uploadSize + 3) & ~3;\n    const mappedBuffer = this.fetchBufferMapped(size, !!allowOverlap);\n    if (src) {\n      const mappedRange = mappedBuffer.mappedRange;//mappedBuffer.buffer.getMappedRange(mappedBuffer.offset, size);\n      new Uint8Array(mappedRange, mappedBuffer.offset, size).set(new Uint8Array(src, srcOffset, uploadSize));\n    }\n    const upload = {\n      mappedBuffer: {...mappedBuffer},\n      uploadSize: size,\n      uploadBuffer: dst,\n      uploadOffset: dstOffset,\n    };\n    mappedBuffer.offset += size;\n    mappedBuffer.offset = (mappedBuffer.offset + 7) & ~7;\n    return upload;\n  }\n  beginUploads(): number {\n    for (let i = this._bufferList.length - 1; i >= 0; i--) {\n      const buffer = this._bufferList[i];\n      if (buffer.used) {\n        buffer.buffer.unmap();\n        this._unmappedBufferList.push(buffer);\n        this._bufferList.splice(i, 1);\n        buffer.mappedRange = null;\n      }\n    }\n    return this._unmappedBufferList.length;\n  }\n  endUploads() {\n    for (const buffer of this._unmappedBufferList) {\n      buffer.buffer.mapAsync(GPUMapMode.WRITE).then(() => {\n        buffer.offset = 0;\n        buffer.used = false;\n        buffer.mappedRange = buffer.buffer.getMappedRange();\n        this._bufferList.push(buffer);\n      });\n    }\n    this._unmappedBufferList = [];\n  }\n  purge() {\n    for (let i = this._bufferList.length - 1; i >= 0; i--) {\n      const buffer = this._bufferList[i];\n      if (buffer.mappedRange) {\n        buffer.buffer.unmap();\n        buffer.buffer.destroy();\n      }\n    }\n    this._bufferList = [];\n    for (const buffer of this._unmappedBufferList) {\n      buffer.buffer.destroy();\n    }\n    this._unmappedBufferList = [];\n  }\n  fetchBufferMapped(size: number, allowOverlap: boolean): MappedBuffer {\n    for (const buffer of this._bufferList) {\n      if (allowOverlap || buffer.size - buffer.offset >= size) {\n        buffer.used = true;\n        return buffer;\n      }\n    }\n    const bufferSize = (Math.max(size, this._defaultSize) + 3) & ~3;\n    const buf = this._device.device.createBuffer({\n      label: `StagingRingBuffer${this._bufferList.length}:${bufferSize}`,\n      size: bufferSize,\n      usage: GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,\n      mappedAtCreation: true\n    });\n    this._bufferList.push({\n      buffer: buf,\n      size: bufferSize,\n      offset: 0,\n      used: true,\n      mappedRange: buf.getMappedRange(),\n    });\n    return this._bufferList[this._bufferList.length -1];\n  }\n}\n"],"names":[],"mappings":"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"}
{"version":3,"file":"framebuffer_webgpu.js","sources":["../../../../../libs/device/src/device/webgpu/framebuffer_webgpu.ts"],"sourcesContent":["import { CubeFace } from '@sophon/base';\nimport { WebGPUObject } from './gpuobject_webgpu';\nimport { FrameBuffer, IFrameBufferOptions } from '../gpuobject';\nimport type { WebGPUDevice } from './device';\nimport type { BaseTexture } from '../gpuobject';\nimport type { WebGPUBaseTexture } from './basetexture_webgpu';\n\nexport class WebGPUFrameBuffer extends WebGPUObject<unknown> implements FrameBuffer<unknown> {\n  private _options: IFrameBufferOptions;\n  private _viewport: number[];\n  private _scissor: number[];\n  private _width: number;\n  private _height: number;\n  private _bindFlag: number;\n  constructor(device: WebGPUDevice, opt?: IFrameBufferOptions) {\n    super(device);\n    this._object = null;\n    this._viewport = [0, 0, 0, 0];\n    this._scissor = null;\n    this._options = {\n      colorAttachments: opt?.colorAttachments\n        ? opt.colorAttachments.map((value) => Object.assign({ texture: null }, value))\n        : null,\n      depthAttachment: opt?.depthAttachment ? Object.assign({}, opt.depthAttachment) : null\n    };\n    this._width = 0;\n    this._height = 0;\n    this._bindFlag = 0;\n    this._init();\n  }\n  get options(): IFrameBufferOptions {\n    return this._options;\n  }\n  get bindFlag(): number {\n    return this._bindFlag;\n  }\n  getViewport(): number[] {\n    return this._viewport;\n  }\n  setViewport(vp: number[]): void {\n    this._viewport = [...vp];\n  }\n  getScissorRect(): number[] {\n    return this._scissor;\n  }\n  setScissorRect(scissor: number[]): void {\n    this._scissor = scissor ? [...scissor] : null;\n  }\n  getWidth(): number {\n    return this._width;\n  }\n  getHeight(): number {\n    return this._height;\n  }\n  async restore() {\n    if (this._options?.depthAttachment?.texture?.disposed) {\n      await this._options.depthAttachment.texture.reload();\n    }\n    if (this._options?.colorAttachments) {\n      for (const k of this._options.colorAttachments) {\n        if (k?.texture?.disposed) {\n          await k.texture.reload();\n        }\n      }\n    }\n    if (!this._device.isContextLost()) {\n      this._init();\n    }\n  }\n  destroy() {\n    this._object = null;\n  }\n  setCubeTextureFace(index: number, face: CubeFace) {\n    if (this._options.colorAttachments[index].face !== face) {\n      this._options.colorAttachments[index].face = face;\n      this._bindFlag++;\n    }\n  }\n  setTextureLevel(index: number, level: number) {\n    if (this._options.colorAttachments[index].level !== level) {\n      this._options.colorAttachments[index].level = level;\n      this._bindFlag++;\n    }\n  }\n  setTextureLayer(index: number, layer: number) {\n    if (this._options.colorAttachments[index].layer !== layer) {\n      this._options.colorAttachments[index].layer = layer;\n      this._bindFlag++;\n    }\n  }\n  setDepthTextureLayer(layer: number) {\n    if (this._options.depthAttachment && this._options.depthAttachment.layer !== layer) {\n      this._options.depthAttachment.layer = layer;\n      this._bindFlag++;\n    }\n  }\n  getDepthAttachment(): BaseTexture {\n    return this._options?.depthAttachment?.texture || null;\n  }\n  getColorAttachments(): BaseTexture[] {\n    return this._options?.colorAttachments?.map(val => val?.texture || null) || [];\n  }\n  getColorFormats(): GPUTextureFormat[] {\n    return this._options?.colorAttachments?.map(val => (val?.texture as WebGPUBaseTexture)?.gpuFormat || null);\n  }\n  getDepthFormat(): GPUTextureFormat {\n    return (this._options.depthAttachment?.texture as WebGPUBaseTexture)?.gpuFormat || null;\n  }\n  bind(): boolean {\n    throw new Error('no bind operatation for WebGPU');\n  }\n  unbind(): void {\n    throw new Error('no unbind operatation for WebGPU');\n  }\n  private _init(): void {\n    this._width = 0;\n    this._height = 0;\n    for (const colorAttachment of this._options.colorAttachments) {\n      if (colorAttachment.texture) {\n        if (this._width === 0) {\n          this._width = colorAttachment.texture.width;\n        }\n        if (this._height === 0) {\n          this._height = colorAttachment.texture.height;\n        }\n        if (this._width !== colorAttachment.texture.width || this._height !== colorAttachment.texture.height) {\n          console.error('init frame buffer failed: color attachment textures must have same size');\n          return;\n        }\n      }\n    }\n    if (this._width === 0 || this._height === 0) {\n      console.error('init frame buffer failed: can not create frame buffer with zero size');\n      return;\n    }\n    this._object = {};\n  }\n  isFramebuffer(): boolean {\n    return true;\n  }\n  getSampleCount(): number {\n    return 1;\n  }\n}\n"],"names":[],"mappings":"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"}
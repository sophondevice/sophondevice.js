{"version":3,"file":"gpuprogram_webgpu.js","sources":["../../../../../libs/device/src/device/webgpu/gpuprogram_webgpu.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\r\nimport { WebGPUObject } from './gpuobject_webgpu';\r\nimport { ShaderType } from '../base_types';\r\nimport type { GPUProgram, BindGroupLayout, BindPointInfo } from '../gpuobject';\r\nimport type { GPUProgramConstructParams, RenderProgramConstructParams, ComputeProgramConstructParams } from '../device';\r\nimport type { WebGPUDevice } from './device';\r\n\r\nexport class WebGPUProgram extends WebGPUObject<unknown> implements GPUProgram {\r\n  private static _hashCounter = 0;\r\n  private _type: 'render' | 'compute';\r\n  private _vs: string;\r\n  private _fs: string;\r\n  private _cs: string;\r\n  private _label: string;\r\n  private _hash: string;\r\n  private _error: string;\r\n  private _bindGroupLayouts: BindGroupLayout[];\r\n  private _vertexAttributes: string;\r\n  private _csModule: GPUShaderModule;\r\n  private _vsModule: GPUShaderModule;\r\n  private _fsModule: GPUShaderModule;\r\n  private _pipelineLayout: GPUPipelineLayout;\r\n  constructor(device: WebGPUDevice, params: GPUProgramConstructParams) {\r\n    super(device);\r\n    this._type = params.type;\r\n    this._label = params.label;\r\n    this._bindGroupLayouts = [...params.params.bindGroupLayouts];\r\n    this._error = '';\r\n    if (params.type === 'render') {\r\n      const renderParams = params.params as RenderProgramConstructParams;\r\n      this._vs = renderParams.vs;\r\n      this._fs = renderParams.fs;\r\n      this._vertexAttributes = renderParams.vertexAttributes ? renderParams.vertexAttributes.join(':') : '';\r\n    } else {\r\n      const computeParams = params.params as ComputeProgramConstructParams;\r\n      this._cs = computeParams.source;\r\n    }\r\n    this._load();\r\n    this._hash = String(++WebGPUProgram._hashCounter);\r\n  }\r\n  get type(): 'render' | 'compute' {\r\n    return this._type;\r\n  }\r\n  get label(): string {\r\n    return this._label;\r\n  }\r\n  getCompileError(): string {\r\n    return this._error;\r\n  }\r\n  getShaderSource(shaderType: ShaderType): string {\r\n    switch (shaderType) {\r\n      case ShaderType.Vertex: return this._vs;\r\n      case ShaderType.Fragment: return this._fs;\r\n      case ShaderType.Compute: return this._cs;\r\n    }\r\n  }\r\n  getBindingInfo(name: string): BindPointInfo {\r\n    for (let group = 0; group < this._bindGroupLayouts.length; group++) {\r\n      const layout = this._bindGroupLayouts[group];\r\n      for (let binding = 0; binding < layout.entries.length; binding++) {\r\n        const bindingPoint = layout.entries[binding];\r\n        if (bindingPoint.name === name) {\r\n          return {\r\n            group: group,\r\n            binding: binding,\r\n            type: bindingPoint.type\r\n          };\r\n        }\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n  get bindGroupLayouts(): BindGroupLayout[] {\r\n    return this._bindGroupLayouts;\r\n  }\r\n  get vertexAttributes(): string {\r\n    return this._vertexAttributes;\r\n  }\r\n  get hash(): string {\r\n    return this._hash;\r\n  }\r\n  getPipelineLayout(): GPUPipelineLayout {\r\n    return this._pipelineLayout;\r\n  }\r\n  getShaderModule(): { vsModule: GPUShaderModule, fsModule: GPUShaderModule, csModule: GPUShaderModule, pipelineLayout: GPUPipelineLayout } {\r\n    return {\r\n      vsModule: this._vsModule,\r\n      fsModule: this._fsModule,\r\n      csModule: this._csModule,\r\n      pipelineLayout: this._pipelineLayout\r\n    };\r\n  }\r\n  get fsModule(): GPUShaderModule {\r\n    return this._fsModule;\r\n  }\r\n  destroy() {\r\n    this._vsModule = null;\r\n    this._fsModule = null;\r\n    this._pipelineLayout = null;\r\n    this._object = null;\r\n  }\r\n  async restore() {\r\n    if (!this._object) {\r\n      this._load();\r\n    }\r\n  }\r\n  isProgram(): boolean {\r\n    return true;\r\n  }\r\n  private _load() {\r\n    if (this._type === 'render') {\r\n      this._vsModule = this.createShaderModule(this._vs);\r\n      this._fsModule = this.createShaderModule(this._fs);\r\n    } else {\r\n      this._csModule = this.createShaderModule(this._cs);\r\n    }\r\n    this._pipelineLayout = this.createPipelineLayout(this._bindGroupLayouts);\r\n    this._object = {};\r\n  }\r\n  private createPipelineLayout(bindGroupLayouts: BindGroupLayout[]): GPUPipelineLayout {\r\n    const layouts: GPUBindGroupLayout[] = [];\r\n    bindGroupLayouts.forEach(val => {\r\n      layouts.push(this._device.fetchBindGroupLayout(val));\r\n    });\r\n    return this._device.device.createPipelineLayout({\r\n      bindGroupLayouts: layouts\r\n    });\r\n  }\r\n  private createShaderModule(code: string): GPUShaderModule {\r\n    const t0 = Date.now();\r\n    let sm = this._device.device.createShaderModule({ code });\r\n    if (sm && sm.compilationInfo) {\r\n      sm.compilationInfo().then(compilationInfo => {\r\n        const elapsed = Date.now() - t0;\r\n        if (elapsed > 1000) {\r\n          console.log(`compile shader took ${elapsed}ms: \\n${code}`);\r\n        }\r\n        let err = false;\r\n        if (compilationInfo?.messages?.length > 0) {\r\n          let msg = '';\r\n          for (const message of compilationInfo.messages) {\r\n            if (message.type === 'error') {\r\n              err = true;\r\n            }\r\n            msg += `${message.type}: ${message.message} (${message.lineNum}/${message.linePos})\\n`;\r\n          }\r\n          if (msg) {\r\n            this._error += msg;\r\n            console.log(msg);\r\n          }\r\n        }\r\n        if (err) {\r\n          sm = null;\r\n        }\r\n      });\r\n    }\r\n    return sm;\r\n  }\r\n  use(): void {\r\n    this._device.setProgram(this);\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}
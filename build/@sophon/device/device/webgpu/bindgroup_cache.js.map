{"version":3,"file":"bindgroup_cache.js","sources":["../../../../../libs/device/src/device/webgpu/bindgroup_cache.ts"],"sourcesContent":["import {ShaderType} from '../base_types';\r\nimport {textureFormatMap} from './constants_webgpu';\r\nimport type {WebGPUDevice} from './device';\r\nimport type {BindGroupLayout} from '../gpuobject';\r\n\r\nexport class BindGroupCache {\r\n  private _device: WebGPUDevice;\r\n  private _bindGroupLayoutCache: {[hash: string]: GPUBindGroupLayout};\r\n  constructor(device: WebGPUDevice) {\r\n    this._device = device;\r\n    this._bindGroupLayoutCache = {};\r\n  }\r\n  fetchBindGroupLayout(desc: BindGroupLayout): GPUBindGroupLayout {\r\n    const hash = desc ? this.getLayoutHash(desc) : '';\r\n    let bgl = this._bindGroupLayoutCache[hash];\r\n    if (!bgl) {\r\n      bgl = this.createBindGroupLayout(desc);\r\n      if (bgl) {\r\n        this._bindGroupLayoutCache[hash] = bgl;\r\n      } else {\r\n        throw new Error(`fetchBindGroupLayout() failed: hash: ${hash}`);\r\n      }\r\n    }\r\n    return bgl;\r\n  }\r\n  private getLayoutHash(desc: BindGroupLayout): string {\r\n    let hash = '';\r\n    for (const entry of desc.entries) {\r\n      let s = `${entry.binding}:${entry.visibility}:`;\r\n      if (entry.buffer) {\r\n        s += `b:${entry.buffer.type}:${entry.buffer.hasDynamicOffset}:${entry.buffer.minBindingSize}`;\r\n      } else if (entry.sampler) {\r\n        s += `s${entry.sampler.type}:`\r\n      } else if (entry.texture) {\r\n        s += `t${entry.texture.sampleType}-${entry.texture.viewDimension}-${Number(!!entry.texture.multisampled)}:`;\r\n      } else if (entry.storageTexture) {\r\n        s += `k${entry.storageTexture.access}-${entry.storageTexture.format}-${entry.storageTexture.viewDimension}:`;\r\n      } else if (entry.externalTexture) {\r\n        s += `v:`;\r\n      }\r\n      hash = `${hash} ${s}`;\r\n    }\r\n    return hash;\r\n  }\r\n  private createBindGroupLayout(desc: BindGroupLayout): GPUBindGroupLayout {\r\n    const layoutDescriptor: GPUBindGroupLayoutDescriptor = {\r\n      entries: desc?.entries.map(entry => {\r\n        const binding = entry.binding;\r\n        const visibility = ((entry.visibility & ShaderType.Vertex) ? GPUShaderStage.VERTEX : 0)\r\n          | ((entry.visibility & ShaderType.Fragment) ? GPUShaderStage.FRAGMENT : 0)\r\n          | ((entry.visibility & ShaderType.Compute) ? GPUShaderStage.COMPUTE : 0);\r\n        const buffer: GPUBufferBindingLayout = entry.buffer ? {\r\n          type: entry.buffer.type,\r\n          hasDynamicOffset: entry.buffer.hasDynamicOffset,\r\n          minBindingSize: Number(entry.buffer.minBindingSize)||0,\r\n        } : undefined;\r\n        const sampler: GPUSamplerBindingLayout = entry.sampler ? {\r\n          type: entry.sampler.type\r\n        } : undefined;\r\n        const texture: GPUTextureBindingLayout = entry.texture ? {\r\n          sampleType: entry.texture.sampleType,\r\n          viewDimension: entry.texture.viewDimension,\r\n        } : undefined;\r\n        const storageTexture: GPUStorageTextureBindingLayout = entry.storageTexture ? {\r\n          access: 'write-only',\r\n          viewDimension: '2d',\r\n          format: textureFormatMap[entry.storageTexture.format],\r\n        } : undefined;\r\n        const externalTexture: GPUExternalTextureBindingLayout = entry.externalTexture ? {} : undefined;\r\n        const t: GPUBindGroupLayoutEntry = {\r\n          binding,\r\n          visibility,\r\n        };\r\n        if (buffer) {\r\n          t.buffer = buffer;\r\n        } else if (sampler) {\r\n          t.sampler = sampler;\r\n        } else if (texture) {\r\n          t.texture = texture;\r\n        } else if (storageTexture) {\r\n          t.storageTexture = storageTexture;\r\n        } else if (externalTexture) {\r\n          t.externalTexture = externalTexture;\r\n        }\r\n        return t;\r\n      }) || [],\r\n    };\r\n    if (desc?.label) {\r\n      layoutDescriptor.label = desc.label;\r\n    }\r\n    return this._device.device.createBindGroupLayout(layoutDescriptor);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
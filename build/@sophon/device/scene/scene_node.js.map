{"version":3,"file":"scene_node.js","sources":["../../../../libs/device/src/scene/scene_node.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { REventPath, REventPathBuilder, REventTarget, REvent, Vector3, Quaternion } from '@sophon/base';\nimport { XForm } from './xform';\nimport type { Visitor } from '../misc';\nimport type { Scene } from './scene';\nimport type { GraphNode } from './graph_node';\nimport type { Mesh } from './mesh';\nimport type { Camera } from './camera';\nimport type { Terrain } from './terrain';\nimport type { PunctualLight, BaseLight } from './light';\n\nclass SceneNodeEventPath implements REventPath {\n  path: REventTarget[];\n  constructor() {\n    this.path = [];\n  }\n  toArray(): REventTarget[] {\n    return this.path;\n  }\n}\n\nexport class SceneNodeEventPathBuilder implements REventPathBuilder {\n  build(node: REventTarget): REventPath {\n    const path = new SceneNodeEventPath();\n    let sceneNode = node as SceneNode;\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    while (sceneNode) {\n      path.path.push(sceneNode);\n      if (sceneNode.parent) {\n        sceneNode = sceneNode.parent;\n      } else {\n        path.path.push(sceneNode.scene);\n        sceneNode = null;\n      }\n    }\n    return path;\n  }\n}\n\nexport class SceneNodeAttachEvent extends REvent {\n  static readonly ATTACHED_NAME = 'attached';\n  static readonly DETACHED_NAME = 'detached';\n  node: SceneNode;\n  constructor(name: string, node: SceneNode) {\n    super(name, true, false);\n    this.node = node;\n  }\n}\n\nconst sceneNodeEventPathBuilder = new SceneNodeEventPathBuilder();\n\nexport class SceneNode extends XForm<SceneNode> {\n  /** @internal */\n  protected _name: string;\n  /** @internal */\n  protected _attachEvent: SceneNodeAttachEvent;\n  /** @internal */\n  protected _detachEvent: SceneNodeAttachEvent;\n  constructor(scene: Scene, parent?: SceneNode) {\n    super(scene, null, sceneNodeEventPathBuilder);\n    this._name = '';\n    this._attachEvent = new SceneNodeAttachEvent(SceneNodeAttachEvent.ATTACHED_NAME, this);\n    this._detachEvent = new SceneNodeAttachEvent(SceneNodeAttachEvent.DETACHED_NAME, this);\n    if (parent !== null) {\n      this.reparent(parent || scene.rootNode);\n    }\n  }\n  get name() {\n    return this._name;\n  }\n  set name(val: string) {\n    this._name = val || '';\n  }\n  get attached(): boolean {\n    return !!this._scene?.rootNode.isParentOf(this);\n  }\n  setPosition(value: Vector3): this {\n    this.position = value;\n    return this;\n  }\n  setScale(value: Vector3): this {\n    this.scaling = value;\n    return this;\n  }\n  setRotation(value: Quaternion): this {\n    this.rotation = value;\n    return this;\n  }\n  hasChild(child: SceneNode): boolean {\n    return this._children.indexOf(child) >= 0;\n  }\n  removeChildren() {\n    while (this._children.length) {\n      this._children[0].remove();\n    }\n  }\n  iterateChildren(func: (child: SceneNode) => void) {\n    for (const child of this._children) {\n      func(child);\n      child.iterateChildren(func);\n    }\n  }\n  isParentOf(child: SceneNode): boolean {\n    while (child && child !== this) {\n      child = child.parent;\n    }\n    return child === this;\n  }\n  remove() {\n    this.parent = null;\n    return this;\n  }\n  reparent(p?: SceneNode) {\n    this.parent = p;\n    return this;\n  }\n  accept(v: Visitor) {\n    v.visit(this);\n  }\n  traverse(v: Visitor, inverse?: boolean) {\n    if (inverse) {\n      for (let i = this._children.length - 1; i >= 0; i--) {\n        this._children[i].traverse(v, inverse);\n      }\n      v.visit(this);\n    } else {\n      v.visit(this);\n      for (const child of this._children) {\n        child.traverse(v);\n      }\n    }\n  }\n  isGraphNode(): this is GraphNode {\n    return false;\n  }\n  isLight(): this is BaseLight {\n    return false;\n  }\n  isMesh(): this is Mesh {\n    return false;\n  }\n  isTerrain(): this is Terrain {\n    return false;\n  }\n  isCamera(): this is Camera {\n    return false;\n  }\n  isPunctualLight(): this is PunctualLight {\n    return false;\n  }\n  dispose() {\n    this.remove();\n    this.removeChildren();\n  }\n  invalidateWorldBoundingVolume() {\n    super.invalidateWorldBoundingVolume();\n    this._scene && this._scene._bvChanged(this);\n  }\n  /** @internal */\n  protected _setParent(p: SceneNode): void {\n    const lastAttached = this.attached;\n    super._setParent(p);\n    if (lastAttached) {\n      this._fireAttachEvent(this._detachEvent);\n    }\n    if (this.attached) {\n      this._fireAttachEvent(this._attachEvent);\n    }\n  }\n  /** @internal */\n  private _fireAttachEvent(evt: SceneNodeAttachEvent) {\n    evt.reset();\n    this.dispatchEvent(evt);\n    for (const child of this.children) {\n      child._fireAttachEvent(evt);\n    }\n  }\n}\n"],"names":[],"mappings":"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"}
{"version":3,"file":"scene_node.js","sources":["../../../../libs/device/src/scene/scene_node.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\r\nimport { REventPath, REventPathBuilder, REventTarget, REvent, Vector3, Quaternion } from '@sophon/base';\r\nimport { XForm } from './xform';\r\nimport type { Visitor } from '../misc';\r\nimport type { Scene } from './scene';\r\nimport type { GraphNode } from './graph_node';\r\nimport type { Mesh } from './mesh';\r\nimport type { Camera } from './camera';\r\nimport type { Terrain } from './terrain';\r\nimport type { PunctualLight, BaseLight } from './light';\r\n\r\nclass SceneNodeEventPath implements REventPath {\r\n  path: REventTarget[];\r\n  constructor() {\r\n    this.path = [];\r\n  }\r\n  toArray(): REventTarget[] {\r\n    return this.path;\r\n  }\r\n}\r\n\r\nexport class SceneNodeEventPathBuilder implements REventPathBuilder {\r\n  build(node: REventTarget): REventPath {\r\n    const path = new SceneNodeEventPath();\r\n    let sceneNode = node as SceneNode;\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    while (sceneNode) {\r\n      path.path.push(sceneNode);\r\n      if (sceneNode.parent) {\r\n        sceneNode = sceneNode.parent;\r\n      } else {\r\n        path.path.push(sceneNode.scene);\r\n        sceneNode = null;\r\n      }\r\n    }\r\n    return path;\r\n  }\r\n}\r\n\r\nexport class SceneNodeAttachEvent extends REvent {\r\n  static readonly ATTACHED_NAME = 'attached';\r\n  static readonly DETACHED_NAME = 'detached';\r\n  node: SceneNode;\r\n  constructor(name: string, node: SceneNode) {\r\n    super(name, true, false);\r\n    this.node = node;\r\n  }\r\n}\r\n\r\nconst sceneNodeEventPathBuilder = new SceneNodeEventPathBuilder();\r\n\r\nexport class SceneNode extends XForm<SceneNode> {\r\n  /** @internal */\r\n  protected _name: string;\r\n  /** @internal */\r\n  protected _attachEvent: SceneNodeAttachEvent;\r\n  /** @internal */\r\n  protected _detachEvent: SceneNodeAttachEvent;\r\n  constructor(scene: Scene, parent?: SceneNode) {\r\n    super(scene, null, sceneNodeEventPathBuilder);\r\n    this._name = '';\r\n    this._attachEvent = new SceneNodeAttachEvent(SceneNodeAttachEvent.ATTACHED_NAME, this);\r\n    this._detachEvent = new SceneNodeAttachEvent(SceneNodeAttachEvent.DETACHED_NAME, this);\r\n    if (parent !== null) {\r\n      this.reparent(parent || scene.rootNode);\r\n    }\r\n  }\r\n  get name() {\r\n    return this._name;\r\n  }\r\n  set name(val: string) {\r\n    this._name = val || '';\r\n  }\r\n  get attached(): boolean {\r\n    return !!this._scene?.rootNode.isParentOf(this);\r\n  }\r\n  setPosition(value: Vector3): this {\r\n    this.position = value;\r\n    return this;\r\n  }\r\n  setScale(value: Vector3): this {\r\n    this.scaling = value;\r\n    return this;\r\n  }\r\n  setRotation(value: Quaternion): this {\r\n    this.rotation = value;\r\n    return this;\r\n  }\r\n  hasChild(child: SceneNode): boolean {\r\n    return this._children.indexOf(child) >= 0;\r\n  }\r\n  removeChildren() {\r\n    while (this._children.length) {\r\n      this._children[0].remove();\r\n    }\r\n  }\r\n  iterateChildren(func: (child: SceneNode) => void) {\r\n    for (const child of this._children) {\r\n      func(child);\r\n      child.iterateChildren(func);\r\n    }\r\n  }\r\n  isParentOf(child: SceneNode): boolean {\r\n    while (child && child !== this) {\r\n      child = child.parent;\r\n    }\r\n    return child === this;\r\n  }\r\n  remove() {\r\n    this.parent = null;\r\n    return this;\r\n  }\r\n  reparent(p?: SceneNode) {\r\n    this.parent = p;\r\n    return this;\r\n  }\r\n  accept(v: Visitor) {\r\n    v.visit(this);\r\n  }\r\n  traverse(v: Visitor, inverse?: boolean) {\r\n    if (inverse) {\r\n      for (let i = this._children.length - 1; i >= 0; i--) {\r\n        this._children[i].traverse(v, inverse);\r\n      }\r\n      v.visit(this);\r\n    } else {\r\n      v.visit(this);\r\n      for (const child of this._children) {\r\n        child.traverse(v);\r\n      }\r\n    }\r\n  }\r\n  isGraphNode(): this is GraphNode {\r\n    return false;\r\n  }\r\n  isLight(): this is BaseLight {\r\n    return false;\r\n  }\r\n  isMesh(): this is Mesh {\r\n    return false;\r\n  }\r\n  isTerrain(): this is Terrain {\r\n    return false;\r\n  }\r\n  isCamera(): this is Camera {\r\n    return false;\r\n  }\r\n  isPunctualLight(): this is PunctualLight {\r\n    return false;\r\n  }\r\n  dispose() {\r\n    this.remove();\r\n    this.removeChildren();\r\n  }\r\n  invalidateWorldBoundingVolume() {\r\n    super.invalidateWorldBoundingVolume();\r\n    this._scene && this._scene._bvChanged(this);\r\n  }\r\n  /** @internal */\r\n  protected _setParent(p: SceneNode): void {\r\n    const lastAttached = this.attached;\r\n    super._setParent(p);\r\n    if (lastAttached) {\r\n      this._fireAttachEvent(this._detachEvent);\r\n    }\r\n    if (this.attached) {\r\n      this._fireAttachEvent(this._attachEvent);\r\n    }\r\n  }\r\n  /** @internal */\r\n  private _fireAttachEvent(evt: SceneNodeAttachEvent) {\r\n    evt.reset();\r\n    this.dispatchEvent(evt);\r\n    for (const child of this.children) {\r\n      child._fireAttachEvent(evt);\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
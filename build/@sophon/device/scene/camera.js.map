{"version":3,"file":"camera.js","sources":["../../../../libs/device/src/scene/camera.ts"],"sourcesContent":["import { CubeFace, Matrix4x4, Vector3, Frustum } from '@sophon/base';\r\nimport { SceneNode } from './scene_node';\r\nimport type { Scene } from './scene';\r\nexport interface IMouseEvent {\r\n  x: number;\r\n  y: number;\r\n  offsetX: number;\r\n  offsetY: number;\r\n  button: number;\r\n  buttons: number;\r\n  wheelDeltaX: number;\r\n  wheelDeltaY: number;\r\n  ctrlKey: boolean;\r\n  shiftKey: boolean;\r\n  altKey: boolean;\r\n  metaKey: boolean;\r\n  target: unknown;\r\n}\r\n\r\nexport interface IKeyEvent {\r\n  key: string;\r\n  code: string;\r\n  ctrlKey: boolean;\r\n  shiftKey: boolean;\r\n  altKey: boolean;\r\n  metaKey: boolean;\r\n  target: unknown;\r\n}\r\n\r\nexport interface IFrameStamp {\r\n  frameId: number;\r\n  timestamp: number;\r\n}\r\n\r\nexport interface CameraInputSource {\r\n  addEventListener(eventname: string, func: (evt: any) => void);\r\n  removeEventListener(eventname: string, func: (evt: any) => void);\r\n}\r\n\r\nexport interface AbstractCameraModel {\r\n  reset(): void;\r\n  installMouseInput(input: CameraInputSource);\r\n  uninstallMouseInput(input: CameraInputSource);\r\n  installKeyboardInput(input: CameraInputSource);\r\n  uninstallKeyboardInput(input: CameraInputSource);\r\n  onMouseDown(evt: IMouseEvent): void;\r\n  onMouseUp(evt: IMouseEvent): void;\r\n  onMouseWheel(evt: IMouseEvent): void;\r\n  onMouseMove(evt: IMouseEvent): void;\r\n  onKeyDown(evt: IKeyEvent): void;\r\n  onKeyUp(evt: IKeyEvent): void;\r\n  update(): void;\r\n  /** @internal */\r\n  _getCamera(): Camera;\r\n  /** @internal */\r\n  _setCamera(camera: Camera): void;\r\n}\r\n\r\nexport class Camera extends SceneNode {\r\n  /** @internal */\r\n  protected _projMatrix: Matrix4x4;\r\n  /** @internal */\r\n  protected _viewMatrix: Matrix4x4;\r\n  /** @internal */\r\n  protected _viewProjMatrix: Matrix4x4;\r\n  /** @internal */\r\n  protected _invViewProjMatrix: Matrix4x4;\r\n  /** @internal */\r\n  protected _framestamp: IFrameStamp;\r\n  /** @internal */\r\n  protected _xformDirty: boolean;\r\n  /** @internal */\r\n  protected _linearOutput: boolean;\r\n  /** @internal */\r\n  protected _model: AbstractCameraModel;\r\n  /** @internal */\r\n  protected _mouseInputSource: CameraInputSource;\r\n  /** @internal */\r\n  protected _keyboardInputSource: CameraInputSource;\r\n  /** @internal */\r\n  protected _cameraTag: number;\r\n  /** @internal */\r\n  protected _frustum: Frustum;\r\n  constructor(scene: Scene, projectionMatrix?: Matrix4x4) {\r\n    super(scene);\r\n    this._projMatrix = projectionMatrix || Matrix4x4.identity();\r\n    this._viewMatrix = Matrix4x4.identity();\r\n    this._viewProjMatrix = Matrix4x4.identity();\r\n    this._invViewProjMatrix = Matrix4x4.identity();\r\n    this._framestamp = { frameId: 0, timestamp: 0 };\r\n    this._xformDirty = true;\r\n    this._linearOutput = false;\r\n    this._model = null;\r\n    this._cameraTag = 0;\r\n    this._frustum = null;\r\n    this._mouseInputSource = null;\r\n    this._keyboardInputSource = null;\r\n    this._projMatrix.setChangeCallback(() => this._invalidate());\r\n    this.addDefaultEventListener('xform_change', () => this._invalidate());\r\n  }\r\n  get cameraTag(): number {\r\n    return this._cameraTag;\r\n  }\r\n  get framestamp(): IFrameStamp {\r\n    return this._framestamp;\r\n  }\r\n  get mouseInputSource(): CameraInputSource {\r\n    return this._mouseInputSource;\r\n  }\r\n  set mouseInputSource(inputSource: CameraInputSource) {\r\n    if (inputSource !== this._mouseInputSource) {\r\n      if (this._model) {\r\n        this._model.uninstallMouseInput(this._mouseInputSource);\r\n      }\r\n      this._mouseInputSource = inputSource;\r\n      if (this._model) {\r\n        this._model.installMouseInput(this._mouseInputSource);\r\n      }\r\n    }\r\n  }\r\n  get keyboardInputSource(): CameraInputSource {\r\n    return this._keyboardInputSource;\r\n  }\r\n  set keyboardInputSource(inputSource: CameraInputSource) {\r\n    if (inputSource !== this._keyboardInputSource) {\r\n      if (this._model) {\r\n        this._model.uninstallKeyboardInput(this._keyboardInputSource);\r\n      }\r\n      this._keyboardInputSource = inputSource;\r\n      if (this._model) {\r\n        this._model.installKeyboardInput(this._keyboardInputSource);\r\n      }\r\n    }\r\n  }\r\n  lookAt(eye: Vector3, target: Vector3, up: Vector3): this {\r\n    Matrix4x4.lookAt(eye, target, up).decompose(this.scaling, this.rotation, this.position);\r\n    return this;\r\n  }\r\n  lookAtCubeFace(face: CubeFace, position?: Vector3): void {\r\n    Matrix4x4.lookAtCubeFace(face).decompose(this.scaling, this.rotation, this.position);\r\n    if (position) {\r\n      this.position = position;\r\n    }\r\n  }\r\n  get projectionMatrix(): Matrix4x4 {\r\n    return this._projMatrix;\r\n  }\r\n  set projectionMatrix(matrix: Matrix4x4) {\r\n    this.setProjectionMatrix(matrix);\r\n  }\r\n  setProjectionMatrix(matrix: Matrix4x4) {\r\n    this._projMatrix.assign(matrix.getArray());\r\n    this._invalidate();\r\n    return this;\r\n  }\r\n  get viewMatrix(): Matrix4x4 {\r\n    if (this._xformDirty) {\r\n      this._xformDirty = false;\r\n      this._computeViewProj();\r\n    }\r\n    return this._viewMatrix;\r\n  }\r\n  get viewProjectionMatrix(): Matrix4x4 {\r\n    if (this._xformDirty) {\r\n      this._xformDirty = false;\r\n      this._computeViewProj();\r\n    }\r\n    return this._viewProjMatrix;\r\n  }\r\n  get invViewProjectionMatrix(): Matrix4x4 {\r\n    if (this._xformDirty) {\r\n      this._xformDirty = false;\r\n      this._computeViewProj();\r\n    }\r\n    return this._invViewProjMatrix;\r\n  }\r\n  get frustum(): Frustum {\r\n    if (!this._frustum) {\r\n      this._frustum = new Frustum();\r\n      this._frustum.setMatrix(this.viewProjectionMatrix, Matrix4x4.identity());\r\n    }\r\n    return this._frustum;\r\n  }\r\n  get linearOutputEnabled(): boolean {\r\n    return this._linearOutput;\r\n  }\r\n  set linearOutputEnabled(val: boolean) {\r\n    this.enableLinearOutput(val);\r\n  }\r\n  get model(): AbstractCameraModel {\r\n    return this._model || null;\r\n  }\r\n  set model(model: AbstractCameraModel) {\r\n    this.setModel(model);\r\n  }\r\n  enableLinearOutput(val: boolean) {\r\n    this._linearOutput = val;\r\n    return this;\r\n  }\r\n  isPerspective(): boolean {\r\n    return this._projMatrix.isPerspective();\r\n  }\r\n  isOrtho(): boolean {\r\n    return this._projMatrix.isOrtho();\r\n  }\r\n  isCamera(): this is Camera {\r\n    return true;\r\n  }\r\n  getNearPlane(): number {\r\n    return this._projMatrix.getNearPlane();\r\n  }\r\n  getFarPlane(): number {\r\n    return this._projMatrix.getFarPlane();\r\n  }\r\n  getFOV(): number {\r\n    return this._projMatrix.getFov();\r\n  }\r\n  getTanHalfFovy(): number {\r\n    return this._projMatrix.getTanHalfFov();\r\n  }\r\n  getAspect(): number {\r\n    return this._projMatrix.getAspect();\r\n  }\r\n  setNearFar(znear: number, zfar: number) {\r\n    this._projMatrix.setNearFar(znear, zfar);\r\n  }\r\n  setModel(model: AbstractCameraModel) {\r\n    if (this._model !== model) {\r\n      if (model && model._getCamera() && model._getCamera() !== this) {\r\n        throw new Error(\r\n          'Camera.setModel failed: one camera model object cannot be assigned to multiple camera',\r\n        );\r\n      }\r\n      if (this._model) {\r\n        this._model._setCamera(null);\r\n      }\r\n      this._model = model || null;\r\n      if (this._model) {\r\n        this._model._setCamera(this);\r\n      }\r\n    }\r\n    return this;\r\n  }\r\n  frameUpdate() {\r\n    this._framestamp.frameId++;\r\n    this._framestamp.timestamp = Date.now();\r\n    if (this._model) {\r\n      this._model.update();\r\n    }\r\n  }\r\n  /** @internal */\r\n  protected _invalidate() {\r\n    this._xformDirty = true;\r\n    this._cameraTag++;\r\n    this._frustum = null;\r\n  }\r\n  /** @internal */\r\n  protected _computeViewProj() {\r\n    Matrix4x4.inverseAffine(this.worldMatrix, this._viewMatrix);\r\n    Matrix4x4.multiply(this._projMatrix, this._viewMatrix, this._viewProjMatrix);\r\n    Matrix4x4.inverse(this._viewProjMatrix, this._invViewProjMatrix);\r\n  }\r\n  dispose() {\r\n    this.setModel(null);\r\n    this._projMatrix = null;\r\n    this._viewMatrix = null;\r\n    this._viewProjMatrix = null;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
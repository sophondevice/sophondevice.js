{"version":3,"file":"camera.js","sources":["../../../../libs/device/src/scene/camera.ts"],"sourcesContent":["import { CubeFace, Matrix4x4, Vector3, Frustum } from '@sophon/base';\nimport { SceneNode } from './scene_node';\nimport type { Scene } from './scene';\nexport interface IMouseEvent {\n  x: number;\n  y: number;\n  offsetX: number;\n  offsetY: number;\n  button: number;\n  buttons: number;\n  wheelDeltaX: number;\n  wheelDeltaY: number;\n  ctrlKey: boolean;\n  shiftKey: boolean;\n  altKey: boolean;\n  metaKey: boolean;\n  target: unknown;\n}\n\nexport interface IKeyEvent {\n  key: string;\n  code: string;\n  ctrlKey: boolean;\n  shiftKey: boolean;\n  altKey: boolean;\n  metaKey: boolean;\n  target: unknown;\n}\n\nexport interface IFrameStamp {\n  frameId: number;\n  timestamp: number;\n}\n\nexport interface CameraInputSource {\n  addEventListener(eventname: string, func: (evt: any) => void);\n  removeEventListener(eventname: string, func: (evt: any) => void);\n}\n\nexport interface AbstractCameraModel {\n  reset(): void;\n  installMouseInput(input: CameraInputSource);\n  uninstallMouseInput(input: CameraInputSource);\n  installKeyboardInput(input: CameraInputSource);\n  uninstallKeyboardInput(input: CameraInputSource);\n  onMouseDown(evt: IMouseEvent): void;\n  onMouseUp(evt: IMouseEvent): void;\n  onMouseWheel(evt: IMouseEvent): void;\n  onMouseMove(evt: IMouseEvent): void;\n  onKeyDown(evt: IKeyEvent): void;\n  onKeyUp(evt: IKeyEvent): void;\n  update(): void;\n  /** @internal */\n  _getCamera(): Camera;\n  /** @internal */\n  _setCamera(camera: Camera): void;\n}\n\nexport class Camera extends SceneNode {\n  /** @internal */\n  protected _projMatrix: Matrix4x4;\n  /** @internal */\n  protected _viewMatrix: Matrix4x4;\n  /** @internal */\n  protected _viewProjMatrix: Matrix4x4;\n  /** @internal */\n  protected _invViewProjMatrix: Matrix4x4;\n  /** @internal */\n  protected _framestamp: IFrameStamp;\n  /** @internal */\n  protected _xformDirty: boolean;\n  /** @internal */\n  protected _linearOutput: boolean;\n  /** @internal */\n  protected _model: AbstractCameraModel;\n  /** @internal */\n  protected _mouseInputSource: CameraInputSource;\n  /** @internal */\n  protected _keyboardInputSource: CameraInputSource;\n  /** @internal */\n  protected _cameraTag: number;\n  /** @internal */\n  protected _frustum: Frustum;\n  constructor(scene: Scene, projectionMatrix?: Matrix4x4) {\n    super(scene);\n    this._projMatrix = projectionMatrix || Matrix4x4.identity();\n    this._viewMatrix = Matrix4x4.identity();\n    this._viewProjMatrix = Matrix4x4.identity();\n    this._invViewProjMatrix = Matrix4x4.identity();\n    this._framestamp = { frameId: 0, timestamp: 0 };\n    this._xformDirty = true;\n    this._linearOutput = false;\n    this._model = null;\n    this._cameraTag = 0;\n    this._frustum = null;\n    this._mouseInputSource = null;\n    this._keyboardInputSource = null;\n    this._projMatrix.setChangeCallback(() => this._invalidate());\n    this.addDefaultEventListener('xform_change', () => this._invalidate());\n  }\n  get cameraTag(): number {\n    return this._cameraTag;\n  }\n  get framestamp(): IFrameStamp {\n    return this._framestamp;\n  }\n  get mouseInputSource(): CameraInputSource {\n    return this._mouseInputSource;\n  }\n  set mouseInputSource(inputSource: CameraInputSource) {\n    if (inputSource !== this._mouseInputSource) {\n      if (this._model) {\n        this._model.uninstallMouseInput(this._mouseInputSource);\n      }\n      this._mouseInputSource = inputSource;\n      if (this._model) {\n        this._model.installMouseInput(this._mouseInputSource);\n      }\n    }\n  }\n  get keyboardInputSource(): CameraInputSource {\n    return this._keyboardInputSource;\n  }\n  set keyboardInputSource(inputSource: CameraInputSource) {\n    if (inputSource !== this._keyboardInputSource) {\n      if (this._model) {\n        this._model.uninstallKeyboardInput(this._keyboardInputSource);\n      }\n      this._keyboardInputSource = inputSource;\n      if (this._model) {\n        this._model.installKeyboardInput(this._keyboardInputSource);\n      }\n    }\n  }\n  lookAt(eye: Vector3, target: Vector3, up: Vector3): this {\n    Matrix4x4.lookAt(eye, target, up).decompose(this.scaling, this.rotation, this.position);\n    return this;\n  }\n  lookAtCubeFace(face: CubeFace, position?: Vector3): void {\n    Matrix4x4.lookAtCubeFace(face).decompose(this.scaling, this.rotation, this.position);\n    if (position) {\n      this.position = position;\n    }\n  }\n  get projectionMatrix(): Matrix4x4 {\n    return this._projMatrix;\n  }\n  set projectionMatrix(matrix: Matrix4x4) {\n    this.setProjectionMatrix(matrix);\n  }\n  setProjectionMatrix(matrix: Matrix4x4) {\n    this._projMatrix.assign(matrix.getArray());\n    this._invalidate();\n    return this;\n  }\n  get viewMatrix(): Matrix4x4 {\n    if (this._xformDirty) {\n      this._xformDirty = false;\n      this._computeViewProj();\n    }\n    return this._viewMatrix;\n  }\n  get viewProjectionMatrix(): Matrix4x4 {\n    if (this._xformDirty) {\n      this._xformDirty = false;\n      this._computeViewProj();\n    }\n    return this._viewProjMatrix;\n  }\n  get invViewProjectionMatrix(): Matrix4x4 {\n    if (this._xformDirty) {\n      this._xformDirty = false;\n      this._computeViewProj();\n    }\n    return this._invViewProjMatrix;\n  }\n  get frustum(): Frustum {\n    if (!this._frustum) {\n      this._frustum = new Frustum();\n      this._frustum.setMatrix(this.viewProjectionMatrix, Matrix4x4.identity());\n    }\n    return this._frustum;\n  }\n  get linearOutputEnabled(): boolean {\n    return this._linearOutput;\n  }\n  set linearOutputEnabled(val: boolean) {\n    this.enableLinearOutput(val);\n  }\n  get model(): AbstractCameraModel {\n    return this._model || null;\n  }\n  set model(model: AbstractCameraModel) {\n    this.setModel(model);\n  }\n  enableLinearOutput(val: boolean) {\n    this._linearOutput = val;\n    return this;\n  }\n  isPerspective(): boolean {\n    return this._projMatrix.isPerspective();\n  }\n  isOrtho(): boolean {\n    return this._projMatrix.isOrtho();\n  }\n  isCamera(): this is Camera {\n    return true;\n  }\n  getNearPlane(): number {\n    return this._projMatrix.getNearPlane();\n  }\n  getFarPlane(): number {\n    return this._projMatrix.getFarPlane();\n  }\n  getFOV(): number {\n    return this._projMatrix.getFov();\n  }\n  getTanHalfFovy(): number {\n    return this._projMatrix.getTanHalfFov();\n  }\n  getAspect(): number {\n    return this._projMatrix.getAspect();\n  }\n  setNearFar(znear: number, zfar: number) {\n    this._projMatrix.setNearFar(znear, zfar);\n  }\n  setModel(model: AbstractCameraModel) {\n    if (this._model !== model) {\n      if (model && model._getCamera() && model._getCamera() !== this) {\n        throw new Error(\n          'Camera.setModel failed: one camera model object cannot be assigned to multiple camera',\n        );\n      }\n      if (this._model) {\n        this._model._setCamera(null);\n      }\n      this._model = model || null;\n      if (this._model) {\n        this._model._setCamera(this);\n      }\n    }\n    return this;\n  }\n  frameUpdate() {\n    this._framestamp.frameId++;\n    this._framestamp.timestamp = Date.now();\n    if (this._model) {\n      this._model.update();\n    }\n  }\n  /** @internal */\n  protected _invalidate() {\n    this._xformDirty = true;\n    this._cameraTag++;\n    this._frustum = null;\n  }\n  /** @internal */\n  protected _computeViewProj() {\n    Matrix4x4.inverseAffine(this.worldMatrix, this._viewMatrix);\n    Matrix4x4.multiply(this._projMatrix, this._viewMatrix, this._viewProjMatrix);\n    Matrix4x4.inverse(this._viewProjMatrix, this._invViewProjMatrix);\n  }\n  dispose() {\n    this.setModel(null);\n    this._projMatrix = null;\n    this._viewMatrix = null;\n    this._viewProjMatrix = null;\n  }\n}\n"],"names":[],"mappings":"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"}
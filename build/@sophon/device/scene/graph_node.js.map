{"version":3,"file":"graph_node.js","sources":["../../../../libs/device/src/scene/graph_node.ts"],"sourcesContent":["import { ListIterator, Frustum, Matrix4x4 } from '@sophon/base';\nimport { SceneNode } from './scene_node';\nimport type { XForm } from './xform';\nimport type { Texture2D } from '../device/gpuobject';\nimport type { BatchDrawable, Drawable } from './drawable';\nimport type { Scene } from './scene';\nimport type { Camera } from './camera';\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport class GraphNode extends SceneNode {\n  static readonly ORDER_INHERITED = -1;\n  static readonly ORDER_BACKGROUND = 0;\n  static readonly ORDER_DEFAULT = 32;\n  static readonly CLIP_INHERITED = -1;\n  static readonly CLIP_DISABLED = 0;\n  static readonly CLIP_ENABLED = 1;\n  static readonly SHOW_INHERITED = -1;\n  static readonly SHOW_HIDE = 0;\n  static readonly SHOW_DEFAULT = 1;\n  static readonly PICK_INHERITED = -1;\n  static readonly PICK_DISABLED = 0;\n  static readonly PICK_ENABLED = 1;\n  static readonly BBOXDRAW_INHERITED = -1;\n  static readonly BBOXDRAW_DISABLED = 0;\n  static readonly BBOXDRAW_LOCAL = 1;\n  static readonly BBOXDRAW_WORLD = 2;\n  /** @internal */\n  protected _clipMode: number;\n  /** @internal */\n  protected _renderOrder: number;\n  /** @internal */\n  protected _boxDrawMode: number;\n  /** @internal */\n  protected _visible: number;\n  /** @internal */\n  protected _pickMode: number;\n  /** @internal */\n  protected _lastRenderTimestamp: number;\n  /** @internal */\n  protected _lruIterator: ListIterator<Drawable>;\n  constructor(scene: Scene, parent?: SceneNode) {\n    super(scene, parent);\n    this._clipMode = GraphNode.CLIP_ENABLED;\n    this._boxDrawMode = GraphNode.BBOXDRAW_DISABLED;\n    this._renderOrder = GraphNode.ORDER_DEFAULT;\n    this._visible = GraphNode.SHOW_DEFAULT;\n    this._pickMode = GraphNode.PICK_DISABLED;\n    this._lastRenderTimestamp = 0;\n    this._lruIterator = null;\n  }\n  get computedRenderOrder() {\n    if (this._renderOrder === GraphNode.ORDER_INHERITED) {\n      let parent = this.parent;\n      while (parent && !parent.isGraphNode()) {\n        parent = parent.parent;\n      }\n      return (parent as GraphNode)?.computedRenderOrder ?? GraphNode.ORDER_DEFAULT;\n    }\n    return this._renderOrder;\n  }\n  get renderOrder() {\n    return this._renderOrder;\n  }\n  set renderOrder(val: number) {\n    this._renderOrder = val;\n  }\n  get computedClipMode(): number {\n    if (this._clipMode === GraphNode.CLIP_INHERITED) {\n      let parent = this.parent;\n      while (parent && !parent.isGraphNode()) {\n        parent = parent.parent;\n      }\n      return (parent as GraphNode)?.computedClipMode ?? GraphNode.CLIP_ENABLED;\n    }\n    return this._clipMode;\n  }\n  get clipMode(): number {\n    return this._clipMode;\n  }\n  set clipMode(val: number) {\n    this._clipMode = val;\n  }\n  get computedShowState(): number {\n    if (this._visible === GraphNode.SHOW_INHERITED) {\n      let parent = this.parent;\n      while (parent && !parent.isGraphNode()) {\n        parent = parent.parent;\n      }\n      return (parent as GraphNode)?.computedShowState ?? GraphNode.SHOW_DEFAULT;\n    }\n    return this._visible;\n  }\n  get showState() {\n    return this._visible;\n  }\n  set showState(val: number) {\n    this._visible = val;\n  }\n  get computedPickMode(): number {\n    if (this._pickMode === GraphNode.PICK_INHERITED) {\n      let parent = this.parent;\n      while (parent && !parent.isGraphNode()) {\n        parent = parent.parent;\n      }\n      return (parent as GraphNode)?.computedPickMode ?? GraphNode.PICK_DISABLED;\n    }\n    return this._pickMode;\n  }\n  get pickMode(): number {\n    return this._pickMode;\n  }\n  set pickMode(val: number) {\n    this._pickMode = val;\n  }\n  get computedBoundingBoxDrawMode(): number {\n    if (this._boxDrawMode === GraphNode.BBOXDRAW_INHERITED) {\n      let parent = this.parent;\n      while (parent && !parent.isGraphNode()) {\n        parent = parent.parent;\n      }\n      return (parent as GraphNode)?.computedBoundingBoxDrawMode ?? GraphNode.BBOXDRAW_DISABLED;\n    }\n    return this._boxDrawMode;\n  }\n  get boundingBoxDrawMode(): number {\n    return this._boxDrawMode;\n  }\n  set boundingBoxDrawMode(mode: number) {\n    this._boxDrawMode = mode;\n  }\n  isGraphNode(): this is GraphNode {\n    return true;\n  }\n  outsideFrustum(frustum: Frustum | Matrix4x4) {\n    const bv = this.getBoundingVolume();\n    return bv && bv.outsideFrustum(frustum);\n  }\n  getXForm(): XForm {\n    return this;\n  }\n  getBoneMatrices(): Texture2D {\n    return null;\n  }\n  getInvBindMatrix(): Matrix4x4 {\n    return null;\n  }\n  getSortDistance(camera: Camera): number {\n    const cameraWorldMatrix = camera.worldMatrix;\n    const objectWorldMatrix = this.worldMatrix;\n    const dx = cameraWorldMatrix.m03 - objectWorldMatrix.m03;\n    const dy = cameraWorldMatrix.m13 - objectWorldMatrix.m13;\n    const dz = cameraWorldMatrix.m23 - objectWorldMatrix.m23;\n    return dx * dx + dy * dy * dz * dz;\n  }\n  setLastRenderTimestamp(ts: number): void {\n    this._lastRenderTimestamp = ts;\n  }\n  getLastRenderTimeStamp(): number {\n    return this._lastRenderTimestamp;\n  }\n  setLRUIterator(iter: ListIterator<Drawable>) {\n    this._lruIterator = iter;\n  }\n  getLRUIterator(): ListIterator<Drawable> {\n    return this._lruIterator;\n  }\n  isBatchable(): this is BatchDrawable {\n    return false;\n  }\n}\n"],"names":[],"mappings":"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"}
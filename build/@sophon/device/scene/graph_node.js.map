{"version":3,"file":"graph_node.js","sources":["../../../../libs/device/src/scene/graph_node.ts"],"sourcesContent":["import { ListIterator, Frustum, Matrix4x4 } from '@sophon/base';\r\nimport { SceneNode } from './scene_node';\r\nimport type { XForm } from './xform';\r\nimport type { Texture2D } from '../device/gpuobject';\r\nimport type { BatchDrawable, Drawable } from './drawable';\r\nimport type { Scene } from './scene';\r\nimport type { Camera } from './camera';\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nexport class GraphNode extends SceneNode {\r\n  static readonly ORDER_INHERITED = -1;\r\n  static readonly ORDER_BACKGROUND = 0;\r\n  static readonly ORDER_DEFAULT = 32;\r\n  static readonly CLIP_INHERITED = -1;\r\n  static readonly CLIP_DISABLED = 0;\r\n  static readonly CLIP_ENABLED = 1;\r\n  static readonly SHOW_INHERITED = -1;\r\n  static readonly SHOW_HIDE = 0;\r\n  static readonly SHOW_DEFAULT = 1;\r\n  static readonly PICK_INHERITED = -1;\r\n  static readonly PICK_DISABLED = 0;\r\n  static readonly PICK_ENABLED = 1;\r\n  static readonly BBOXDRAW_INHERITED = -1;\r\n  static readonly BBOXDRAW_DISABLED = 0;\r\n  static readonly BBOXDRAW_LOCAL = 1;\r\n  static readonly BBOXDRAW_WORLD = 2;\r\n  /** @internal */\r\n  protected _clipMode: number;\r\n  /** @internal */\r\n  protected _renderOrder: number;\r\n  /** @internal */\r\n  protected _boxDrawMode: number;\r\n  /** @internal */\r\n  protected _visible: number;\r\n  /** @internal */\r\n  protected _pickMode: number;\r\n  /** @internal */\r\n  protected _lastRenderTimestamp: number;\r\n  /** @internal */\r\n  protected _lruIterator: ListIterator<Drawable>;\r\n  constructor(scene: Scene, parent?: SceneNode) {\r\n    super(scene, parent);\r\n    this._clipMode = GraphNode.CLIP_ENABLED;\r\n    this._boxDrawMode = GraphNode.BBOXDRAW_DISABLED;\r\n    this._renderOrder = GraphNode.ORDER_DEFAULT;\r\n    this._visible = GraphNode.SHOW_DEFAULT;\r\n    this._pickMode = GraphNode.PICK_DISABLED;\r\n    this._lastRenderTimestamp = 0;\r\n    this._lruIterator = null;\r\n  }\r\n  get computedRenderOrder() {\r\n    if (this._renderOrder === GraphNode.ORDER_INHERITED) {\r\n      let parent = this.parent;\r\n      while (parent && !parent.isGraphNode()) {\r\n        parent = parent.parent;\r\n      }\r\n      return (parent as GraphNode)?.computedRenderOrder ?? GraphNode.ORDER_DEFAULT;\r\n    }\r\n    return this._renderOrder;\r\n  }\r\n  get renderOrder() {\r\n    return this._renderOrder;\r\n  }\r\n  set renderOrder(val: number) {\r\n    this._renderOrder = val;\r\n  }\r\n  get computedClipMode(): number {\r\n    if (this._clipMode === GraphNode.CLIP_INHERITED) {\r\n      let parent = this.parent;\r\n      while (parent && !parent.isGraphNode()) {\r\n        parent = parent.parent;\r\n      }\r\n      return (parent as GraphNode)?.computedClipMode ?? GraphNode.CLIP_ENABLED;\r\n    }\r\n    return this._clipMode;\r\n  }\r\n  get clipMode(): number {\r\n    return this._clipMode;\r\n  }\r\n  set clipMode(val: number) {\r\n    this._clipMode = val;\r\n  }\r\n  get computedShowState(): number {\r\n    if (this._visible === GraphNode.SHOW_INHERITED) {\r\n      let parent = this.parent;\r\n      while (parent && !parent.isGraphNode()) {\r\n        parent = parent.parent;\r\n      }\r\n      return (parent as GraphNode)?.computedShowState ?? GraphNode.SHOW_DEFAULT;\r\n    }\r\n    return this._visible;\r\n  }\r\n  get showState() {\r\n    return this._visible;\r\n  }\r\n  set showState(val: number) {\r\n    this._visible = val;\r\n  }\r\n  get computedPickMode(): number {\r\n    if (this._pickMode === GraphNode.PICK_INHERITED) {\r\n      let parent = this.parent;\r\n      while (parent && !parent.isGraphNode()) {\r\n        parent = parent.parent;\r\n      }\r\n      return (parent as GraphNode)?.computedPickMode ?? GraphNode.PICK_DISABLED;\r\n    }\r\n    return this._pickMode;\r\n  }\r\n  get pickMode(): number {\r\n    return this._pickMode;\r\n  }\r\n  set pickMode(val: number) {\r\n    this._pickMode = val;\r\n  }\r\n  get computedBoundingBoxDrawMode(): number {\r\n    if (this._boxDrawMode === GraphNode.BBOXDRAW_INHERITED) {\r\n      let parent = this.parent;\r\n      while (parent && !parent.isGraphNode()) {\r\n        parent = parent.parent;\r\n      }\r\n      return (parent as GraphNode)?.computedBoundingBoxDrawMode ?? GraphNode.BBOXDRAW_DISABLED;\r\n    }\r\n    return this._boxDrawMode;\r\n  }\r\n  get boundingBoxDrawMode(): number {\r\n    return this._boxDrawMode;\r\n  }\r\n  set boundingBoxDrawMode(mode: number) {\r\n    this._boxDrawMode = mode;\r\n  }\r\n  isGraphNode(): this is GraphNode {\r\n    return true;\r\n  }\r\n  outsideFrustum(frustum: Frustum | Matrix4x4) {\r\n    const bv = this.getBoundingVolume();\r\n    return bv && bv.outsideFrustum(frustum);\r\n  }\r\n  getXForm(): XForm {\r\n    return this;\r\n  }\r\n  getBoneMatrices(): Texture2D {\r\n    return null;\r\n  }\r\n  getInvBindMatrix(): Matrix4x4 {\r\n    return null;\r\n  }\r\n  getSortDistance(camera: Camera): number {\r\n    const cameraWorldMatrix = camera.worldMatrix;\r\n    const objectWorldMatrix = this.worldMatrix;\r\n    const dx = cameraWorldMatrix.m03 - objectWorldMatrix.m03;\r\n    const dy = cameraWorldMatrix.m13 - objectWorldMatrix.m13;\r\n    const dz = cameraWorldMatrix.m23 - objectWorldMatrix.m23;\r\n    return dx * dx + dy * dy * dz * dz;\r\n  }\r\n  setLastRenderTimestamp(ts: number): void {\r\n    this._lastRenderTimestamp = ts;\r\n  }\r\n  getLastRenderTimeStamp(): number {\r\n    return this._lastRenderTimestamp;\r\n  }\r\n  setLRUIterator(iter: ListIterator<Drawable>) {\r\n    this._lruIterator = iter;\r\n  }\r\n  getLRUIterator(): ListIterator<Drawable> {\r\n    return this._lruIterator;\r\n  }\r\n  isBatchable(): this is BatchDrawable {\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
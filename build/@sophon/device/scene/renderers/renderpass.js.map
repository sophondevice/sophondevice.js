{"version":3,"file":"renderpass.js","sources":["../../../../../libs/device/src/scene/renderers/renderpass.ts"],"sourcesContent":["import { Vector4, Matrix4x4, Quaternion, CubeFace } from '@sophon/base';\nimport { CullVisitor } from '../visitors/cull_visitor';\nimport { RenderQueue } from '../render_queue';\nimport { Material } from '../material';\nimport { RENDER_PASS_TYPE_UNKNOWN } from '../values';\nimport type { Scene } from '../scene';\nimport type { PunctualLight } from '../light';\nimport type { RenderScheme } from './renderscheme';\nimport type { DrawContext } from '../drawable';\nimport type { Camera } from '../camera';\nimport type { Device } from '../../device/device';\nimport type { PBGlobalScope } from '../../device/builder';\nimport type { FrameBuffer, BindGroup } from '../../device/gpuobject';\n\nconst cubeFaceList = [\n  CubeFace.PX,\n  CubeFace.NX,\n  CubeFace.PY,\n  CubeFace.NY,\n  CubeFace.PZ,\n  CubeFace.NZ,\n];\n\nexport type GlobalLightStruct = {\n  positionAndRange: Vector4;\n  directionAndCutoff: Vector4;\n  diffuseAndIntensity: Vector4;\n  viewMatrix: Matrix4x4;\n  viewProjMatrix: Matrix4x4;\n  lightType: number;\n  envLightStrength?: number;\n};\n\nexport abstract class RenderPass {\n  /** @internal */\n  protected _globalBindGroups: { [hash: string]: BindGroup };\n  /** @internal */\n  protected _renderScheme: RenderScheme;\n  /** @internal */\n  protected _name: string;\n  /** @internal */\n  protected _mainCamera: Camera;\n  /** @internal */\n  protected _cullCamera: Camera;\n  /** @internal */\n  protected _renderQueue: RenderQueue;\n  /** @internal */\n  protected _cullVisitor: CullVisitor;\n  /** @internal */\n  protected _clearColor: Vector4;\n  /** @internal */\n  protected _clearDepth: number;\n  /** @internal */\n  protected _clearStencil: number;\n  /** @internal */\n  protected _clearColorEnabled: boolean;\n  /** @internal */\n  protected _clearDepthEnabled: boolean;\n  /** @internal */\n  protected _clearStencilEnabled: boolean;\n  /** @internal */\n  protected _viewport: number[];\n  /** @internal */\n  protected _scissor: number[];\n  /** @internal */\n  protected _errorFlagNoCamera: boolean;\n  /** @internal */\n  protected _verticalFlip: boolean;\n  /** @internal */\n  protected _renderTimeStamp: number;\n  constructor(renderScheme: RenderScheme, name: string) {\n    this._renderScheme = renderScheme;\n    this._name = name;\n    this._mainCamera = null;\n    this._cullCamera = null;\n    this._renderQueue = null;\n    this._clearColor = new Vector4(0, 0, 0, 1);\n    this._clearDepth = 1;\n    this._clearStencil = 0;\n    this._clearColorEnabled = true;\n    this._clearDepthEnabled = true;\n    this._clearStencilEnabled = true;\n    this._globalBindGroups = {};\n    this._cullVisitor = new CullVisitor(this);\n    this._viewport = null;\n    this._scissor = null;\n    this._errorFlagNoCamera = false;\n    this._verticalFlip = false;\n    this._renderTimeStamp = 0;\n  }\n  get name(): string {\n    return this._name;\n  }\n  get renderScheme(): RenderScheme {\n    return this._renderScheme;\n  }\n  get device(): Device {\n    return this._renderScheme.device;\n  }\n  get cullCamera(): Camera {\n    return this._cullCamera;\n  }\n  set cullCamera(camera: Camera) {\n    this._cullCamera = camera;\n  }\n  get mainCamera(): Camera {\n    return this._mainCamera;\n  }\n  get renderQueue(): RenderQueue {\n    return this._renderQueue;\n  }\n  set renderQueue(list: RenderQueue) {\n    this._renderQueue = list;\n  }\n  get clearColor(): Vector4 {\n    return this._clearColor;\n  }\n  set clearColor(color: Vector4) {\n    this._clearColor.assign(color.getArray());\n  }\n  get clearDepth(): number {\n    return this._clearDepth;\n  }\n  set clearDepth(depth: number) {\n    this._clearDepth = depth;\n  }\n  get clearStencil(): number {\n    return this._clearStencil;\n  }\n  set clearStencil(stencil: number) {\n    this._clearStencil = stencil;\n  }\n  get viewport(): number[] {\n    return this._viewport ? [...this._viewport] : null;\n  }\n  set viewport(vp: number[]) {\n    this._viewport = vp ? [...vp] : null;\n  }\n  get scissor(): number[] {\n    return this._scissor ? [...this._scissor] : null;\n  }\n  set scissor(scissor: number[]) {\n    this._scissor = scissor ? [...scissor] : null;\n  }\n  get cullVisitor(): CullVisitor {\n    return this._cullVisitor;\n  }\n  set cullVisitor(visitor: CullVisitor) {\n    this._cullVisitor = visitor;\n  }\n  get verticalFlip(): boolean {\n    return this._verticalFlip;\n  }\n  set verticalFlip(b: boolean) {\n    this._verticalFlip = !!b;\n  }\n  get renderTimeStamp(): number {\n    return this._renderTimeStamp;\n  }\n  getRenderPassType(): number {\n    return RENDER_PASS_TYPE_UNKNOWN;\n  }\n  isAutoFlip(): boolean {\n    return !!(this._renderScheme.device.getFramebuffer() && this._renderScheme.device.getDeviceType() === 'webgpu');\n  }\n  enableClear(color: boolean, depthStencil: boolean) {\n    this._clearColorEnabled = !!color;\n    this._clearDepthEnabled = !!depthStencil;\n    this._clearStencilEnabled = !!depthStencil;\n  }\n  render(scene: Scene, camera: Camera) {\n    this._mainCamera = camera;\n    const device = this._renderScheme.device;\n    this._renderTimeStamp = device.frameInfo.frameTimestamp;\n    const cullCamera = this._cullCamera || camera;\n    this.drawScene(scene, camera, cullCamera, false);\n    this._mainCamera = null;\n  }\n  renderToCubeTexture(scene: Scene, camera: Camera, frameBuffer: FrameBuffer) {\n    this._mainCamera = camera;\n    const device = this._renderScheme.device;\n    this._renderTimeStamp = device.frameInfo.frameTimestamp;\n    const cullCamera = this._cullCamera || camera;\n    const saveRT = device.getFramebuffer();\n    const saveViewport = device.getViewport();\n    const saveScissor = device.getScissor();\n\n    const r = new Quaternion(camera.rotation);\n    const savedProjMatrix = camera.projectionMatrix;\n    const znear = camera.getNearPlane();\n    const zfar = camera.getFarPlane();\n    camera.projectionMatrix = Matrix4x4.perspective(Math.PI / 2, 1, znear, zfar);\n    this._renderScheme.device.setFramebuffer(frameBuffer);\n    for (const face of cubeFaceList) {\n      camera.lookAtCubeFace(face);\n      frameBuffer.setCubeTextureFace(0, face);\n      this.drawScene(scene, camera, cullCamera, false);\n    }\n    camera.rotation = r;\n    camera.projectionMatrix = savedProjMatrix;\n\n    device.setFramebuffer(saveRT);\n    device.setViewport(saveViewport);\n    device.setScissor(saveScissor);\n    this._mainCamera = null;\n  }\n  renderToTexture(scene: Scene, camera: Camera, frameBuffer: FrameBuffer) {\n    this._mainCamera = camera;\n    const device = this._renderScheme.device;\n    this._renderTimeStamp = device.frameInfo.frameTimestamp;\n    const cullCamera = this._cullCamera || camera;\n    const saveRT = device.getFramebuffer();\n    const saveViewport = device.getViewport();\n    const saveScissor = device.getScissor();\n    this._renderScheme.device.setFramebuffer(frameBuffer);\n    this.drawScene(scene, camera, cullCamera, false);\n    this._renderScheme.device.setFramebuffer(saveRT);\n    device.setFramebuffer(saveRT);\n    device.setViewport(saveViewport);\n    device.setScissor(saveScissor);\n    this._mainCamera = null;\n  }\n  /** @internal */\n  protected getGlobalBindGroup(ctx: DrawContext): BindGroup {\n    const hash = this.getGlobalBindGroupHash(ctx);\n    let bindGroup = this._globalBindGroups[hash];\n    if (!bindGroup) {\n      const that = this;\n      const pb = this.device.createProgramBuilder();\n      const ret = pb.buildRender({\n        vertex() {\n          that.setGlobalBindings(this, ctx);\n          this.$mainFunc(function () {\n          });\n        },\n        fragment() {\n          that.setGlobalBindings(this, ctx);\n          this.$mainFunc(function () {\n          });\n        }\n      });\n      bindGroup = this.device.createBindGroup(ret[2][0]);\n      this._globalBindGroups[hash] = bindGroup;\n    }\n    if (bindGroup.disposed) {\n      bindGroup.reload();\n    }\n    return bindGroup;\n  }\n  dispose() {\n    for (const k in this._globalBindGroups) {\n      Material.bindGroupGarbageCollect(this._globalBindGroups[k]);\n    }\n    this._globalBindGroups = {};\n  }\n  /** @internal */\n  getGlobalBindGroupHash(ctx: DrawContext) {\n    return `${this.constructor.name}:${this._getGlobalBindGroupHash(ctx)}`;\n  }\n  /** @internal */\n  abstract setGlobalBindings(scope: PBGlobalScope, ctx: DrawContext);\n  /** @internal */\n  protected abstract _getGlobalBindGroupHash(ctx: DrawContext);\n  /** @internal */\n  protected setCameraUniforms(bindGroup: BindGroup, ctx: DrawContext, flip: boolean) {\n    const cameraStruct = {\n      position: ctx.camera.worldMatrix.getRow(3).xyz(),\n      viewProjectionMatrix: ctx.camera.viewProjectionMatrix,\n      viewMatrix: ctx.camera.viewMatrix,\n      projectionMatrix: ctx.camera.projectionMatrix,\n      params: new Vector4(ctx.camera.getNearPlane(), ctx.camera.getFarPlane(), flip ? 1 : 0, ctx.camera.linearOutputEnabled ? 0 : 1)\n    };\n    bindGroup.setValue('global', {\n      camera: cameraStruct\n    });\n  }\n  /** @internal */\n  protected drawSceneToTexture(scene: Scene, renderCamera: Camera, cullCamera: Camera, target: FrameBuffer, forceCull: boolean) {\n    this._renderScheme.device.setFramebuffer(target);\n    this.drawScene(scene, renderCamera, cullCamera, forceCull);\n    this._renderScheme.device.setFramebuffer(null);\n  }\n  /** @internal */\n  protected drawSceneToCubeTexture(scene: Scene, renderCamera: Camera, target: FrameBuffer) {\n    const r = new Quaternion(renderCamera.rotation);\n    const savedProjMatrix = renderCamera.projectionMatrix;\n    const znear = renderCamera.getNearPlane();\n    const zfar = renderCamera.getFarPlane();\n    renderCamera.projectionMatrix = Matrix4x4.perspective(Math.PI / 2, 1, znear, zfar);\n    for (const face of cubeFaceList) {\n      renderCamera.lookAtCubeFace(face);\n      target.setCubeTextureFace(0, face);\n      this.drawSceneToTexture(scene, renderCamera, renderCamera, target, true);\n    }\n    renderCamera.rotation = r;\n    renderCamera.projectionMatrix = savedProjMatrix;\n  }\n  /** @internal */\n  protected abstract renderItems(camera: Camera, renderQueue: RenderQueue, lightList: PunctualLight[]);\n  /** @internal */\n  protected drawScene(scene: Scene, renderCamera: Camera, cullCamera: Camera, forceCull: boolean) {\n    const device = this._renderScheme.device;\n    device.setViewport(this._viewport);\n    device.setScissor(this._scissor);\n    this.clearFramebuffer();\n    if (scene) {\n      const renderQueue = this.cullScene(scene, cullCamera, forceCull);\n      if (renderQueue) {\n        const windingReversed = device.isWindingOrderReversed();\n        device.reverseVertexWindingOrder(this._verticalFlip !== this.isAutoFlip());\n        renderCamera.enableLinearOutput(!!device.getFramebuffer()?.getColorAttachments()[0]);\n        this.renderItems(renderCamera, renderQueue, scene.lightList);\n        device.reverseVertexWindingOrder(windingReversed);\n      }\n    }\n  }\n  cullScene(scene: Scene, cullCamera: Camera, force: boolean): RenderQueue {\n    if (this._renderQueue && !force) {\n      return this._renderQueue;\n    } else {\n      if (cullCamera) {\n        this._cullVisitor.renderQueue.clear();\n        this._cullVisitor.camera = cullCamera;\n        if (scene.octree) {\n          scene.octree.getRootNode().traverse(this._cullVisitor);\n        } else {\n          scene.rootNode.traverse(this._cullVisitor);\n        }\n        return this._cullVisitor.renderQueue;\n      }\n    }\n    return null;\n  }\n  /** @internal */\n  private clearFramebuffer() {\n    const clearColor = this._clearColorEnabled ? this._clearColor : null;\n    const clearDepth = this._clearDepthEnabled ? this._clearDepth : null;\n    const clearStencil = this._clearStencilEnabled ? this._clearStencil : null;\n    this._renderScheme.device.clearFrameBuffer(clearColor, clearDepth, clearStencil);\n  }\n}\n"],"names":[],"mappings":"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"}
{"version":3,"file":"renderpass.js","sources":["../../../../../libs/device/src/scene/renderers/renderpass.ts"],"sourcesContent":["import { Vector4, Matrix4x4, Quaternion, CubeFace } from '@sophon/base';\r\nimport { CullVisitor } from '../visitors/cull_visitor';\r\nimport { RenderQueue } from '../render_queue';\r\nimport { Material } from '../material';\r\nimport { RENDER_PASS_TYPE_UNKNOWN } from '../values';\r\nimport type { Scene } from '../scene';\r\nimport type { PunctualLight } from '../light';\r\nimport type { RenderScheme } from './renderscheme';\r\nimport type { DrawContext } from '../drawable';\r\nimport type { Camera } from '../camera';\r\nimport type { Device } from '../../device/device';\r\nimport type { PBGlobalScope } from '../../device/builder';\r\nimport type { FrameBuffer, BindGroup } from '../../device/gpuobject';\r\n\r\nconst cubeFaceList = [\r\n  CubeFace.PX,\r\n  CubeFace.NX,\r\n  CubeFace.PY,\r\n  CubeFace.NY,\r\n  CubeFace.PZ,\r\n  CubeFace.NZ,\r\n];\r\n\r\nexport type GlobalLightStruct = {\r\n  positionAndRange: Vector4;\r\n  directionAndCutoff: Vector4;\r\n  diffuseAndIntensity: Vector4;\r\n  viewMatrix: Matrix4x4;\r\n  viewProjMatrix: Matrix4x4;\r\n  lightType: number;\r\n  envLightStrength?: number;\r\n};\r\n\r\nexport abstract class RenderPass {\r\n  /** @internal */\r\n  protected _globalBindGroups: { [hash: string]: BindGroup };\r\n  /** @internal */\r\n  protected _renderScheme: RenderScheme;\r\n  /** @internal */\r\n  protected _name: string;\r\n  /** @internal */\r\n  protected _mainCamera: Camera;\r\n  /** @internal */\r\n  protected _cullCamera: Camera;\r\n  /** @internal */\r\n  protected _renderQueue: RenderQueue;\r\n  /** @internal */\r\n  protected _cullVisitor: CullVisitor;\r\n  /** @internal */\r\n  protected _clearColor: Vector4;\r\n  /** @internal */\r\n  protected _clearDepth: number;\r\n  /** @internal */\r\n  protected _clearStencil: number;\r\n  /** @internal */\r\n  protected _clearColorEnabled: boolean;\r\n  /** @internal */\r\n  protected _clearDepthEnabled: boolean;\r\n  /** @internal */\r\n  protected _clearStencilEnabled: boolean;\r\n  /** @internal */\r\n  protected _viewport: number[];\r\n  /** @internal */\r\n  protected _scissor: number[];\r\n  /** @internal */\r\n  protected _errorFlagNoCamera: boolean;\r\n  /** @internal */\r\n  protected _verticalFlip: boolean;\r\n  /** @internal */\r\n  protected _renderTimeStamp: number;\r\n  constructor(renderScheme: RenderScheme, name: string) {\r\n    this._renderScheme = renderScheme;\r\n    this._name = name;\r\n    this._mainCamera = null;\r\n    this._cullCamera = null;\r\n    this._renderQueue = null;\r\n    this._clearColor = new Vector4(0, 0, 0, 1);\r\n    this._clearDepth = 1;\r\n    this._clearStencil = 0;\r\n    this._clearColorEnabled = true;\r\n    this._clearDepthEnabled = true;\r\n    this._clearStencilEnabled = true;\r\n    this._globalBindGroups = {};\r\n    this._cullVisitor = new CullVisitor(this);\r\n    this._viewport = null;\r\n    this._scissor = null;\r\n    this._errorFlagNoCamera = false;\r\n    this._verticalFlip = false;\r\n    this._renderTimeStamp = 0;\r\n  }\r\n  get name(): string {\r\n    return this._name;\r\n  }\r\n  get renderScheme(): RenderScheme {\r\n    return this._renderScheme;\r\n  }\r\n  get device(): Device {\r\n    return this._renderScheme.device;\r\n  }\r\n  get cullCamera(): Camera {\r\n    return this._cullCamera;\r\n  }\r\n  set cullCamera(camera: Camera) {\r\n    this._cullCamera = camera;\r\n  }\r\n  get mainCamera(): Camera {\r\n    return this._mainCamera;\r\n  }\r\n  get renderQueue(): RenderQueue {\r\n    return this._renderQueue;\r\n  }\r\n  set renderQueue(list: RenderQueue) {\r\n    this._renderQueue = list;\r\n  }\r\n  get clearColor(): Vector4 {\r\n    return this._clearColor;\r\n  }\r\n  set clearColor(color: Vector4) {\r\n    this._clearColor.assign(color.getArray());\r\n  }\r\n  get clearDepth(): number {\r\n    return this._clearDepth;\r\n  }\r\n  set clearDepth(depth: number) {\r\n    this._clearDepth = depth;\r\n  }\r\n  get clearStencil(): number {\r\n    return this._clearStencil;\r\n  }\r\n  set clearStencil(stencil: number) {\r\n    this._clearStencil = stencil;\r\n  }\r\n  get viewport(): number[] {\r\n    return this._viewport ? [...this._viewport] : null;\r\n  }\r\n  set viewport(vp: number[]) {\r\n    this._viewport = vp ? [...vp] : null;\r\n  }\r\n  get scissor(): number[] {\r\n    return this._scissor ? [...this._scissor] : null;\r\n  }\r\n  set scissor(scissor: number[]) {\r\n    this._scissor = scissor ? [...scissor] : null;\r\n  }\r\n  get cullVisitor(): CullVisitor {\r\n    return this._cullVisitor;\r\n  }\r\n  set cullVisitor(visitor: CullVisitor) {\r\n    this._cullVisitor = visitor;\r\n  }\r\n  get verticalFlip(): boolean {\r\n    return this._verticalFlip;\r\n  }\r\n  set verticalFlip(b: boolean) {\r\n    this._verticalFlip = !!b;\r\n  }\r\n  get renderTimeStamp(): number {\r\n    return this._renderTimeStamp;\r\n  }\r\n  getRenderPassType(): number {\r\n    return RENDER_PASS_TYPE_UNKNOWN;\r\n  }\r\n  isAutoFlip(): boolean {\r\n    return !!(this._renderScheme.device.getFramebuffer() && this._renderScheme.device.getDeviceType() === 'webgpu');\r\n  }\r\n  enableClear(color: boolean, depthStencil: boolean) {\r\n    this._clearColorEnabled = !!color;\r\n    this._clearDepthEnabled = !!depthStencil;\r\n    this._clearStencilEnabled = !!depthStencil;\r\n  }\r\n  render(scene: Scene, camera: Camera) {\r\n    this._mainCamera = camera;\r\n    const device = this._renderScheme.device;\r\n    this._renderTimeStamp = device.frameInfo.frameTimestamp;\r\n    const cullCamera = this._cullCamera || camera;\r\n    this.drawScene(scene, camera, cullCamera, false);\r\n    this._mainCamera = null;\r\n  }\r\n  renderToCubeTexture(scene: Scene, camera: Camera, frameBuffer: FrameBuffer) {\r\n    this._mainCamera = camera;\r\n    const device = this._renderScheme.device;\r\n    this._renderTimeStamp = device.frameInfo.frameTimestamp;\r\n    const cullCamera = this._cullCamera || camera;\r\n    const saveRT = device.getFramebuffer();\r\n    const saveViewport = device.getViewport();\r\n    const saveScissor = device.getScissor();\r\n\r\n    const r = new Quaternion(camera.rotation);\r\n    const savedProjMatrix = camera.projectionMatrix;\r\n    const znear = camera.getNearPlane();\r\n    const zfar = camera.getFarPlane();\r\n    camera.projectionMatrix = Matrix4x4.perspective(Math.PI / 2, 1, znear, zfar);\r\n    this._renderScheme.device.setFramebuffer(frameBuffer);\r\n    for (const face of cubeFaceList) {\r\n      camera.lookAtCubeFace(face);\r\n      frameBuffer.setCubeTextureFace(0, face);\r\n      this.drawScene(scene, camera, cullCamera, false);\r\n    }\r\n    camera.rotation = r;\r\n    camera.projectionMatrix = savedProjMatrix;\r\n\r\n    device.setFramebuffer(saveRT);\r\n    device.setViewport(saveViewport);\r\n    device.setScissor(saveScissor);\r\n    this._mainCamera = null;\r\n  }\r\n  renderToTexture(scene: Scene, camera: Camera, frameBuffer: FrameBuffer) {\r\n    this._mainCamera = camera;\r\n    const device = this._renderScheme.device;\r\n    this._renderTimeStamp = device.frameInfo.frameTimestamp;\r\n    const cullCamera = this._cullCamera || camera;\r\n    const saveRT = device.getFramebuffer();\r\n    const saveViewport = device.getViewport();\r\n    const saveScissor = device.getScissor();\r\n    this._renderScheme.device.setFramebuffer(frameBuffer);\r\n    this.drawScene(scene, camera, cullCamera, false);\r\n    this._renderScheme.device.setFramebuffer(saveRT);\r\n    device.setFramebuffer(saveRT);\r\n    device.setViewport(saveViewport);\r\n    device.setScissor(saveScissor);\r\n    this._mainCamera = null;\r\n  }\r\n  /** @internal */\r\n  protected getGlobalBindGroup(ctx: DrawContext): BindGroup {\r\n    const hash = this.getGlobalBindGroupHash(ctx);\r\n    let bindGroup = this._globalBindGroups[hash];\r\n    if (!bindGroup) {\r\n      const that = this;\r\n      const pb = this.device.createProgramBuilder();\r\n      const ret = pb.buildRender({\r\n        vertex() {\r\n          that.setGlobalBindings(this, ctx);\r\n          this.$mainFunc(function () {\r\n          });\r\n        },\r\n        fragment() {\r\n          that.setGlobalBindings(this, ctx);\r\n          this.$mainFunc(function () {\r\n          });\r\n        }\r\n      });\r\n      bindGroup = this.device.createBindGroup(ret[2][0]);\r\n      this._globalBindGroups[hash] = bindGroup;\r\n    }\r\n    if (bindGroup.disposed) {\r\n      bindGroup.reload();\r\n    }\r\n    return bindGroup;\r\n  }\r\n  dispose() {\r\n    for (const k in this._globalBindGroups) {\r\n      Material.bindGroupGarbageCollect(this._globalBindGroups[k]);\r\n    }\r\n    this._globalBindGroups = {};\r\n  }\r\n  /** @internal */\r\n  getGlobalBindGroupHash(ctx: DrawContext) {\r\n    return `${this.constructor.name}:${this._getGlobalBindGroupHash(ctx)}`;\r\n  }\r\n  /** @internal */\r\n  abstract setGlobalBindings(scope: PBGlobalScope, ctx: DrawContext);\r\n  /** @internal */\r\n  protected abstract _getGlobalBindGroupHash(ctx: DrawContext);\r\n  /** @internal */\r\n  protected setCameraUniforms(bindGroup: BindGroup, ctx: DrawContext, flip: boolean) {\r\n    const cameraStruct = {\r\n      position: ctx.camera.worldMatrix.getRow(3).xyz(),\r\n      viewProjectionMatrix: ctx.camera.viewProjectionMatrix,\r\n      viewMatrix: ctx.camera.viewMatrix,\r\n      projectionMatrix: ctx.camera.projectionMatrix,\r\n      params: new Vector4(ctx.camera.getNearPlane(), ctx.camera.getFarPlane(), flip ? 1 : 0, ctx.camera.linearOutputEnabled ? 0 : 1)\r\n    };\r\n    bindGroup.setValue('global', {\r\n      camera: cameraStruct\r\n    });\r\n  }\r\n  /** @internal */\r\n  protected drawSceneToTexture(scene: Scene, renderCamera: Camera, cullCamera: Camera, target: FrameBuffer, forceCull: boolean) {\r\n    this._renderScheme.device.setFramebuffer(target);\r\n    this.drawScene(scene, renderCamera, cullCamera, forceCull);\r\n    this._renderScheme.device.setFramebuffer(null);\r\n  }\r\n  /** @internal */\r\n  protected drawSceneToCubeTexture(scene: Scene, renderCamera: Camera, target: FrameBuffer) {\r\n    const r = new Quaternion(renderCamera.rotation);\r\n    const savedProjMatrix = renderCamera.projectionMatrix;\r\n    const znear = renderCamera.getNearPlane();\r\n    const zfar = renderCamera.getFarPlane();\r\n    renderCamera.projectionMatrix = Matrix4x4.perspective(Math.PI / 2, 1, znear, zfar);\r\n    for (const face of cubeFaceList) {\r\n      renderCamera.lookAtCubeFace(face);\r\n      target.setCubeTextureFace(0, face);\r\n      this.drawSceneToTexture(scene, renderCamera, renderCamera, target, true);\r\n    }\r\n    renderCamera.rotation = r;\r\n    renderCamera.projectionMatrix = savedProjMatrix;\r\n  }\r\n  /** @internal */\r\n  protected abstract renderItems(camera: Camera, renderQueue: RenderQueue, lightList: PunctualLight[]);\r\n  /** @internal */\r\n  protected drawScene(scene: Scene, renderCamera: Camera, cullCamera: Camera, forceCull: boolean) {\r\n    const device = this._renderScheme.device;\r\n    device.setViewport(this._viewport);\r\n    device.setScissor(this._scissor);\r\n    this.clearFramebuffer();\r\n    if (scene) {\r\n      const renderQueue = this.cullScene(scene, cullCamera, forceCull);\r\n      if (renderQueue) {\r\n        const windingReversed = device.isWindingOrderReversed();\r\n        device.reverseVertexWindingOrder(this._verticalFlip !== this.isAutoFlip());\r\n        renderCamera.enableLinearOutput(!!device.getFramebuffer()?.getColorAttachments()[0]);\r\n        this.renderItems(renderCamera, renderQueue, scene.lightList);\r\n        device.reverseVertexWindingOrder(windingReversed);\r\n      }\r\n    }\r\n  }\r\n  cullScene(scene: Scene, cullCamera: Camera, force: boolean): RenderQueue {\r\n    if (this._renderQueue && !force) {\r\n      return this._renderQueue;\r\n    } else {\r\n      if (cullCamera) {\r\n        this._cullVisitor.renderQueue.clear();\r\n        this._cullVisitor.camera = cullCamera;\r\n        if (scene.octree) {\r\n          scene.octree.getRootNode().traverse(this._cullVisitor);\r\n        } else {\r\n          scene.rootNode.traverse(this._cullVisitor);\r\n        }\r\n        return this._cullVisitor.renderQueue;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n  /** @internal */\r\n  private clearFramebuffer() {\r\n    const clearColor = this._clearColorEnabled ? this._clearColor : null;\r\n    const clearDepth = this._clearDepthEnabled ? this._clearDepth : null;\r\n    const clearStencil = this._clearStencilEnabled ? this._clearStencil : null;\r\n    this._renderScheme.device.clearFrameBuffer(clearColor, clearDepth, clearStencil);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
{"version":3,"file":"scene.js","sources":["../../../../libs/device/src/scene/scene.ts"],"sourcesContent":["import { REventTarget, REvent, Vector3, Vector4, Matrix4x4, Ray, AABB } from '@sophon/base';\r\nimport { XFormChangeEvent } from './xform';\r\nimport { Device, TextureCube } from '../device';\r\nimport { SkyboxMaterial } from './materiallib';\r\nimport { SceneNode, SceneNodeAttachEvent } from './scene_node';\r\nimport { BoxMesh } from './mesh';\r\nimport { Camera } from './camera';\r\nimport { Octree } from './octree';\r\nimport { OctreeUpdateVisitor } from './visitors';\r\nimport { Material } from './material';\r\nimport { GraphNode } from './graph_node';\r\nimport { RaycastVisitor } from './visitors/raycast_visitor';\r\nimport type { PunctualLight } from './light';\r\nimport type { EnvironmentLighting } from './materiallib/envlight';\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-namespace\r\nexport class Scene extends REventTarget {\r\n  /** @internal */\r\n  private static _nextId = 0;\r\n  /** @internal */\r\n  protected _device: Device;\r\n  /** @internal */\r\n  protected _rootNode: SceneNode;\r\n  /** @internal */\r\n  protected _octree: Octree;\r\n  /** @internal */\r\n  protected _cameraList: Camera[];\r\n  /** @internal */\r\n  protected _lightList: PunctualLight[];\r\n  /** @internal */\r\n  protected _xformChangedList: Set<SceneNode>;\r\n  /** @internal */\r\n  protected _bvChangedList: Set<SceneNode>;\r\n  /** @internal */\r\n  protected _environmentLighting: EnvironmentLighting;\r\n  /** @internal */\r\n  protected _envLightStrength: number;\r\n  /** @internal */\r\n  protected _tickEvent: Scene.TickEvent;\r\n  /** @internal */\r\n  protected _updateFrame: number;\r\n  /** @internal */\r\n  protected _id: number;\r\n  constructor(device: Device) {\r\n    super();\r\n    this._id = ++Scene._nextId;\r\n    this._device = device;\r\n    this._rootNode = new SceneNode(this, null);\r\n    this._octree = new Octree(this, 2048, 64);\r\n    this._cameraList = [];\r\n    this._lightList = [];\r\n    this._xformChangedList = new Set();\r\n    this._bvChangedList = new Set();\r\n    this._environmentLighting = null;\r\n    this._envLightStrength = 1;\r\n    this._tickEvent = new Scene.TickEvent(this);\r\n    this._updateFrame = -1;\r\n    this.addDefaultEventListener(XFormChangeEvent.NAME, (evt: REvent) => {\r\n      const e = evt as XFormChangeEvent;\r\n      this._xformChanged(e.xform as SceneNode);\r\n    });\r\n    this.addDefaultEventListener(SceneNodeAttachEvent.ATTACHED_NAME, (evt: REvent) => {\r\n      const e = evt as SceneNodeAttachEvent;\r\n      this._xformChanged(e.node);\r\n      if (e.node.isCamera()) {\r\n        this._addCamera(e.node);\r\n      } else if (e.node.isLight() && e.node.isPunctualLight()) {\r\n        this._addLight(e.node);\r\n      }\r\n      if (this.octree) {\r\n        this.octree.placeNode(e.node);\r\n      }\r\n    });\r\n    this.addDefaultEventListener(SceneNodeAttachEvent.DETACHED_NAME, (evt: REvent) => {\r\n      const e = evt as SceneNodeAttachEvent;\r\n      this._xformChangedRemove(e.node);\r\n      this._bvChangedRemove(e.node);\r\n      if (this.octree) {\r\n        this.octree.removeNode(e.node);\r\n      }\r\n      if (e.node.isCamera()) {\r\n        this._removeCamera(e.node);\r\n      } else if (e.node.isLight() && e.node.isPunctualLight()) {\r\n        this._removeLight(e.node);\r\n      }\r\n    });\r\n  }\r\n  get id(): number {\r\n    return this._id;\r\n  }\r\n  get device() {\r\n    return this._device;\r\n  }\r\n  get rootNode() {\r\n    return this._rootNode;\r\n  }\r\n  get octree(): Octree {\r\n    return this._octree;\r\n  }\r\n  get cameraList(): Camera[] {\r\n    return this._cameraList;\r\n  }\r\n  get lightList(): PunctualLight[] {\r\n    return this._lightList;\r\n  }\r\n  get boundingBox(): AABB {\r\n    this._syncBVChangedList();\r\n    return this._octree.getRootNode().getBox() || this._octree.getRootNode().getBoxLoosed();\r\n  }\r\n  get environment(): EnvironmentLighting {\r\n    return this._environmentLighting;\r\n  }\r\n  set environment(env: EnvironmentLighting) {\r\n    this._environmentLighting = env;\r\n  }\r\n  get envHash(): string {\r\n    return this._environmentLighting?.constructor.name || '';\r\n  }\r\n  get envLightStrength(): number {\r\n    return this._envLightStrength;\r\n  }\r\n  set envLightStrength(val: number) {\r\n    this._envLightStrength = val;\r\n  }\r\n  dispose() {\r\n    this._device = null;\r\n    this._rootNode = null;\r\n  }\r\n  addSkybox(skyTexture: TextureCube): SceneNode {\r\n    const material = new SkyboxMaterial(this._device);\r\n    material.skyCubeMap = skyTexture;\r\n    const sky = new BoxMesh(this, {\r\n      size: 4,\r\n      pivotX: 0.5,\r\n      pivotY: 0.5,\r\n      pivotZ: 0.5,\r\n      material: material\r\n    });\r\n    sky.clipMode = GraphNode.CLIP_DISABLED;\r\n    sky.renderOrder = GraphNode.ORDER_BACKGROUND;\r\n    sky.pickMode = GraphNode.PICK_DISABLED;\r\n    return sky;\r\n  }\r\n  addCamera(matrix?: Matrix4x4): Camera {\r\n    return new Camera(this, matrix || Matrix4x4.perspective(Math.PI / 3, this._device.getDrawingBufferWidth() / this._device.getDrawingBufferHeight(), 1, 100));\r\n  }\r\n  raycast(camera: Camera, screenX: number, screenY: number): GraphNode {\r\n    const viewport = this.device.getViewport();\r\n    const ray = this.constructRay(camera, viewport[2], viewport[3], screenX, screenY);\r\n    const raycastVisitor = new RaycastVisitor(ray);\r\n    this.octree.getRootNode().traverse(raycastVisitor);\r\n    return raycastVisitor.intersected;\r\n  }\r\n  constructRay(\r\n    camera: Camera,\r\n    viewportWidth: number,\r\n    viewportHeight: number,\r\n    screenX: number,\r\n    screenY: number,\r\n    invModelMatrix?: Matrix4x4,\r\n  ): Ray {\r\n    const vClip = new Vector4(\r\n      (2 * screenX) / viewportWidth - 1,\r\n      1 - (2 * screenY) / viewportHeight,\r\n      1,\r\n      1,\r\n    );\r\n    const vWorld = camera.invViewProjectionMatrix.transform(vClip);\r\n    vWorld.scaleBy(1 / vWorld.w);\r\n    let vEye = camera.worldMatrix.getRow(3).xyz();\r\n    let vDir = Vector3.sub(vWorld.xyz(), vEye).inplaceNormalize();\r\n    if (invModelMatrix) {\r\n      vEye = invModelMatrix.transformPointAffine(vEye);\r\n      vDir = invModelMatrix.transformVectorAffine(vDir);\r\n    }\r\n    return new Ray(vEye, vDir);\r\n  }\r\n  /** @internal */\r\n  _addLight(node: PunctualLight) {\r\n    if (node && node.isLight() && this._lightList.indexOf(node) < 0) {\r\n      this._lightList.push(node);\r\n    }\r\n  }\r\n  /** @internal */\r\n  _removeLight(node: PunctualLight) {\r\n    const index = this._lightList.indexOf(node);\r\n    if (index >= 0) {\r\n      this._lightList.splice(index, 1);\r\n    }\r\n  }\r\n  /** @internal */\r\n  _addCamera(node: Camera) {\r\n    if (node && node.isCamera() && this._cameraList.indexOf(node) < 0) {\r\n      this._cameraList.push(node);\r\n    }\r\n  }\r\n  /** @internal */\r\n  _removeCamera(node: Camera) {\r\n    const index = this._cameraList.indexOf(node);\r\n    if (index >= 0) {\r\n      this._cameraList.splice(index, 1);\r\n    }\r\n  }\r\n  /** @internal */\r\n  _xformChanged(node: SceneNode) {\r\n    if (node) {\r\n      !this._xformChangedList.has(node) && this._xformChangedList.add(node);\r\n      !this._bvChangedList.has(node) && this._bvChangedList.add(node);\r\n    }\r\n  }\r\n  /** @internal */\r\n  _xformChangedRemove(node: SceneNode) {\r\n    if (node) {\r\n      if (this._xformChangedList.has(node)) {\r\n        this._xformChangedList.delete(node);\r\n      }\r\n      for (const child of node.children) {\r\n        this._xformChangedRemove(child);\r\n      }\r\n    }\r\n  }\r\n  /** @internal */\r\n  _bvChanged(node: SceneNode) {\r\n    node && !this._bvChangedList.has(node) && this._bvChangedList.add(node);\r\n  }\r\n  /** @internal */\r\n  _bvChangedRemove(node: SceneNode) {\r\n    if (this._bvChangedList.has(node)) {\r\n      this._bvChangedList.delete(node);\r\n    }\r\n  }\r\n  frameUpdate(camera: Camera) {\r\n    const frameInfo = this._device.frameInfo;\r\n    if (frameInfo.frameCounter !== this._updateFrame) {\r\n      this._updateFrame = frameInfo.frameCounter;\r\n      // uniform buffer garbage collect\r\n      if (!Material.getGCOptions().disabled) {\r\n        Material.garbageCollect(frameInfo.frameTimestamp);\r\n      }\r\n      // update scene objects first\r\n      this._tickEvent.reset();\r\n      this._tickEvent.camera = camera;\r\n      this.dispatchEvent(this._tickEvent);\r\n      this._syncXFormChangedList();\r\n      this._syncBVChangedList();\r\n      camera.frameUpdate();\r\n    }\r\n  }\r\n  /** @internal */\r\n  private _syncXFormChangedList() {\r\n    const that = this;\r\n    function syncNodeXForm(node: SceneNode, checkAttach: boolean) {\r\n      if (!checkAttach || node.attached) {\r\n        if (that.octree && node.isGraphNode()) {\r\n          that.octree.placeNode(node);\r\n        }\r\n        if (node.isPunctualLight()) {\r\n          node.invalidateUniforms();\r\n        }\r\n        for (const child of node.children) {\r\n          syncNodeXForm(child, false);\r\n        }\r\n        if (that._xformChangedList.has(node)) {\r\n          that._xformChangedList.delete(node);\r\n        }\r\n      } else {\r\n        that._xformChangedList.delete(node);\r\n      }\r\n    }\r\n    while (this._xformChangedList.size > 0) {\r\n      syncNodeXForm(this._xformChangedList.keys().next().value, true);\r\n    }\r\n  }\r\n  /** @internal */\r\n  private _syncNodeBV(node: SceneNode) {\r\n    if (this.octree && node.isGraphNode() && node.attached) {\r\n      this.octree.placeNode(node);\r\n    }\r\n    this._bvChangedList.delete(node);\r\n  }\r\n  /** @internal */\r\n  private _syncBVChangedList() {\r\n    if (this._bvChangedList.size > 0) {\r\n      while (this._bvChangedList.size > 0) {\r\n        this._syncNodeBV(this._bvChangedList.keys().next().value);\r\n      }\r\n      const worldBox = this.boundingBox;\r\n      const rootBox = new AABB(this._octree.getRootNode().getBoxLoosed());\r\n      let rootSize = this._octree.getRootSize();\r\n      while (!rootBox.containsBox(worldBox)) {\r\n        rootSize *= 2;\r\n        rootBox.minPoint.scaleBy(2);\r\n        rootBox.maxPoint.scaleBy(2);\r\n      }\r\n      if (rootSize > this._octree.getRootSize()) {\r\n        this._octree.initialize(rootSize, this._octree.getLeafSize());\r\n        const v = new OctreeUpdateVisitor(this._octree);\r\n        this._rootNode.traverse(v);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-namespace\r\nexport namespace Scene {\r\n  export class TickEvent extends REvent {\r\n    static readonly NAME = 'tick';\r\n    camera: Camera;\r\n    scene: Scene;\r\n    constructor(scene: Scene) {\r\n      super(TickEvent.NAME, false, false);\r\n      this.scene = scene;\r\n      this.camera = null;\r\n    }\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}
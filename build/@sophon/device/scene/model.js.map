{"version":3,"file":"model.js","sources":["../../../../libs/device/src/scene/model.ts"],"sourcesContent":["import { REvent } from '@sophon/base';\r\nimport { AnimationClip } from './animation';\r\nimport { GraphNode } from './graph_node';\r\nimport type { Scene } from './scene';\r\nimport type { Camera } from './camera';\r\n\r\nexport class Model extends GraphNode {\r\n  /** @internal */\r\n  private _animations: { [name: string]: AnimationClip };\r\n  /** @internal */\r\n  private _animationIndex: number;\r\n  /** @internal */\r\n  private _updateCallback: (evt: REvent) => void;\r\n  constructor(scene: Scene) {\r\n    super(scene);\r\n    this._animations = {};\r\n    this._animationIndex = 0;\r\n    this._updateCallback = (evt: REvent) => {\r\n      if (this.attached) {\r\n        this.update((evt as Scene.TickEvent).camera);\r\n      }\r\n    };\r\n  }\r\n  addAnimation(name?: string): AnimationClip {\r\n    if (!name) {\r\n      for (; ;) {\r\n        name = `animation${this._animationIndex++}`;\r\n        if (!this._animationIndex[name]) {\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    if (this._animations[name]) {\r\n      console.error(`Model.addAnimation() failed: animation '${name}' already exists`);\r\n      return null;\r\n    } else {\r\n      const ani = new AnimationClip(name, this);\r\n      this._animations[name] = ani;\r\n      return ani;\r\n    }\r\n  }\r\n  removeAnimation(name: string) {\r\n    this.stopAnimation(name);\r\n    delete this._animations[name];\r\n  }\r\n  getAnimationNames(): string[] {\r\n    return Object.keys(this._animations);\r\n  }\r\n  update(camera: Camera) {\r\n    for (const k in this._animations) {\r\n      this._animations[k].update();\r\n    }\r\n  }\r\n  isPlayingAnimation(name?: string) {\r\n    if (name) {\r\n      return this._animations[name]?.isPlaying();\r\n    } else {\r\n      for (const k in this._animations) {\r\n        if (this._animations[k].isPlaying()) {\r\n          return true;\r\n        }\r\n      }\r\n      return false;\r\n    }\r\n  }\r\n  playAnimation(name: string, repeat = 1) {\r\n    const isPlaying = this.isPlayingAnimation();\r\n    const ani = this._animations[name];\r\n    if (ani && !ani.isPlaying()) {\r\n      ani.repeat = repeat;\r\n      ani.play();\r\n    }\r\n    if (!isPlaying && this.isPlayingAnimation()) {\r\n      this.scene.addEventListener('tick', this._updateCallback);\r\n    }\r\n  }\r\n  stopAnimation(name: string) {\r\n    const isPlaying = this.isPlayingAnimation();\r\n    this._animations[name]?.stop();\r\n    if (isPlaying && !this.isPlayingAnimation()) {\r\n      this.scene.removeEventListener('tick', this._updateCallback);\r\n    }\r\n  }\r\n\r\n}\r\n"],"names":[],"mappings":"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"}
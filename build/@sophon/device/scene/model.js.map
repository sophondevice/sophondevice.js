{"version":3,"file":"model.js","sources":["../../../../libs/device/src/scene/model.ts"],"sourcesContent":["import { REvent } from '@sophon/base';\nimport { AnimationClip } from './animation';\nimport { GraphNode } from './graph_node';\nimport type { Scene } from './scene';\nimport type { Camera } from './camera';\n\nexport class Model extends GraphNode {\n  /** @internal */\n  private _animations: { [name: string]: AnimationClip };\n  /** @internal */\n  private _animationIndex: number;\n  /** @internal */\n  private _updateCallback: (evt: REvent) => void;\n  constructor(scene: Scene) {\n    super(scene);\n    this._animations = {};\n    this._animationIndex = 0;\n    this._updateCallback = (evt: REvent) => {\n      if (this.attached) {\n        this.update((evt as Scene.TickEvent).camera);\n      }\n    };\n  }\n  addAnimation(name?: string): AnimationClip {\n    if (!name) {\n      for (; ;) {\n        name = `animation${this._animationIndex++}`;\n        if (!this._animationIndex[name]) {\n          break;\n        }\n      }\n    }\n    if (this._animations[name]) {\n      console.error(`Model.addAnimation() failed: animation '${name}' already exists`);\n      return null;\n    } else {\n      const ani = new AnimationClip(name, this);\n      this._animations[name] = ani;\n      return ani;\n    }\n  }\n  removeAnimation(name: string) {\n    this.stopAnimation(name);\n    delete this._animations[name];\n  }\n  getAnimationNames(): string[] {\n    return Object.keys(this._animations);\n  }\n  update(camera: Camera) {\n    for (const k in this._animations) {\n      this._animations[k].update();\n    }\n  }\n  isPlayingAnimation(name?: string) {\n    if (name) {\n      return this._animations[name]?.isPlaying();\n    } else {\n      for (const k in this._animations) {\n        if (this._animations[k].isPlaying()) {\n          return true;\n        }\n      }\n      return false;\n    }\n  }\n  playAnimation(name: string, repeat = 1) {\n    const isPlaying = this.isPlayingAnimation();\n    const ani = this._animations[name];\n    if (ani && !ani.isPlaying()) {\n      ani.repeat = repeat;\n      ani.play();\n    }\n    if (!isPlaying && this.isPlayingAnimation()) {\n      this.scene.addEventListener('tick', this._updateCallback);\n    }\n  }\n  stopAnimation(name: string) {\n    const isPlaying = this.isPlayingAnimation();\n    this._animations[name]?.stop();\n    if (isPlaying && !this.isPlayingAnimation()) {\n      this.scene.removeEventListener('tick', this._updateCallback);\n    }\n  }\n\n}\n"],"names":[],"mappings":"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"}
{"version":3,"file":"xform.js","sources":["../../../../libs/device/src/scene/xform.ts"],"sourcesContent":["import { REventTarget, REvent, REventPathBuilder, Vector3, Quaternion, Matrix4x4 } from '@sophon/base';\r\nimport { BoundingVolume } from '../scene/bounding_volume';\r\nimport type { Scene } from '../scene/scene';\r\n\r\nexport class XFormChangeEvent extends REvent {\r\n  static readonly NAME = 'xform_change';\r\n  xform: XForm<any>;\r\n  constructor(xform: XForm<any>) {\r\n    super(XFormChangeEvent.NAME, true, false);\r\n    this.xform = xform;\r\n  }\r\n}\r\n\r\nexport class XForm<T extends XForm<T> = XForm<any>> extends REventTarget {\r\n  /** @internal */\r\n  protected readonly _scene: Scene;\r\n  /** @internal */\r\n  protected _parent: T;\r\n  /** @internal */\r\n  protected _children: T[];\r\n  /** @internal */\r\n  protected _position: Vector3;\r\n  /** @internal */\r\n  protected _scaling: Vector3;\r\n  /** @internal */\r\n  protected _rotation: Quaternion;\r\n  /** @internal */\r\n  protected _localMatrix: Matrix4x4;\r\n  /** @internal */\r\n  protected _worldMatrix: Matrix4x4;\r\n  /** @internal */\r\n  protected _invWorldMatrix: Matrix4x4;\r\n  /** @internal */\r\n  protected _tmpLocalMatrix: Matrix4x4;\r\n  /** @internal */\r\n  protected _tmpWorldMatrix: Matrix4x4;\r\n  /** @internal */\r\n  protected _transformTag: number;\r\n  /** @internal */\r\n  protected _bv: BoundingVolume;\r\n  /** @internal */\r\n  protected _bvDirty: boolean;\r\n  /** @internal */\r\n  protected _bvWorld: BoundingVolume;\r\n  /** @internal */\r\n  private _changeEvent: XFormChangeEvent;\r\n  constructor(scene: Scene, parent?: T, eventPathBuilder?: REventPathBuilder) {\r\n    super(eventPathBuilder);\r\n    this._scene = scene;\r\n    this._parent = parent || null;\r\n    this._children = [];\r\n    this._position = Vector3.zero();\r\n    this._position.setChangeCallback(() => this._transformCallback(true, true));\r\n    this._scaling = Vector3.one();\r\n    this._scaling.setChangeCallback(() => this._transformCallback(true, true));\r\n    this._rotation = Quaternion.identity();\r\n    this._rotation.setChangeCallback(() => this._transformCallback(true, true));\r\n    this._worldMatrix = null;\r\n    this._invWorldMatrix = null;\r\n    this._localMatrix = null;\r\n    this._transformTag = 0;\r\n    this._tmpLocalMatrix = Matrix4x4.identity();\r\n    this._tmpWorldMatrix = Matrix4x4.identity();\r\n    this._bv = null;\r\n    this._bvWorld = null;\r\n    this._bvDirty = true;\r\n    this._changeEvent = new XFormChangeEvent(this);\r\n  }\r\n  get scene(): Scene {\r\n    return this._scene;\r\n  }\r\n  get parent() {\r\n    return this._parent;\r\n  }\r\n  set parent(p: T) {\r\n    p = p || null;\r\n    if (p !== this._parent) {\r\n      this._setParent(p);\r\n    }\r\n  }\r\n  get children(): T[] {\r\n    return this._children;\r\n  }\r\n  get position() {\r\n    return this._position;\r\n  }\r\n  set position(t: Vector3) {\r\n    if (t && this._position !== t) {\r\n      this._position.assign(t.getArray());\r\n    }\r\n  }\r\n  get scaling(): Vector3 {\r\n    return this._scaling;\r\n  }\r\n  set scaling(s: Vector3 | number) {\r\n    const v = typeof s === 'number' ? new Vector3(s, s, s) : s;\r\n    if (!this._scaling.equalsTo(v)) {\r\n      this._scaling.assign(v.getArray());\r\n    }\r\n  }\r\n  get rotation() {\r\n    return this._rotation;\r\n  }\r\n  set rotation(r: Quaternion) {\r\n    if (r && r !== this._rotation) {\r\n      this._rotation.assign(r.getArray());\r\n    }\r\n  }\r\n  get localMatrix() {\r\n    if (!this._localMatrix) {\r\n      this._localMatrix = this._tmpLocalMatrix;\r\n      this._localMatrix\r\n        .scaling(this._scaling)\r\n        .rotateLeft(new Matrix4x4(this._rotation))\r\n        .translateLeft(this._position);\r\n    }\r\n    return this._localMatrix;\r\n  }\r\n  get worldMatrix() {\r\n    if (!this._worldMatrix) {\r\n      this._worldMatrix = this._tmpWorldMatrix;\r\n      if (this._parent) {\r\n        this._worldMatrix.assign(this._parent.worldMatrix.getArray()).multiplyRightAffine(this.localMatrix);\r\n      } else {\r\n        this._worldMatrix.assign(this.localMatrix.getArray());\r\n      }\r\n    }\r\n    return this._worldMatrix;\r\n  }\r\n  get invWorldMatrix() {\r\n    if (!this._invWorldMatrix) {\r\n      this._invWorldMatrix = Matrix4x4.inverseAffine(this.worldMatrix);\r\n    }\r\n    return this._invWorldMatrix;\r\n  }\r\n  lookAt(eye: Vector3, target: Vector3, up: Vector3) {\r\n    Matrix4x4.lookAt(eye, target, up).decompose(this.scaling, this.rotation, this.position);\r\n    return this;\r\n  }\r\n  notifyChanged(invalidLocal: boolean, dispatch: boolean) {\r\n    this._transformCallback(invalidLocal, dispatch);\r\n  }\r\n  computeBoundingVolume(bv: BoundingVolume): BoundingVolume {\r\n    return bv;\r\n  }\r\n  getBoundingVolume(): BoundingVolume {\r\n    if (this._bvDirty) {\r\n      this._bv = this.computeBoundingVolume(this._bv) || null;\r\n      this._bvDirty = false;\r\n    }\r\n    return this._bv;\r\n  }\r\n  setBoundingVolume(bv: BoundingVolume) {\r\n    if (bv !== this._bv) {\r\n      this._bv = bv;\r\n      this.invalidateBoundingVolume();\r\n    }\r\n  }\r\n  getWorldBoundingVolume(): BoundingVolume {\r\n    if (!this._bvWorld) {\r\n      this._bvWorld = this.getBoundingVolume()?.transform(this.worldMatrix) ?? null;\r\n    }\r\n    return this._bvWorld;\r\n  }\r\n  invalidateBoundingVolume() {\r\n    this._bvDirty = true;\r\n    this.invalidateWorldBoundingVolume();\r\n  }\r\n  invalidateWorldBoundingVolume() {\r\n    this._bvWorld = null;\r\n  }\r\n  /** @internal */\r\n  getTag(): number {\r\n    return this._transformTag;\r\n  }\r\n  /** @internal */\r\n  protected _setParent(p: T) {\r\n    if (this._parent) {\r\n      this._parent._children.splice(this._parent._children.indexOf(this as unknown as T), 1);\r\n    }\r\n    this._parent = p;\r\n    if (this._parent) {\r\n      this._parent._children.push(this as unknown as T);\r\n    }\r\n    this._transformCallback(false, true);\r\n  }\r\n  /** @internal */\r\n  private _transformCallback(invalidLocal: boolean, dispatch: boolean) {\r\n    if (invalidLocal) {\r\n      this._localMatrix = null;\r\n    }\r\n    this._invalidateWorldMatrix();\r\n    this.invalidateWorldBoundingVolume();\r\n    if (dispatch) {\r\n      this._changeEvent.reset();\r\n      this.dispatchEvent(this._changeEvent);\r\n    }\r\n    for (const child of this._children) {\r\n      child._transformCallback(false, dispatch);\r\n    }\r\n  }\r\n  /** @internal */\r\n  private _invalidateWorldMatrix() {\r\n    this._worldMatrix = null;\r\n    this._invWorldMatrix = null;\r\n    this._transformTag++;\r\n    for (const child of this._children) {\r\n      child._invalidateWorldMatrix();\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;AAIM,MAAO,gBAAiB,SAAQ,MAAM,CAAA;AAC1C,IAAA,OAAgB,IAAI,GAAG,cAAc,CAAC;AACtC,IAAA,KAAK,CAAa;AAClB,IAAA,WAAA,CAAY,KAAiB,EAAA;QAC3B,KAAK,CAAC,gBAAgB,CAAC,IAAI,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC;AAC1C,QAAA,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;KACpB;;AAGG,MAAO,KAAuC,SAAQ,YAAY,CAAA;AAEnD,IAAA,MAAM,CAAQ;AAEvB,IAAA,OAAO,CAAI;AAEX,IAAA,SAAS,CAAM;AAEf,IAAA,SAAS,CAAU;AAEnB,IAAA,QAAQ,CAAU;AAElB,IAAA,SAAS,CAAa;AAEtB,IAAA,YAAY,CAAY;AAExB,IAAA,YAAY,CAAY;AAExB,IAAA,eAAe,CAAY;AAE3B,IAAA,eAAe,CAAY;AAE3B,IAAA,eAAe,CAAY;AAE3B,IAAA,aAAa,CAAS;AAEtB,IAAA,GAAG,CAAiB;AAEpB,IAAA,QAAQ,CAAU;AAElB,IAAA,QAAQ,CAAiB;AAE3B,IAAA,YAAY,CAAmB;AACvC,IAAA,WAAA,CAAY,KAAY,EAAE,MAAU,EAAE,gBAAoC,EAAA;QACxE,KAAK,CAAC,gBAAgB,CAAC,CAAC;AACxB,QAAA,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;AACpB,QAAA,IAAI,CAAC,OAAO,GAAG,MAAM,IAAI,IAAI,CAAC;AAC9B,QAAA,IAAI,CAAC,SAAS,GAAG,EAAE,CAAC;AACpB,QAAA,IAAI,CAAC,SAAS,GAAG,OAAO,CAAC,IAAI,EAAE,CAAC;AAChC,QAAA,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAC,MAAM,IAAI,CAAC,kBAAkB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;AAC5E,QAAA,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC,GAAG,EAAE,CAAC;AAC9B,QAAA,IAAI,CAAC,QAAQ,CAAC,iBAAiB,CAAC,MAAM,IAAI,CAAC,kBAAkB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;AAC3E,QAAA,IAAI,CAAC,SAAS,GAAG,UAAU,CAAC,QAAQ,EAAE,CAAC;AACvC,QAAA,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAC,MAAM,IAAI,CAAC,kBAAkB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;AAC5E,QAAA,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;AACzB,QAAA,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;AAC5B,QAAA,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;AACzB,QAAA,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC;AACvB,QAAA,IAAI,CAAC,eAAe,GAAG,SAAS,CAAC,QAAQ,EAAE,CAAC;AAC5C,QAAA,IAAI,CAAC,eAAe,GAAG,SAAS,CAAC,QAAQ,EAAE,CAAC;AAC5C,QAAA,IAAI,CAAC,GAAG,GAAG,IAAI,CAAC;AAChB,QAAA,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;AACrB,QAAA,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACrB,IAAI,CAAC,YAAY,GAAG,IAAI,gBAAgB,CAAC,IAAI,CAAC,CAAC;KAChD;AACD,IAAA,IAAI,KAAK,GAAA;QACP,OAAO,IAAI,CAAC,MAAM,CAAC;KACpB;AACD,IAAA,IAAI,MAAM,GAAA;QACR,OAAO,IAAI,CAAC,OAAO,CAAC;KACrB;IACD,IAAI,MAAM,CAAC,CAAI,EAAA;AACb,QAAA,CAAC,GAAG,CAAC,IAAI,IAAI,CAAC;AACd,QAAA,IAAI,CAAC,KAAK,IAAI,CAAC,OAAO,EAAE;AACtB,YAAA,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;AACpB,SAAA;KACF;AACD,IAAA,IAAI,QAAQ,GAAA;QACV,OAAO,IAAI,CAAC,SAAS,CAAC;KACvB;AACD,IAAA,IAAI,QAAQ,GAAA;QACV,OAAO,IAAI,CAAC,SAAS,CAAC;KACvB;IACD,IAAI,QAAQ,CAAC,CAAU,EAAA;AACrB,QAAA,IAAI,CAAC,IAAI,IAAI,CAAC,SAAS,KAAK,CAAC,EAAE;YAC7B,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC;AACrC,SAAA;KACF;AACD,IAAA,IAAI,OAAO,GAAA;QACT,OAAO,IAAI,CAAC,QAAQ,CAAC;KACtB;IACD,IAAI,OAAO,CAAC,CAAmB,EAAA;QAC7B,MAAM,CAAC,GAAG,OAAO,CAAC,KAAK,QAAQ,GAAG,IAAI,OAAO,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC;QAC3D,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE;YAC9B,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC;AACpC,SAAA;KACF;AACD,IAAA,IAAI,QAAQ,GAAA;QACV,OAAO,IAAI,CAAC,SAAS,CAAC;KACvB;IACD,IAAI,QAAQ,CAAC,CAAa,EAAA;AACxB,QAAA,IAAI,CAAC,IAAI,CAAC,KAAK,IAAI,CAAC,SAAS,EAAE;YAC7B,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC;AACrC,SAAA;KACF;AACD,IAAA,IAAI,WAAW,GAAA;AACb,QAAA,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE;AACtB,YAAA,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,eAAe,CAAC;AACzC,YAAA,IAAI,CAAC,YAAY;AACd,iBAAA,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC;iBACtB,UAAU,CAAC,IAAI,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;AACzC,iBAAA,aAAa,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;AAClC,SAAA;QACD,OAAO,IAAI,CAAC,YAAY,CAAC;KAC1B;AACD,IAAA,IAAI,WAAW,GAAA;AACb,QAAA,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE;AACtB,YAAA,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,eAAe,CAAC;YACzC,IAAI,IAAI,CAAC,OAAO,EAAE;gBAChB,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,QAAQ,EAAE,CAAC,CAAC,mBAAmB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;AACrG,aAAA;AAAM,iBAAA;AACL,gBAAA,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE,CAAC,CAAC;AACvD,aAAA;AACF,SAAA;QACD,OAAO,IAAI,CAAC,YAAY,CAAC;KAC1B;AACD,IAAA,IAAI,cAAc,GAAA;AAChB,QAAA,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE;YACzB,IAAI,CAAC,eAAe,GAAG,SAAS,CAAC,aAAa,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;AAClE,SAAA;QACD,OAAO,IAAI,CAAC,eAAe,CAAC;KAC7B;AACD,IAAA,MAAM,CAAC,GAAY,EAAE,MAAe,EAAE,EAAW,EAAA;QAC/C,SAAS,CAAC,MAAM,CAAC,GAAG,EAAE,MAAM,EAAE,EAAE,CAAC,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;AACxF,QAAA,OAAO,IAAI,CAAC;KACb;IACD,aAAa,CAAC,YAAqB,EAAE,QAAiB,EAAA;AACpD,QAAA,IAAI,CAAC,kBAAkB,CAAC,YAAY,EAAE,QAAQ,CAAC,CAAC;KACjD;AACD,IAAA,qBAAqB,CAAC,EAAkB,EAAA;AACtC,QAAA,OAAO,EAAE,CAAC;KACX;IACD,iBAAiB,GAAA;QACf,IAAI,IAAI,CAAC,QAAQ,EAAE;AACjB,YAAA,IAAI,CAAC,GAAG,GAAG,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,IAAI,CAAC;AACxD,YAAA,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC;AACvB,SAAA;QACD,OAAO,IAAI,CAAC,GAAG,CAAC;KACjB;AACD,IAAA,iBAAiB,CAAC,EAAkB,EAAA;AAClC,QAAA,IAAI,EAAE,KAAK,IAAI,CAAC,GAAG,EAAE;AACnB,YAAA,IAAI,CAAC,GAAG,GAAG,EAAE,CAAC;YACd,IAAI,CAAC,wBAAwB,EAAE,CAAC;AACjC,SAAA;KACF;IACD,sBAAsB,GAAA;AACpB,QAAA,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;AAClB,YAAA,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,iBAAiB,EAAE,EAAE,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,IAAI,CAAC;AAC/E,SAAA;QACD,OAAO,IAAI,CAAC,QAAQ,CAAC;KACtB;IACD,wBAAwB,GAAA;AACtB,QAAA,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACrB,IAAI,CAAC,6BAA6B,EAAE,CAAC;KACtC;IACD,6BAA6B,GAAA;AAC3B,QAAA,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;KACtB;IAED,MAAM,GAAA;QACJ,OAAO,IAAI,CAAC,aAAa,CAAC;KAC3B;AAES,IAAA,UAAU,CAAC,CAAI,EAAA;QACvB,IAAI,IAAI,CAAC,OAAO,EAAE;YAChB,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,OAAO,CAAC,IAAoB,CAAC,EAAE,CAAC,CAAC,CAAC;AACxF,SAAA;AACD,QAAA,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC;QACjB,IAAI,IAAI,CAAC,OAAO,EAAE;YAChB,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,IAAI,CAAC,IAAoB,CAAC,CAAC;AACnD,SAAA;AACD,QAAA,IAAI,CAAC,kBAAkB,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;KACtC;IAEO,kBAAkB,CAAC,YAAqB,EAAE,QAAiB,EAAA;AACjE,QAAA,IAAI,YAAY,EAAE;AAChB,YAAA,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;AAC1B,SAAA;QACD,IAAI,CAAC,sBAAsB,EAAE,CAAC;QAC9B,IAAI,CAAC,6BAA6B,EAAE,CAAC;AACrC,QAAA,IAAI,QAAQ,EAAE;AACZ,YAAA,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,CAAC;AAC1B,YAAA,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;AACvC,SAAA;AACD,QAAA,KAAK,MAAM,KAAK,IAAI,IAAI,CAAC,SAAS,EAAE;AAClC,YAAA,KAAK,CAAC,kBAAkB,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;AAC3C,SAAA;KACF;IAEO,sBAAsB,GAAA;AAC5B,QAAA,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;AACzB,QAAA,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;QAC5B,IAAI,CAAC,aAAa,EAAE,CAAC;AACrB,QAAA,KAAK,MAAM,KAAK,IAAI,IAAI,CAAC,SAAS,EAAE;YAClC,KAAK,CAAC,sBAAsB,EAAE,CAAC;AAChC,SAAA;KACF;AACF;;;;"}
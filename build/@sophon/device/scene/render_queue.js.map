{"version":3,"file":"render_queue.js","sources":["../../../../libs/device/src/scene/render_queue.ts"],"sourcesContent":["import type { Matrix4x4 } from '@sophon/base';\nimport type { Device } from '../device';\nimport type { Camera } from './camera';\nimport type { Drawable } from './drawable';\nimport type { RenderPass } from './renderers';\n\nexport interface InstanceData {\n  worldMatrices: Matrix4x4[];\n  hash: string,\n}\n\nexport interface IRenderQueueItem {\n  drawable: Drawable,\n  sortDistance: number,\n  instanceData: InstanceData,\n}\n\ninterface RenderItemList {\n  opaqueList: IRenderQueueItem[];\n  opaqueInstanceList: { [hash: string]: number };\n  transList: IRenderQueueItem[];\n  transInstanceList: { [hash: string]: number };\n}\n\nexport class RenderQueue {\n  /** @internal */\n  private _itemLists: { [order: number]: RenderItemList };\n  /** @internal */\n  private _renderPass: RenderPass;\n  constructor(renderPass: RenderPass) {\n    this._itemLists = {};\n    this._renderPass = renderPass;\n  }\n  get renderPass(): RenderPass {\n    return this._renderPass;\n  }\n  get items() {\n    return this._itemLists;\n  }\n  getMaxBatchSize(device: Device) {\n    return device.getShaderCaps().maxUniformBufferSize / 64;\n  }\n  push(camera: Camera, drawable: Drawable, renderOrder: number) {\n    if (drawable) {\n      let itemList = this._itemLists[renderOrder];\n      if (!itemList) {\n        itemList = {\n          opaqueList: [],\n          opaqueInstanceList: {},\n          transList: [],\n          transInstanceList: {},\n        };\n        this._itemLists[renderOrder] = itemList;\n      }\n      const trans = drawable.isTransparency();\n      const list = trans ? itemList.transList : itemList.opaqueList;\n      if (drawable.isBatchable()) {\n        const instanceList = trans ? itemList.transInstanceList : itemList.opaqueInstanceList;\n        const hash = drawable.getInstanceId(this._renderPass);\n        const index = instanceList[hash];\n        if (index === undefined || list[index].instanceData.worldMatrices.length === this.getMaxBatchSize(camera.scene.device)) {\n          instanceList[hash] = list.length;\n          list.push({\n            drawable,\n            sortDistance: drawable.getSortDistance(camera),\n            instanceData: {\n              worldMatrices: [drawable.getXForm().worldMatrix],\n              hash: hash,\n            }\n          });\n        } else {\n          list[index].instanceData.worldMatrices.push(drawable.getXForm().worldMatrix);\n        }\n      } else {\n        list.push({\n          drawable,\n          sortDistance: drawable.getSortDistance(camera),\n          instanceData: null,\n        });\n      }\n    }\n  }\n  clear() {\n    this._itemLists = {};\n  }\n  sortItems() {\n    for (const list of Object.values(this._itemLists)) {\n      list.opaqueList.sort((a, b) => a.sortDistance - b.sortDistance);\n      list.transList.sort((a, b) => b.sortDistance - a.sortDistance);\n    }\n  }\n}\n"],"names":[],"mappings":"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"}
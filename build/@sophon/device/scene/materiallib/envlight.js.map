{"version":3,"file":"envlight.js","sources":["../../../../../libs/device/src/scene/materiallib/envlight.ts"],"sourcesContent":["import { Vector4 } from \"@sophon/base\";\r\nimport type { BaseTexture, BindGroup, ProgramBuilder, TextureCube, TextureSampler } from \"../../device\";\r\n\r\nexport abstract class EnvironmentLighting {\r\n  abstract initShaderBindings(pb: ProgramBuilder): void;\r\n  abstract updateBindGroup(bg: BindGroup): void;\r\n  isIBL(): this is EnvIBL {\r\n    return false;\r\n  }\r\n  isConstant(): this is EnvConstantAmbient {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport class EnvIBL extends EnvironmentLighting {\r\n  public static readonly USAGE_IBL_RADIANCE_MAP = 'usage_ibl_radiance_map';\r\n  public static readonly USAGE_IBL_RADIANCE_MAP_MAX_LOD = 'usage_ibl_radiance_map_maxlod';\r\n  public static readonly USAGE_IBL_IRRADIANCE_MAP = 'usage_ibl_irradiance_map';\r\n  private _radianceMap: TextureCube;\r\n  private _radianceMapSampler: TextureSampler;\r\n  private _irradianceMap: TextureCube;\r\n  private _irradianceMapSampler: TextureSampler;\r\n  constructor(radianceMap?: TextureCube, irradianceMap?: TextureCube) {\r\n    super();\r\n    this._radianceMap = radianceMap || null;\r\n    this._radianceMapSampler = radianceMap?.getDefaultSampler(false) || null;\r\n    this._irradianceMap = irradianceMap || null;\r\n    this._irradianceMapSampler = irradianceMap?.getDefaultSampler(false) || null;\r\n  }\r\n  get radianceMap(): TextureCube {\r\n    return this._radianceMap;\r\n  }\r\n  set radianceMap(tex: TextureCube) {\r\n    this._radianceMap = tex;\r\n    if (!this._radianceMapSampler && tex) {\r\n      this._radianceMapSampler = tex.getDefaultSampler(false) || null;\r\n    }\r\n  }\r\n  get irradianceMap(): TextureCube {\r\n    return this._irradianceMap;\r\n  }\r\n  set irradianceMap(tex: TextureCube) {\r\n    this._irradianceMap = tex;\r\n    if (!this._irradianceMapSampler && tex) {\r\n      this._irradianceMapSampler = tex.getDefaultSampler(false);\r\n    }\r\n  }\r\n  initShaderBindings(pb: ProgramBuilder): void {\r\n    pb.globalScope.iblRadianceMap = pb.texCube().uniform(0).tag(EnvIBL.USAGE_IBL_RADIANCE_MAP);\r\n    pb.globalScope.iblIrradianceMap = pb.texCube().uniform(0).tag(EnvIBL.USAGE_IBL_IRRADIANCE_MAP);\r\n    pb.globalScope.iblParams = pb.defineStruct(null, 'std140', pb.float('radianceMaxLod'))().uniform(0).tag({ radianceMaxLod: EnvIBL.USAGE_IBL_RADIANCE_MAP_MAX_LOD });\r\n  }\r\n  updateBindGroup(bg: BindGroup): void {\r\n    bg.setValue('iblParams', { radianceMaxLod: this._radianceMap ? this._radianceMap.mipLevelCount - 1 : 0 });\r\n    bg.setTexture('iblRadianceMap', this._radianceMap, this._radianceMapSampler);\r\n    bg.setTexture('iblIrradianceMap', this._irradianceMap, this._irradianceMapSampler);\r\n  }\r\n  isIBL(): this is EnvIBL {\r\n    return true;\r\n  }\r\n  private getMapSampler(tex: BaseTexture): TextureSampler {\r\n    return tex.getDefaultSampler(false);\r\n  }\r\n}\r\n\r\nexport class EnvConstantAmbient extends EnvironmentLighting {\r\n  public static readonly USAGE_CONSTANT_AMBIENT_LIGHTING = 'usage_env_constant_ambient';\r\n  public static readonly funcNameGetAmbient = 'lib_getConstantAmbient';\r\n  private _ambientColor: Vector4;\r\n  constructor(ambientColor?: Vector4) {\r\n    super();\r\n    this._ambientColor = ambientColor ? new Vector4(ambientColor) : new Vector4(0, 0, 0, 1);\r\n  }\r\n  get ambientColor(): Vector4 {\r\n    return this._ambientColor;\r\n  }\r\n  set ambientColor(ambientColor: Vector4) {\r\n    if (ambientColor) {\r\n      this._ambientColor.assign(ambientColor.getArray());\r\n    }\r\n  }\r\n  initShaderBindings(pb: ProgramBuilder): void {\r\n    pb.globalScope.envLight = pb.defineStruct(null, 'std140', pb.vec4('ambient'))().uniform(0).tag({ ambient: EnvConstantAmbient.USAGE_CONSTANT_AMBIENT_LIGHTING });\r\n  }\r\n  updateBindGroup(bg: BindGroup): void {\r\n    bg.setValue('envLight', { ambient: this._ambientColor });\r\n  }\r\n  isConstant(): this is EnvConstantAmbient {\r\n    return true;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
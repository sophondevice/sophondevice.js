{"version":3,"file":"skybox.js","sources":["../../../../../libs/device/src/scene/materiallib/skybox.ts"],"sourcesContent":["import { Material } from '../material';\nimport { ShaderLib } from './shaderlib';\nimport { FaceMode } from '../../device/render_states';\nimport * as values from '../values';\nimport type { DrawContext } from '../drawable';\nimport type { Device, TextureCube, BindGroup, GPUProgram, PBGlobalScope, ProgramBuilder, TextureSampler } from '../../device';\n\nexport class SkyboxMaterial extends Material {\n  private _skyCubemap: TextureCube;\n  private _skySampler: TextureSampler;\n  constructor(device: Device) {\n    super(device);\n    this._renderStateSet.useRasterizerState().setCullMode(FaceMode.NONE);\n    this._skyCubemap = null;\n    this._skySampler = null;\n  }\n  get skyCubeMap(): TextureCube {\n    return this._skyCubemap;\n  }\n  set skyCubeMap(tex: TextureCube) {\n    tex = tex || null;\n    if (tex !== this._skyCubemap) {\n      const hash = this._createHash();\n      this._skyCubemap = tex;\n      if (tex && !this._skySampler) {\n        this._skySampler = tex.getDefaultSampler(false);\n      }\n      this.optionChanged(hash !== this._createHash());\n    }\n  }\n  supportLighting(): boolean {\n    return false;\n  }\n  protected _createHash(): string {\n    if (!this._skyCubemap) {\n      return '0';\n    } else if (this.device.getDeviceType() === 'webgpu') {\n      return this._skyCubemap.isFilterable() ? '1' : '2';\n    } else {\n      return '1';\n    }\n  }\n  protected _applyUniforms(bindGroup: BindGroup, ctx: DrawContext): void {\n    if (this._skyCubemap) {\n      bindGroup.setTexture('skyCubeMap', this._skyCubemap, this._skySampler);\n    }\n  }\n  protected _createProgram(pb: ProgramBuilder, ctx: DrawContext, func: number): GPUProgram {\n    const that = this;\n    const lib = new ShaderLib(pb);\n    return pb.buildRenderProgram({\n      vertex(this: PBGlobalScope) {\n        Material.initShader(pb, ctx);\n        this.$inputs.pos = pb.vec3().attrib('position');\n        this.$outputs.texCoord = pb.vec3();\n        this.$mainFunc(function () {\n          this.$outputs.texCoord = this.$inputs.pos;\n          this.$l.worldPos = pb.add(pb.reflection.tag(ShaderLib.USAGE_CAMERA_POSITION), lib.objectSpacePositionToWorld(this.$inputs.pos).xyz);\n          this.$builtins.position = lib.worldSpacePositionToClip(this.worldPos);\n          this.$builtins.position.z = this.$builtins.position.w;\n        });\n      },\n      fragment(this: PBGlobalScope) {\n        Material.initShader(pb, ctx);\n        if (func === values.MATERIAL_FUNC_NORMAL) {\n          this.$outputs.outColor = pb.vec4();\n          if (that._skyCubemap) {\n            this.skyCubeMap = pb.texCube().uniform(2);\n            if (!that._skyCubemap.isFilterable()) {\n              this.skyCubeMap.sampleType('unfilterable-float');\n            }\n          }\n          this.$mainFunc(function () {\n            if (that._skyCubemap) {\n              this.$l.texCoord = pb.normalize(this.$inputs.texCoord);\n              this.$l.color = pb.device?.getShaderCaps().supportShaderTextureLod\n                ? pb.textureSampleLevel(this.skyCubeMap, this.texCoord, 0).xyz\n                : pb.textureSample(this.skyCubeMap, this.texCoord).xyz\n            } else {\n              this.$l.color = pb.vec3(0);\n            }\n            this.$outputs.outColor = lib.encodeColorOutput(pb.vec4(this.color, 1));\n          });\n        } else {\n          this.$mainFunc(function () {\n            pb.discard();\n          });\n        }\n      }\n    });\n  }\n}\n\n"],"names":["values.MATERIAL_FUNC_NORMAL"],"mappings":"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"}
{"version":3,"file":"skybox.js","sources":["../../../../../libs/device/src/scene/materiallib/skybox.ts"],"sourcesContent":["import { Material } from '../material';\r\nimport { ShaderLib } from './shaderlib';\r\nimport { FaceMode } from '../../device/render_states';\r\nimport * as values from '../values';\r\nimport type { DrawContext } from '../drawable';\r\nimport type { Device, TextureCube, BindGroup, GPUProgram, PBGlobalScope, ProgramBuilder, TextureSampler } from '../../device';\r\n\r\nexport class SkyboxMaterial extends Material {\r\n  private _skyCubemap: TextureCube;\r\n  private _skySampler: TextureSampler;\r\n  constructor(device: Device) {\r\n    super(device);\r\n    this._renderStateSet.useRasterizerState().setCullMode(FaceMode.NONE);\r\n    this._skyCubemap = null;\r\n    this._skySampler = null;\r\n  }\r\n  get skyCubeMap(): TextureCube {\r\n    return this._skyCubemap;\r\n  }\r\n  set skyCubeMap(tex: TextureCube) {\r\n    tex = tex || null;\r\n    if (tex !== this._skyCubemap) {\r\n      const hash = this._createHash();\r\n      this._skyCubemap = tex;\r\n      if (tex && !this._skySampler) {\r\n        this._skySampler = tex.getDefaultSampler(false);\r\n      }\r\n      this.optionChanged(hash !== this._createHash());\r\n    }\r\n  }\r\n  supportLighting(): boolean {\r\n    return false;\r\n  }\r\n  protected _createHash(): string {\r\n    if (!this._skyCubemap) {\r\n      return '0';\r\n    } else if (this.device.getDeviceType() === 'webgpu') {\r\n      return this._skyCubemap.isFilterable() ? '1' : '2';\r\n    } else {\r\n      return '1';\r\n    }\r\n  }\r\n  protected _applyUniforms(bindGroup: BindGroup, ctx: DrawContext): void {\r\n    if (this._skyCubemap) {\r\n      bindGroup.setTexture('skyCubeMap', this._skyCubemap, this._skySampler);\r\n    }\r\n  }\r\n  protected _createProgram(pb: ProgramBuilder, ctx: DrawContext, func: number): GPUProgram {\r\n    const that = this;\r\n    const lib = new ShaderLib(pb);\r\n    return pb.buildRenderProgram({\r\n      vertex(this: PBGlobalScope) {\r\n        Material.initShader(pb, ctx);\r\n        this.$inputs.pos = pb.vec3().attrib('position');\r\n        this.$outputs.texCoord = pb.vec3();\r\n        this.$mainFunc(function () {\r\n          this.$outputs.texCoord = this.$inputs.pos;\r\n          this.$l.worldPos = pb.add(pb.reflection.tag(ShaderLib.USAGE_CAMERA_POSITION), lib.objectSpacePositionToWorld(this.$inputs.pos).xyz);\r\n          this.$builtins.position = lib.worldSpacePositionToClip(this.worldPos);\r\n          this.$builtins.position.z = this.$builtins.position.w;\r\n        });\r\n      },\r\n      fragment(this: PBGlobalScope) {\r\n        Material.initShader(pb, ctx);\r\n        if (func === values.MATERIAL_FUNC_NORMAL) {\r\n          this.$outputs.outColor = pb.vec4();\r\n          if (that._skyCubemap) {\r\n            this.skyCubeMap = pb.texCube().uniform(2);\r\n            if (!that._skyCubemap.isFilterable()) {\r\n              this.skyCubeMap.sampleType('unfilterable-float');\r\n            }\r\n          }\r\n          this.$mainFunc(function () {\r\n            if (that._skyCubemap) {\r\n              this.$l.texCoord = pb.normalize(this.$inputs.texCoord);\r\n              this.$l.color = pb.device?.getShaderCaps().supportShaderTextureLod\r\n                ? pb.textureSampleLevel(this.skyCubeMap, this.texCoord, 0).xyz\r\n                : pb.textureSample(this.skyCubeMap, this.texCoord).xyz\r\n            } else {\r\n              this.$l.color = pb.vec3(0);\r\n            }\r\n            this.$outputs.outColor = lib.encodeColorOutput(pb.vec4(this.color, 1));\r\n          });\r\n        } else {\r\n          this.$mainFunc(function () {\r\n            pb.discard();\r\n          });\r\n        }\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\n"],"names":["values.MATERIAL_FUNC_NORMAL"],"mappings":"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"}
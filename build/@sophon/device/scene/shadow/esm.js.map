{"version":3,"file":"esm.js","sources":["../../../../../libs/device/src/scene/shadow/esm.ts"],"sourcesContent":["import { ShadowImpl } from \"./shadow_impl\";\nimport { GaussianBlurBlitter, BlitType } from \"../blitter\";\nimport { computeShadowMapDepth, filterShadowESM } from \"../renderers/shadowmap.shaderlib\";\nimport { ShaderLib } from \"../materiallib\";\nimport { Device, FrameBuffer, TextureTarget, TextureFormat, GPUResourceUsageFlags, PBShaderExp, PBInsideFunctionScope, TextureSampler, TextureCreationOptions } from \"../../device\";\nimport type { ShadowMapper, ShadowMapType, ShadowMode } from \"./shadowmapper\";\n\nclass BlurBlitter extends GaussianBlurBlitter {\n  protected _packFloat: boolean;\n  get packFloat(): boolean {\n    return this._packFloat;\n  }\n  set packFloat(b: boolean) {\n    if (this._packFloat !== !!b) {\n      this._packFloat = !!b;\n      this.invalidateHash();\n    }\n  }\n  readTexel(scope: PBInsideFunctionScope, type: BlitType, srcTex: PBShaderExp, srcUV: PBShaderExp, srcLayer: PBShaderExp): PBShaderExp {\n    const pb = scope.$builder;\n    const texel = super.readTexel(scope, type, srcTex, srcUV, srcLayer);\n    if (this.packFloat) {\n      const lib = new ShaderLib(pb);\n      return pb.vec4(lib.decodeNormalizedFloatFromRGBA(texel), 0, 0, 1);\n    } else {\n      return texel;\n    }\n  }\n  writeTexel(scope: PBInsideFunctionScope, type: BlitType, srcUV: PBShaderExp, texel: PBShaderExp): PBShaderExp {\n    const pb = scope.$builder;\n    const outTexel = super.writeTexel(scope, type, srcUV, texel);\n    if (this.packFloat) {\n      const lib = new ShaderLib(pb);\n      return lib.encodeNormalizedFloatToRGBA(outTexel.r);\n    } else {\n      return outTexel;\n    }\n  }\n  protected calcHash(): string {\n    return `${super.calcHash()}-${Number(this.packFloat)}`;\n  }\n}\n\n\nexport class ESM extends ShadowImpl {\n  /** @internal */\n  protected _depthScale: number;\n  /** @internal */\n  protected _blur: boolean;\n  /** @internal */\n  protected _kernelSize: number;\n  /** @internal */\n  protected _blurSize: number;\n  /** @internal */\n  protected _logSpace: boolean;\n  /** @internal */\n  protected _blurMap: ShadowMapType;\n  /** @internal */\n  protected _blurFramebuffer: FrameBuffer;\n  /** @internal */\n  protected _blurMap2: ShadowMapType;\n  /** @internal */\n  protected _blurFramebuffer2: FrameBuffer;\n  /** @internal */\n  protected _blitterH: BlurBlitter;\n  /** @internal */\n  protected _blitterV: BlurBlitter;\n  /** @internal */\n  protected _mipmap: boolean;\n  /** @internal */\n  protected _shadowSampler: TextureSampler;\n  constructor(kernelSize?: number, blurSize?: number, depthScale?: number) {\n    super();\n    this._blur = true;\n    this._depthScale = depthScale ?? 500;\n    this._kernelSize = kernelSize ?? 5;\n    this._blurSize = blurSize ?? 1;\n    this._logSpace = true;\n    this._mipmap = true;\n    this._shadowSampler = null;\n    this._blitterH = new BlurBlitter('horizonal', this._kernelSize, 4, 1 / 1024);\n    this._blitterV = new BlurBlitter('vertical', this._kernelSize, 4, 1 / 1024);\n  }\n  resourceDirty(): boolean {\n    return this._resourceDirty;\n  }\n  get blur(): boolean {\n    return this._blur;\n  }\n  set blur(val: boolean) {\n    if (this._blur !== !!val) {\n      this._blur = !!val;\n      this._resourceDirty = true;\n    }\n  }\n  get mipmap(): boolean {\n    return this._mipmap;\n  }\n  set mipmap(b: boolean) {\n    if (this._mipmap !== !!b) {\n      this._mipmap = !!b;\n      if (this._blur) {\n        this._resourceDirty = true;\n      }\n    }\n  }\n  get kernelSize(): number {\n    return this._kernelSize;\n  }\n  set kernelSize(val: number) {\n    this._kernelSize = val;\n  }\n  get blurSize(): number {\n    return this._blurSize;\n  }\n  set blurSize(val: number) {\n    this._blurSize = val;\n  }\n  get logSpace(): boolean {\n    return this._logSpace;\n  }\n  set logSpace(val: boolean) {\n    this._logSpace = !!val;\n  }\n  getType(): ShadowMode {\n    return 'esm';\n  }\n  dispose(): void {\n    this._blurFramebuffer?.dispose();\n    this._blurFramebuffer = null;\n    this._blurFramebuffer2?.dispose();\n    this._blurFramebuffer2 = null;\n    this._blurMap?.dispose();\n    this._blurMap = null;\n    this._blurMap2?.dispose();\n    this._blurMap2 = null;\n    this._shadowSampler = null;\n  }\n  getShadowMap(shadowMapper: ShadowMapper): ShadowMapType {\n    return this._blur ? this._blurMap2 : shadowMapper.getColorAttachment();\n  }\n  getShadowMapSampler(shadowMapper: ShadowMapper): TextureSampler {\n    if (!this._shadowSampler) {\n      this._shadowSampler = this.getShadowMap(shadowMapper)?.getDefaultSampler(false) || null;\n    }\n    return null;\n  }\n  /** @internal */\n  protected isTextureInvalid(shadowMapper: ShadowMapper, texture: ShadowMapType, target: TextureTarget, format: TextureFormat, width: number, height: number): boolean {\n    return texture && (texture.target !== target\n      || texture.format !== format\n      || texture.width !== width\n      || texture.height !== height\n      || texture.depth !== shadowMapper.numShadowCascades);\n  }\n  /** @internal */\n  protected createTexture(device: Device, target: TextureTarget, format: TextureFormat, width: number, height: number, depth: number, mipmap: boolean): ShadowMapType {\n    const options: TextureCreationOptions = {\n      colorSpace: 'linear',\n      noMipmap: !mipmap\n    };\n    switch (target) {\n      case TextureTarget.Texture2D:\n        return device.createTexture2D(format, width, height, options);\n      case TextureTarget.TextureCubemap:\n        return device.createCubeTexture(format, width, options);\n      case TextureTarget.Texture2DArray:\n        return device.createTexture2DArray(format, width, height, depth, options);\n      default:\n        return null;\n    }\n  }\n  doUpdateResources(shadowMapper: ShadowMapper) {\n    const device = shadowMapper.light.scene.device;\n    const colorFormat = this.getShadowMapColorFormat(shadowMapper);\n    const target = shadowMapper.getColorAttachment().target;\n    const shadowMapWidth = shadowMapper.getColorAttachment().width;\n    const shadowMapHeight = shadowMapper.getColorAttachment().height;\n    const blur = this._blur;\n    const blurMapWidth = shadowMapWidth;\n    const blurMapHeight = shadowMapHeight;\n    if (!blur) {\n      this._blurFramebuffer?.dispose();\n      this._blurFramebuffer = null;\n      this._blurMap?.dispose();\n      this._blurMap = null;\n      this._blurFramebuffer2?.dispose();\n      this._blurFramebuffer2 = null;\n      this._blurMap2?.dispose();\n      this._blurMap2 = null;\n    }\n    if (this.isTextureInvalid(shadowMapper, this._blurMap, target, colorFormat, blurMapWidth, blurMapHeight)) {\n      this._blurFramebuffer?.dispose();\n      this._blurFramebuffer = null;\n      this._blurMap?.dispose();\n      this._blurMap = null;\n    }\n    if (this.isTextureInvalid(shadowMapper, this._blurMap2, target, colorFormat, blurMapWidth, blurMapHeight)) {\n      this._blurFramebuffer2?.dispose();\n      this._blurFramebuffer2 = null;\n      this._blurMap2?.dispose();\n      this._blurMap2 = null;\n    }\n    if (blur) {\n      if (!this._blurMap || this._blurMap.disposed) {\n        this._blurMap = this.createTexture(device, target, colorFormat, blurMapWidth, blurMapHeight, shadowMapper.numShadowCascades, false);\n      }\n      if (!this._blurMap2 || (this._mipmap !== this._blurMap2.mipLevelCount > 1) || this._blurMap2.disposed) {\n        this._blurMap2 = this.createTexture(device, target, colorFormat, blurMapWidth, blurMapHeight, shadowMapper.numShadowCascades, this._mipmap);\n      }\n      if (!this._blurFramebuffer || this._blurFramebuffer.disposed) {\n        this._blurFramebuffer = device.createFrameBuffer({ colorAttachments: [{ texture: this._blurMap }] });\n      }\n      if (!this._blurFramebuffer2 || this._blurFramebuffer2.disposed) {\n        this._blurFramebuffer2 = device.createFrameBuffer({ colorAttachments: [{ texture: this._blurMap2 }] });\n      }\n    }\n    this._shadowSampler = null;\n  }\n  postRenderShadowMap(shadowMapper: ShadowMapper) {\n    if (this._blur) {\n      this._blitterH.blurSize = this._blurSize / shadowMapper.getColorAttachment().width;\n      this._blitterH.kernelSize = this._kernelSize;\n      this._blitterH.logSpace = this._logSpace;\n      this._blitterH.packFloat = shadowMapper.getColorAttachment().format === TextureFormat.RGBA8UNORM;\n      this._blitterV.blurSize = this._blurSize / shadowMapper.getColorAttachment().height;\n      this._blitterV.kernelSize = this._kernelSize;\n      this._blitterV.logSpace = this._logSpace;\n      this._blitterV.packFloat = shadowMapper.getColorAttachment().format === TextureFormat.RGBA8UNORM;\n      this._blitterH.blit(shadowMapper.getColorAttachment() as any, this._blurFramebuffer as any);\n      this._blitterV.blit(this._blurMap as any, this._blurFramebuffer2 as any);\n    }\n  }\n  getDepthScale(): number {\n    return this._depthScale;\n  }\n  setDepthScale(val: number) {\n    this._depthScale = val;\n  }\n  isSupported(shadowMapper: ShadowMapper): boolean {\n    return this.getShadowMapColorFormat(shadowMapper) !== TextureFormat.Unknown && this.getShadowMapDepthFormat(shadowMapper) !== TextureFormat.Unknown;\n  }\n  getShaderHash(): string {\n    return '';\n  }\n  getShadowMapColorFormat(shadowMapper: ShadowMapper): TextureFormat {\n    const device = shadowMapper.light.scene.device;\n    return device.getTextureCaps().supportHalfFloatColorBuffer\n      ? device.getDeviceType() === 'webgl' ? TextureFormat.RGBA16F : TextureFormat.R16F\n      : device.getTextureCaps().supportFloatColorBuffer\n        ? device.getDeviceType() === 'webgl' ? TextureFormat.RGBA32F : TextureFormat.R32F\n        : TextureFormat.RGBA8UNORM;\n  }\n  getShadowMapDepthFormat(shadowMapper: ShadowMapper): TextureFormat {\n    return TextureFormat.D24S8;\n  }\n  computeShadowMapDepth(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope): PBShaderExp {\n    return computeShadowMapDepth(scope, shadowMapper.shadowMap.format);\n  }\n  computeShadowCSM(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope, shadowVertex: PBShaderExp, NdotL: PBShaderExp, split: PBShaderExp): PBShaderExp {\n    const funcNameComputeShadowCSM = 'lib_computeShadowCSM';\n    const pb = scope.$builder;\n    const lib = new ShaderLib(pb);\n    if (!pb.getFunction(funcNameComputeShadowCSM)) {\n      pb.globalScope.$function(funcNameComputeShadowCSM, [pb.vec4('shadowVertex'), pb.float('NdotL'), pb.int('split')], function () {\n        this.$l.shadowCoord = pb.div(this.shadowVertex, this.shadowVertex.w);\n        this.$l.shadowCoord = pb.add(pb.mul(this.shadowCoord, 0.5), 0.5);\n        this.$l.inShadow = pb.all(pb.bvec2(pb.all(pb.bvec4(pb.greaterThanEqual(this.shadowCoord.x, 0), pb.lessThanEqual(this.shadowCoord.x, 1), pb.greaterThanEqual(this.shadowCoord.y, 0), pb.lessThanEqual(this.shadowCoord.y, 1))), pb.lessThanEqual(this.shadowCoord.z, 1)));\n        this.$l.shadow = pb.float(1);\n        this.$if(this.inShadow, function () {\n          this.shadow = filterShadowESM(this, shadowMapper.light.lightType, shadowMapper.shadowMap.format, this.shadowCoord, this.split);\n        });\n        this.$return(this.shadow);\n      });\n    }\n    return pb.globalScope[funcNameComputeShadowCSM](shadowVertex, NdotL, split);\n  }\n  computeShadow(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope, shadowVertex: PBShaderExp, NdotL: PBShaderExp): PBShaderExp {\n    const funcNameComputeShadow = 'lib_computeShadow';\n    const pb = scope.$builder;\n    if (!pb.getFunction(funcNameComputeShadow)) {\n      pb.globalScope.$function(funcNameComputeShadow, [pb.vec4('shadowVertex'), pb.float('NdotL')], function () {\n        if (shadowMapper.light.isPointLight()) {\n          this.$return(filterShadowESM(this, shadowMapper.light.lightType, shadowMapper.shadowMap.format, this.shadowVertex));\n        } else {\n          this.$l.shadowCoord = pb.div(this.shadowVertex, this.shadowVertex.w);\n          this.$l.shadowCoord = pb.add(pb.mul(this.shadowCoord, 0.5), 0.5);\n          this.$l.inShadow = pb.all(pb.bvec2(pb.all(pb.bvec4(pb.greaterThanEqual(this.shadowCoord.x, 0), pb.lessThanEqual(this.shadowCoord.x, 1), pb.greaterThanEqual(this.shadowCoord.y, 0), pb.lessThanEqual(this.shadowCoord.y, 1))), pb.lessThanEqual(this.shadowCoord.z, 1)));\n          this.$l.shadow = pb.float(1);\n          this.$if(this.inShadow, function () {\n            this.shadow = filterShadowESM(this, shadowMapper.light.lightType, shadowMapper.shadowMap.format, this.shadowCoord);\n          });\n          this.$return(this.shadow);\n        }\n      });\n    }\n    return pb.globalScope[funcNameComputeShadow](shadowVertex, NdotL);\n  }\n  useNativeShadowMap(shadowMapper: ShadowMapper): boolean {\n    return false;\n  }\n}\n"],"names":[],"mappings":"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"}
{"version":3,"file":"ssm.js","sources":["../../../../../libs/device/src/scene/shadow/ssm.ts"],"sourcesContent":["import { ShadowImpl } from \"./shadow_impl\";\r\nimport { TextureFormat, PBInsideFunctionScope, PBShaderExp, TextureSampler } from \"../../device\";\r\nimport { ShaderLib } from \"../materiallib/shaderlib\";\r\nimport type { ShadowMapper, ShadowMapType, ShadowMode } from \"./shadowmapper\";\r\n\r\nexport class SSM extends ShadowImpl {\r\n  static instance = new SSM();\r\n  private _shadowSampler: TextureSampler;\r\n  constructor() {\r\n    super();\r\n    this._shadowSampler = null;\r\n  }\r\n  isSupported(shadowMapper: ShadowMapper): boolean {\r\n    return this.getShadowMapColorFormat(shadowMapper) !== TextureFormat.Unknown && this.getShadowMapDepthFormat(shadowMapper) !== TextureFormat.Unknown;\r\n  }\r\n  resourceDirty(): boolean {\r\n    return false;\r\n  }\r\n  getType(): ShadowMode {\r\n    return 'hard';\r\n  }\r\n  dispose(): void {\r\n    this._shadowSampler = null;\r\n  }\r\n  getShadowMap(shadowMapper: ShadowMapper): ShadowMapType {\r\n    return this.useNativeShadowMap(shadowMapper) ? shadowMapper.getDepthAttachment() : shadowMapper.getColorAttachment();\r\n  }\r\n  getShadowMapSampler(shadowMapper: ShadowMapper): TextureSampler {\r\n    if (!this._shadowSampler) {\r\n      this._shadowSampler = this.getShadowMap(shadowMapper)?.getDefaultSampler(this.useNativeShadowMap(shadowMapper)) || null;\r\n    }\r\n    return this._shadowSampler;\r\n  }\r\n  doUpdateResources() {\r\n    this._shadowSampler = null;\r\n  }\r\n  postRenderShadowMap() {\r\n  }\r\n  getDepthScale(): number {\r\n    return 1;\r\n  }\r\n  setDepthScale(val: number) {\r\n  }\r\n  getShaderHash(): string {\r\n    return '';\r\n  }\r\n  getShadowMapColorFormat(shadowMapper: ShadowMapper): TextureFormat {\r\n    if (this.useNativeShadowMap(shadowMapper)) {\r\n      return TextureFormat.RGBA8UNORM;\r\n    } else {\r\n      const device = shadowMapper.light.scene.device;\r\n      return device.getTextureCaps().supportHalfFloatColorBuffer\r\n        ? device.getDeviceType() === 'webgl' ? TextureFormat.RGBA16F : TextureFormat.R16F\r\n        : device.getTextureCaps().supportFloatColorBuffer\r\n          ? device.getDeviceType() === 'webgl' ? TextureFormat.RGBA32F : TextureFormat.R32F\r\n          : TextureFormat.RGBA8UNORM;\r\n    }\r\n  }\r\n  getShadowMapDepthFormat(shadowMapper: ShadowMapper): TextureFormat {\r\n    return shadowMapper.light.scene.device.getDeviceType() === 'webgl' ? TextureFormat.D24S8 : TextureFormat.D32F;\r\n  }\r\n  computeShadowMapDepth(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope): PBShaderExp {\r\n    if (this.useNativeShadowMap(shadowMapper)) {\r\n      return scope.$builder.vec4(scope.$builder.emulateDepthClamp ? scope.$builder.clamp(scope.$inputs.clamppedDepth, 0, 1) : scope.$builtins.fragCoord.z, 0, 0, 1);\r\n    } else {\r\n      const pb = scope.$builder;\r\n      const lib = new ShaderLib(pb);\r\n      let depth: PBShaderExp = null;\r\n      if (shadowMapper.light.isDirectionLight()) {\r\n        depth = pb.emulateDepthClamp ? pb.clamp(scope.$inputs.clamppedDepth, 0, 1) : scope.$builtins.fragCoord.z;\r\n      } else if (shadowMapper.light.isPointLight()) {\r\n        const lightSpacePos = pb.mul(scope.global.light.viewMatrix, pb.vec4(scope.$query(ShaderLib.USAGE_WORLD_POSITION).xyz, 1));\r\n        depth = pb.div(pb.length(lightSpacePos.xyz), scope.global.light.positionRange.w);\r\n      } else if (shadowMapper.light.isSpotLight()) {\r\n        const lightSpacePos = pb.mul(scope.global.light.viewMatrix, pb.vec4(scope.$query(ShaderLib.USAGE_WORLD_POSITION).xyz, 1));\r\n        depth = pb.min(pb.div(pb.neg(lightSpacePos.z), scope.global.light.positionRange.w), 1);\r\n      }\r\n      return shadowMapper.shadowMap.format === TextureFormat.RGBA8UNORM ? lib.encodeNormalizedFloatToRGBA(depth) : pb.vec4(depth, 0, 0, 1);\r\n    }\r\n  }\r\n  computeShadowCSM(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope, shadowVertex: PBShaderExp, NdotL: PBShaderExp, split: PBShaderExp): PBShaderExp {\r\n    const funcNameComputeShadowCSM = 'lib_computeShadowCSM';\r\n    const pb = scope.$builder;\r\n    const lib = new ShaderLib(pb);\r\n    const that = this;\r\n    if (!pb.getFunction(funcNameComputeShadowCSM)) {\r\n      pb.globalScope.$function(funcNameComputeShadowCSM, [pb.vec4('shadowVertex'), pb.float('NdotL'), pb.int('split')], function () {\r\n        const floatDepthTexture = shadowMapper.shadowMap.format !== TextureFormat.RGBA8UNORM;\r\n        this.$l.shadowCoord = pb.div(this.shadowVertex.xyz, this.shadowVertex.w);\r\n        this.$l.shadowCoord = pb.add(pb.mul(this.shadowCoord.xyz, 0.5), 0.5);\r\n        this.$l.inShadow = pb.all(pb.bvec2(pb.all(pb.bvec4(pb.greaterThanEqual(this.shadowCoord.x, 0), pb.lessThanEqual(this.shadowCoord.x, 1), pb.greaterThanEqual(this.shadowCoord.y, 0), pb.lessThanEqual(this.shadowCoord.y, 1))), pb.lessThanEqual(this.shadowCoord.z, 1)));\r\n        this.$l.shadow = pb.float(1);\r\n        this.$if(this.inShadow, function () {\r\n          this.$l.shadowBias = shadowMapper.computeShadowBiasCSM(this, this.NdotL, this.split);\r\n          this.shadowCoord.z = pb.sub(this.shadowCoord.z, this.shadowBias);\r\n          if (that.useNativeShadowMap(shadowMapper)) {\r\n            if (shadowMapper.shadowMap.isTexture2DArray()) {\r\n              this.shadow = pb.textureArraySampleCompareLevel(this.shadowMap, this.shadowCoord.xy, this.split, this.shadowCoord.z);\r\n            } else {\r\n              this.shadow = pb.textureSampleCompareLevel(this.shadowMap, this.shadowCoord.xy, this.shadowCoord.z);\r\n            }\r\n          } else {\r\n            if (shadowMapper.shadowMap.isTexture2DArray()) {\r\n              this.$l.shadowTex = pb.textureArraySampleLevel(this.shadowMap, this.shadowCoord.xy, this.split, 0);\r\n            } else {\r\n              this.$l.shadowTex = pb.textureSampleLevel(this.shadowMap, this.shadowCoord.xy, 0);\r\n            }\r\n            if (!floatDepthTexture) {\r\n              this.shadowTex.x = lib.decodeNormalizedFloatFromRGBA(this.shadowTex);\r\n            }\r\n            this.shadow = pb.step(this.shadowCoord.z, this.shadowTex.x);\r\n          }\r\n        });\r\n        this.$return(this.shadow);\r\n      });\r\n    }\r\n    return pb.globalScope[funcNameComputeShadowCSM](shadowVertex, NdotL, split);\r\n  }\r\n  computeShadow(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope, shadowVertex: PBShaderExp, NdotL: PBShaderExp): PBShaderExp {\r\n    const funcNameComputeShadow = 'lib_computeShadow';\r\n    const pb = scope.$builder;\r\n    const lib = new ShaderLib(pb);\r\n    const that = this;\r\n    if (!pb.getFunction(funcNameComputeShadow)) {\r\n      pb.globalScope.$function(funcNameComputeShadow, [pb.vec4('shadowVertex'), pb.float('NdotL')], function () {\r\n        const floatDepthTexture = shadowMapper.shadowMap.format !== TextureFormat.RGBA8UNORM;\r\n        if (shadowMapper.light.isPointLight()) {\r\n          if (that.useNativeShadowMap(shadowMapper)) {\r\n            this.$l.nearFar = pb.getDeviceType() === 'webgl' ? this.global.light.shadowCameraParams.xy : this.global.light.lightParams[5].xy;\r\n            this.$l.distance = lib.linearToNonLinear(pb.max(pb.max(pb.abs(this.shadowVertex.x), pb.abs(this.shadowVertex.y)), pb.abs(this.shadowVertex.z)), this.nearFar);\r\n            this.$l.shadowBias = shadowMapper.computeShadowBias(this, this.distance, this.NdotL);\r\n            this.$return(pb.textureSampleCompareLevel(this.shadowMap, this.shadowVertex.xyz, pb.sub(this.distance, this.shadowBias)));\r\n          } else {\r\n            this.$l.distance = pb.length(this.shadowVertex.xyz);\r\n            this.$l.distance = pb.div(this.$l.distance, this.global.light.lightParams[0].w);\r\n            this.$l.shadowBias = shadowMapper.computeShadowBias(this, this.distance, this.NdotL);\r\n            this.$l.shadowTex = pb.textureSampleLevel(this.shadowMap, this.shadowVertex.xyz, 0);\r\n            if (!floatDepthTexture) {\r\n              this.shadowTex.x = lib.decodeNormalizedFloatFromRGBA(this.shadowTex);\r\n            }\r\n            this.distance = pb.sub(this.distance, this.shadowBias);\r\n            this.$return(pb.step(this.distance, this.shadowTex.x));\r\n          }\r\n        } else {\r\n          this.$l.shadowCoord = pb.div(this.shadowVertex.xyz, this.shadowVertex.w);\r\n          this.$l.shadowCoord = pb.add(pb.mul(this.shadowCoord.xyz, 0.5), 0.5);\r\n          this.$l.inShadow = pb.all(pb.bvec2(pb.all(pb.bvec4(pb.greaterThanEqual(this.shadowCoord.x, 0), pb.lessThanEqual(this.shadowCoord.x, 1), pb.greaterThanEqual(this.shadowCoord.y, 0), pb.lessThanEqual(this.shadowCoord.y, 1))), pb.lessThanEqual(this.shadowCoord.z, 1)));\r\n          this.$l.shadow = pb.float(1);\r\n          this.$if(this.inShadow, function () {\r\n            if (that.useNativeShadowMap(shadowMapper)) {\r\n              this.$l.shadowBias = shadowMapper.computeShadowBias(this, this.shadowCoord.z, this.NdotL);\r\n              this.shadowCoord.z = pb.sub(this.shadowCoord.z, this.shadowBias);\r\n              this.shadow = pb.textureSampleCompareLevel(this.shadowMap, this.shadowCoord.xy, this.shadowCoord.z);\r\n            } else {\r\n              if (shadowMapper.light.isSpotLight()) {\r\n                this.$l.nearFar = pb.getDeviceType() === 'webgl' ? this.global.light.shadowCameraParams.xy : this.global.light.lightParams[5].xy;\r\n                this.shadowCoord.z = lib.nonLinearDepthToLinearNormalized(this.shadowCoord.z, this.nearFar);\r\n              }\r\n              this.$l.shadowBias = shadowMapper.computeShadowBias(this, this.shadowCoord.z, this.NdotL);\r\n              this.shadowCoord.z = pb.sub(this.shadowCoord.z, this.shadowBias);\r\n              this.$l.shadowTex = pb.textureSampleLevel(this.shadowMap, this.shadowCoord.xy, 0);\r\n              if (!floatDepthTexture) {\r\n                this.shadowTex.x = lib.decodeNormalizedFloatFromRGBA(this.shadowTex);\r\n              }\r\n              this.shadow = pb.step(this.shadowCoord.z, this.shadowTex.x);\r\n            }\r\n          });\r\n          this.$return(this.shadow);\r\n        }\r\n      });\r\n    }\r\n    return pb.globalScope[funcNameComputeShadow](shadowVertex, NdotL);\r\n  }\r\n  useNativeShadowMap(shadowMapper: ShadowMapper): boolean {\r\n    return shadowMapper.light.scene.device.getDeviceType() !== 'webgl';\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}
{"version":3,"file":"pcf_pd.js","sources":["../../../../../libs/device/src/scene/shadow/pcf_pd.ts"],"sourcesContent":["import { ShadowImpl } from './shadow_impl';\r\nimport { ShaderLib } from '../materiallib';\r\nimport { CompareFunc, PBInsideFunctionScope, PBShaderExp, TextureFilter, TextureFormat, TextureSampler } from '../../device';\r\nimport * as lib from '../renderers/shadowmap.shaderlib';\r\nimport type { ShadowMapper, ShadowMapType, ShadowMode } from './shadowmapper';\r\n\r\nexport class PCFPD extends ShadowImpl {\r\n  protected _tapCount: number;\r\n  protected _sampleRadius: number;\r\n  protected _shadowSampler: TextureSampler;\r\n  constructor(tapCount?: number, sampleRadius?: number) {\r\n    super();\r\n    this._tapCount = tapCount ?? 3;\r\n    this._sampleRadius = sampleRadius ?? 1;\r\n    this._shadowSampler = null;\r\n  }\r\n  get tapCount(): number {\r\n    return this._tapCount;\r\n  }\r\n  set tapCount(val: number) {\r\n    this._tapCount = val;\r\n  }\r\n  getType(): ShadowMode {\r\n    return 'pcf-pd';\r\n  }\r\n  dispose(): void {\r\n    this._shadowSampler = null;\r\n  }\r\n  isSupported(shadowMapper: ShadowMapper): boolean {\r\n    return this.getShadowMapColorFormat(shadowMapper) !== TextureFormat.Unknown && this.getShadowMapDepthFormat(shadowMapper) !== TextureFormat.Unknown;\r\n  }\r\n  resourceDirty(): boolean {\r\n    return false;\r\n  }\r\n  getShadowMap(shadowMapper: ShadowMapper): ShadowMapType {\r\n    return this.useNativeShadowMap(shadowMapper) ? shadowMapper.getDepthAttachment() : shadowMapper.getColorAttachment();\r\n  }\r\n  getShadowMapSampler(shadowMapper: ShadowMapper): TextureSampler {\r\n    if (!this._shadowSampler) {\r\n      this._shadowSampler = this.getShadowMap(shadowMapper)?.getDefaultSampler(this.useNativeShadowMap(shadowMapper)) || null;\r\n    }\r\n    return this._shadowSampler;\r\n  }\r\n  doUpdateResources() {\r\n    this._shadowSampler = null;\r\n  }\r\n  postRenderShadowMap() {\r\n  }\r\n  getDepthScale(): number {\r\n    return this._sampleRadius;\r\n  }\r\n  setDepthScale(val: number) {\r\n    this._sampleRadius = val;\r\n  }\r\n  getShaderHash(): string {\r\n    return `${this._tapCount}`;\r\n  }\r\n  getShadowMapColorFormat(shadowMapper: ShadowMapper): TextureFormat {\r\n    if (this.useNativeShadowMap(shadowMapper)) {\r\n      return TextureFormat.RGBA8UNORM;\r\n    } else {\r\n      const device = shadowMapper.light.scene.device;\r\n      return device.getTextureCaps().supportHalfFloatColorBuffer\r\n        ? device.getDeviceType() === 'webgl' ? TextureFormat.RGBA16F : TextureFormat.R16F\r\n        : device.getTextureCaps().supportFloatColorBuffer\r\n          ? device.getDeviceType() === 'webgl' ? TextureFormat.RGBA32F : TextureFormat.R32F\r\n          : TextureFormat.RGBA8UNORM;\r\n    }\r\n  }\r\n  getShadowMapDepthFormat(shadowMapper: ShadowMapper): TextureFormat {\r\n    return shadowMapper.light.scene.device.getDeviceType() === 'webgl' ? TextureFormat.D24S8 : TextureFormat.D32F;\r\n  }\r\n  computeShadowMapDepth(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope): PBShaderExp {\r\n    return lib.computeShadowMapDepth(scope, shadowMapper.shadowMap.format);\r\n  }\r\n  computeShadowCSM(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope, shadowVertex: PBShaderExp, NdotL: PBShaderExp, split: PBShaderExp): PBShaderExp {\r\n    const funcNameComputeShadowCSM = 'lib_computeShadowCSM';\r\n    const pb = scope.$builder;\r\n    const that = this;\r\n    if (!pb.getFunction(funcNameComputeShadowCSM)) {\r\n      pb.globalScope.$function(funcNameComputeShadowCSM, [pb.vec4('shadowVertex'), pb.float('NdotL'), pb.int('split')], function () {\r\n        this.$l.shadowCoord = pb.div(this.shadowVertex, this.shadowVertex.w);\r\n        this.$l.shadowCoord = pb.add(pb.mul(this.shadowCoord, 0.5), 0.5);\r\n        this.$l.inShadow = pb.all(pb.bvec2(pb.all(pb.bvec4(pb.greaterThanEqual(this.shadowCoord.x, 0), pb.lessThanEqual(this.shadowCoord.x, 1), pb.greaterThanEqual(this.shadowCoord.y, 0), pb.lessThanEqual(this.shadowCoord.y, 1))), pb.lessThanEqual(this.shadowCoord.z, 1)));\r\n        this.$l.shadow = pb.float(1);\r\n        this.$l.receiverPlaneDepthBias = lib.computeReceiverPlaneDepthBias(this, this.shadowCoord);\r\n        this.$if(this.inShadow, function () {\r\n          this.$l.shadowBias = shadowMapper.computeShadowBiasCSM(this, this.NdotL, this.split);\r\n          this.shadowCoord.z = pb.sub(this.shadowCoord.z, this.shadowBias);\r\n          this.shadow = lib.filterShadowPoissonDisc(this, shadowMapper.light.lightType, shadowMapper.shadowMap.format, that._tapCount, this.shadowCoord, this.receiverPlaneDepthBias, this.split);\r\n        });\r\n        this.$return(this.shadow);\r\n      });\r\n    }\r\n    return pb.globalScope[funcNameComputeShadowCSM](shadowVertex, NdotL, split);\r\n  }\r\n  computeShadow(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope, shadowVertex: PBShaderExp, NdotL: PBShaderExp): PBShaderExp {\r\n    const funcNameComputeShadow = 'lib_computeShadow';\r\n    const pb = scope.$builder;\r\n    const shaderlib = new ShaderLib(pb);\r\n    const that = this;\r\n    if (!pb.getFunction(funcNameComputeShadow)) {\r\n      pb.globalScope.$function(funcNameComputeShadow, [pb.vec4('shadowVertex'), pb.float('NdotL')], function () {\r\n        if (shadowMapper.light.isPointLight()) {\r\n          if (that.useNativeShadowMap(shadowMapper)) {\r\n            this.$l.nearFar = pb.getDeviceType() === 'webgl' ? this.global.light.shadowCameraParams.xy : this.global.light.lightParams[5].xy;\r\n            this.$l.distance = shaderlib.linearToNonLinear(pb.max(pb.max(pb.abs(this.shadowVertex.x), pb.abs(this.shadowVertex.y)), pb.abs(this.shadowVertex.z)), this.nearFar);\r\n            this.$l.shadowBias = shadowMapper.computeShadowBias(this, this.distance, this.NdotL);\r\n            this.$return(that.sampleShadowMap(shadowMapper, this, this.shadowVertex, this.distance, this.shadowBias));\r\n          } else {\r\n            this.$l.distance = pb.length(this.shadowVertex.xyz);\r\n            this.$l.distance = pb.div(this.$l.distance, this.global.light.lightParams[0].w);\r\n            this.$l.shadowBias = shadowMapper.computeShadowBias(this, this.distance, this.NdotL);\r\n            this.$return(that.sampleShadowMap(shadowMapper, this, this.shadowVertex, this.distance, this.shadowBias));\r\n          }\r\n        } else {\r\n          this.$l.shadowCoord = pb.div(this.shadowVertex, this.shadowVertex.w);\r\n          this.$l.shadowCoord = pb.add(pb.mul(this.shadowCoord, 0.5), 0.5);\r\n          this.$l.inShadow = pb.all(pb.bvec2(pb.all(pb.bvec4(pb.greaterThanEqual(this.shadowCoord.x, 0), pb.lessThanEqual(this.shadowCoord.x, 1), pb.greaterThanEqual(this.shadowCoord.y, 0), pb.lessThanEqual(this.shadowCoord.y, 1))), pb.lessThanEqual(this.shadowCoord.z, 1)));\r\n          this.$l.shadow = pb.float(1);\r\n          this.$l.receiverPlaneDepthBias = lib.computeReceiverPlaneDepthBias(this, this.shadowCoord);\r\n          this.$if(this.inShadow, function () {\r\n            this.$l.shadowBias = shadowMapper.computeShadowBias(this, this.shadowCoord.z, this.NdotL);\r\n            this.shadowCoord.z = pb.sub(this.shadowCoord.z, this.shadowBias);\r\n            this.shadow = lib.filterShadowPoissonDisc(this, shadowMapper.light.lightType, shadowMapper.shadowMap.format, that._tapCount, this.shadowCoord, this.receiverPlaneDepthBias);\r\n          });\r\n          this.$return(this.shadow);\r\n        }\r\n      });\r\n    }\r\n    return pb.globalScope[funcNameComputeShadow](shadowVertex, NdotL);\r\n  }\r\n  useNativeShadowMap(shadowMapper: ShadowMapper): boolean {\r\n    return shadowMapper.light.scene.device.getDeviceType() !== 'webgl';\r\n  }\r\n  /** @internal */\r\n  sampleShadowMap(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope, coords: PBShaderExp, z: PBShaderExp, bias: PBShaderExp): PBShaderExp {\r\n    const funcNameSampleShadowMap = 'lib_sampleShadowMap';\r\n    const pb = scope.$builder;\r\n    const lib = new ShaderLib(pb);\r\n    const that = this;\r\n    if (!pb.getFunction(funcNameSampleShadowMap)) {\r\n      pb.globalScope.$function(funcNameSampleShadowMap, [pb.vec4('coords'), pb.float('z'), pb.float('bias')], function () {\r\n        const floatDepthTexture = shadowMapper.shadowMap.format !== TextureFormat.RGBA8UNORM;\r\n        if (shadowMapper.light.isPointLight()) {\r\n          if (this.useNativeShadowMap(shadowMapper)) {\r\n            this.$return(pb.clamp(pb.textureSampleCompareLevel(this.shadowMap, this.coords.xyz, pb.sub(this.z, this.bias)), 0, 1));\r\n          } else {\r\n            this.$l.shadowTex = pb.textureSampleLevel(this.shadowMap, this.coords.xyz, 0);\r\n            if (!floatDepthTexture) {\r\n              this.shadowTex.x = lib.decodeNormalizedFloatFromRGBA(this.shadowTex);\r\n            }\r\n            this.$l.distance = pb.sub(this.z, this.bias);\r\n            this.$return(pb.step(this.distance, this.shadowTex.x));\r\n          }\r\n        } else {\r\n          this.$l.distance = pb.sub(this.z, this.bias);\r\n          if (that.useNativeShadowMap(shadowMapper)) {\r\n            this.$return(pb.clamp(pb.textureSampleCompareLevel(this.shadowMap, this.coords.xy, this.distance), 0, 1));\r\n          } else {\r\n            this.$l.shadowTex = pb.textureSampleLevel(this.shadowMap, this.coords.xy, 0);\r\n            if (!floatDepthTexture) {\r\n              this.shadowTex.x = lib.decodeNormalizedFloatFromRGBA(this.shadowTex);\r\n            }\r\n            this.$return(pb.step(this.distance, this.shadowTex.x));\r\n          }\r\n        }\r\n      });\r\n    }\r\n    return pb.globalScope[funcNameSampleShadowMap](coords, z, bias);\r\n  }\r\n  /** @internal */\r\n  sampleShadowMapCSM(shadowMapper: ShadowMapper, scope: PBInsideFunctionScope, coords: PBShaderExp, split: PBShaderExp, z: PBShaderExp, bias: PBShaderExp): PBShaderExp {\r\n    const funcNameSampleShadowMapCSM = 'lib_sampleShadowMapCSM';\r\n    const pb = scope.$builder;\r\n    const lib = new ShaderLib(pb);\r\n    const that = this;\r\n    if (!pb.getFunction(funcNameSampleShadowMapCSM)) {\r\n      pb.globalScope.$function(funcNameSampleShadowMapCSM, [pb.vec4('coords'), pb.int('split'), pb.float('z'), pb.float('bias')], function () {\r\n        const floatDepthTexture = shadowMapper.shadowMap.format !== TextureFormat.RGBA8UNORM;\r\n        this.$l.distance = pb.sub(this.z, this.bias);\r\n        if (that.useNativeShadowMap(shadowMapper)) {\r\n          if (shadowMapper.shadowMap.isTexture2DArray()) {\r\n            this.$return(pb.clamp(pb.textureArraySampleCompareLevel(this.shadowMap, this.coords.xy, this.split, this.distance), 0, 1));\r\n          } else {\r\n            this.$return(pb.clamp(pb.textureSampleCompareLevel(this.shadowMap, this.coords.xy, this.distance), 0, 1));\r\n          }\r\n        } else {\r\n          if (shadowMapper.shadowMap.isTexture2DArray()) {\r\n            this.$l.shadowTex = pb.textureArraySampleLevel(this.shadowMap, this.coords.xy, this.split, 0);\r\n          } else {\r\n            this.$l.shadowTex = pb.textureSampleLevel(this.shadowMap, this.coords.xy, 0);\r\n          }\r\n          if (!floatDepthTexture) {\r\n            this.shadowTex.x = lib.decodeNormalizedFloatFromRGBA(this.shadowTex);\r\n          }\r\n          this.$return(pb.step(this.distance, this.shadowTex.x));\r\n        }\r\n      });\r\n    }\r\n    return pb.globalScope[funcNameSampleShadowMapCSM](coords, split, z, bias);\r\n  }\r\n}\r\n\r\n"],"names":["lib.computeShadowMapDepth","lib.computeReceiverPlaneDepthBias","lib.filterShadowPoissonDisc"],"mappings":"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"}
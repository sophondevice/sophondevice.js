{"version":3,"file":"orbit.js","sources":["../../../../../libs/device/src/scene/cameralib/orbit.ts"],"sourcesContent":["import { Vector3, Quaternion } from '@sophon/base';\nimport { BaseCameraModel } from './base';\nimport type { AbstractCameraModel, IMouseEvent } from '../camera';\nexport interface IOrbitCameraModelOptions {\n  distance?: number;\n  damping?: number;\n  zoomSpeed?: number;\n  rotateSpeed?: number;\n}\n\nexport class OrbitCameraModel extends BaseCameraModel implements AbstractCameraModel {\n  /** @internal */\n  private options: IOrbitCameraModelOptions;\n  /** @internal */\n  private mouseDown: boolean;\n  /** @internal */\n  private lastMouseX: number;\n  /** @internal */\n  private lastMouseY: number;\n  /** @internal */\n  private rotateX: number;\n  /** @internal */\n  private rotateY: number;\n  /** @internal */\n  private eyePos: Vector3;\n  /** @internal */\n  private upVector: Vector3;\n  /** @internal */\n  private xVector: Vector3;\n  /** @internal */\n  private target: Vector3;\n  /** @internal */\n  private direction: Vector3;\n  /** @internal */\n  private quat: Quaternion;\n  /** @internal */\n  private scale: number;\n  constructor(options?: IOrbitCameraModelOptions) {\n    super();\n    this.options = Object.assign(\n      {\n        distance: 1,\n        damping: 0.1,\n        moveSpeed: 0.2,\n        rotateSpeed: 0.01,\n        zoomSpeed: 1,\n      },\n      options || {},\n    );\n    this.rotateX = 0;\n    this.rotateY = 0;\n    this.eyePos = new Vector3();\n    this.upVector = Vector3.axisPY();\n    this.xVector = new Vector3();\n    this.target = new Vector3();\n    this.direction = new Vector3();\n    this.quat = new Quaternion();\n    this.scale = 1;\n  }\n  reset() {\n    this.mouseDown = false;\n    this.lastMouseX = 0;\n    this.lastMouseY = 0;\n    this.rotateX = 0;\n    this.rotateY = 0;\n    this.scale = 1;\n    this._loadCameraParams();\n  }\n  /** @internal */\n  protected _onMouseDown(evt: IMouseEvent) {\n    if (evt.button === 0) {\n      this.mouseDown = true;\n      this.lastMouseX = evt.offsetX;\n      this.lastMouseY = evt.offsetY;\n      this.rotateX = 0;\n      this.rotateY = 0;\n    }\n  }\n  /** @internal */\n  protected _onMouseUp(evt: IMouseEvent) {\n    if (evt.button === 0) {\n      this.mouseDown = false;\n    }\n  }\n  /** @internal */\n  protected _onMouseWheel(evt: IMouseEvent) {\n    const factor = Math.pow(0.9, Math.abs(this.options.zoomSpeed));\n    if (evt.wheelDeltaY > 0) {\n      this.scale /= factor;\n    } else {\n      this.scale *= factor;\n    }\n  }\n  /** @internal */\n  protected _onMouseMove(evt: IMouseEvent) {\n    if (this.mouseDown) {\n      const dx = evt.offsetX - this.lastMouseX;\n      const dy = evt.offsetY - this.lastMouseY;\n      this.lastMouseX = evt.offsetX;\n      this.lastMouseY = evt.offsetY;\n      this.rotateX -= dy * this.options.rotateSpeed;\n      this.rotateY -= dx * this.options.rotateSpeed;\n    }\n  }\n  /** @internal */\n  private _loadCameraParams() {\n    if (this._getCamera()) {\n      const mat = this._getCamera().worldMatrix;\n      mat.decomposeLookAt(this.eyePos, this.target);\n      Vector3.normalize(Vector3.sub(this.eyePos, this.target), this.direction);\n      Vector3.sub(this.eyePos, Vector3.scale(this.direction, this.options.distance), this.target);\n      mat.getRow3(0, this.xVector);\n    }\n  }\n  setOptions(opt?: IOrbitCameraModelOptions) {\n    opt && Object.assign(this.options, opt);\n    this.reset();\n  }\n  update() {\n    if (this._getCamera()) {\n      Quaternion.fromAxisAngle(this.xVector, this.rotateX, this.quat);\n      this.quat.transform(this.eyePos.subBy(this.target), this.eyePos);\n      Quaternion.fromEulerAngle(0, this.rotateY, 0, 'XYZ', this.quat);\n      this.quat.transform(this.eyePos, this.eyePos);\n      this.quat.transform(this.xVector, this.xVector).inplaceNormalize();\n      Vector3.normalize(this.eyePos, this.direction).inplaceNormalize();\n      Vector3.cross(this.direction, this.xVector, this.upVector).inplaceNormalize();\n      Vector3.add(this.target, Vector3.scale(this.direction, this.options.distance * this.scale), this.eyePos);\n      this._getCamera().lookAt(this.eyePos, this.target, this.upVector);\n      // this._loadCameraParams();\n      if (this.mouseDown) {\n        this.rotateX = 0;\n        this.rotateY = 0;\n      } else {\n        this.rotateX *= 1 - this.options.damping;\n        this.rotateY *= 1 - this.options.damping;\n        if (Math.abs(this.rotateX) < 0.0001) {\n          this.rotateX = 0;\n        }\n        if (Math.abs(this.rotateY) < 0.0001) {\n          this.rotateY = 0;\n        }\n      }\n    }\n  }\n}\n"],"names":[],"mappings":"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"}
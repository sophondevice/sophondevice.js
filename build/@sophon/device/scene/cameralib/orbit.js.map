{"version":3,"file":"orbit.js","sources":["../../../../../libs/device/src/scene/cameralib/orbit.ts"],"sourcesContent":["import { Vector3, Quaternion } from '@sophon/base';\r\nimport { BaseCameraModel } from './base';\r\nimport type { AbstractCameraModel, IMouseEvent } from '../camera';\r\nexport interface IOrbitCameraModelOptions {\r\n  distance?: number;\r\n  damping?: number;\r\n  zoomSpeed?: number;\r\n  rotateSpeed?: number;\r\n}\r\n\r\nexport class OrbitCameraModel extends BaseCameraModel implements AbstractCameraModel {\r\n  /** @internal */\r\n  private options: IOrbitCameraModelOptions;\r\n  /** @internal */\r\n  private mouseDown: boolean;\r\n  /** @internal */\r\n  private lastMouseX: number;\r\n  /** @internal */\r\n  private lastMouseY: number;\r\n  /** @internal */\r\n  private rotateX: number;\r\n  /** @internal */\r\n  private rotateY: number;\r\n  /** @internal */\r\n  private eyePos: Vector3;\r\n  /** @internal */\r\n  private upVector: Vector3;\r\n  /** @internal */\r\n  private xVector: Vector3;\r\n  /** @internal */\r\n  private target: Vector3;\r\n  /** @internal */\r\n  private direction: Vector3;\r\n  /** @internal */\r\n  private quat: Quaternion;\r\n  /** @internal */\r\n  private scale: number;\r\n  constructor(options?: IOrbitCameraModelOptions) {\r\n    super();\r\n    this.options = Object.assign(\r\n      {\r\n        distance: 1,\r\n        damping: 0.1,\r\n        moveSpeed: 0.2,\r\n        rotateSpeed: 0.01,\r\n        zoomSpeed: 1,\r\n      },\r\n      options || {},\r\n    );\r\n    this.rotateX = 0;\r\n    this.rotateY = 0;\r\n    this.eyePos = new Vector3();\r\n    this.upVector = Vector3.axisPY();\r\n    this.xVector = new Vector3();\r\n    this.target = new Vector3();\r\n    this.direction = new Vector3();\r\n    this.quat = new Quaternion();\r\n    this.scale = 1;\r\n  }\r\n  reset() {\r\n    this.mouseDown = false;\r\n    this.lastMouseX = 0;\r\n    this.lastMouseY = 0;\r\n    this.rotateX = 0;\r\n    this.rotateY = 0;\r\n    this.scale = 1;\r\n    this._loadCameraParams();\r\n  }\r\n  /** @internal */\r\n  protected _onMouseDown(evt: IMouseEvent) {\r\n    if (evt.button === 0) {\r\n      this.mouseDown = true;\r\n      this.lastMouseX = evt.offsetX;\r\n      this.lastMouseY = evt.offsetY;\r\n      this.rotateX = 0;\r\n      this.rotateY = 0;\r\n    }\r\n  }\r\n  /** @internal */\r\n  protected _onMouseUp(evt: IMouseEvent) {\r\n    if (evt.button === 0) {\r\n      this.mouseDown = false;\r\n    }\r\n  }\r\n  /** @internal */\r\n  protected _onMouseWheel(evt: IMouseEvent) {\r\n    const factor = Math.pow(0.9, Math.abs(this.options.zoomSpeed));\r\n    if (evt.wheelDeltaY > 0) {\r\n      this.scale /= factor;\r\n    } else {\r\n      this.scale *= factor;\r\n    }\r\n  }\r\n  /** @internal */\r\n  protected _onMouseMove(evt: IMouseEvent) {\r\n    if (this.mouseDown) {\r\n      const dx = evt.offsetX - this.lastMouseX;\r\n      const dy = evt.offsetY - this.lastMouseY;\r\n      this.lastMouseX = evt.offsetX;\r\n      this.lastMouseY = evt.offsetY;\r\n      this.rotateX -= dy * this.options.rotateSpeed;\r\n      this.rotateY -= dx * this.options.rotateSpeed;\r\n    }\r\n  }\r\n  /** @internal */\r\n  private _loadCameraParams() {\r\n    if (this._getCamera()) {\r\n      const mat = this._getCamera().worldMatrix;\r\n      mat.decomposeLookAt(this.eyePos, this.target);\r\n      Vector3.normalize(Vector3.sub(this.eyePos, this.target), this.direction);\r\n      Vector3.sub(this.eyePos, Vector3.scale(this.direction, this.options.distance), this.target);\r\n      mat.getRow3(0, this.xVector);\r\n    }\r\n  }\r\n  setOptions(opt?: IOrbitCameraModelOptions) {\r\n    opt && Object.assign(this.options, opt);\r\n    this.reset();\r\n  }\r\n  update() {\r\n    if (this._getCamera()) {\r\n      Quaternion.fromAxisAngle(this.xVector, this.rotateX, this.quat);\r\n      this.quat.transform(this.eyePos.subBy(this.target), this.eyePos);\r\n      Quaternion.fromEulerAngle(0, this.rotateY, 0, 'XYZ', this.quat);\r\n      this.quat.transform(this.eyePos, this.eyePos);\r\n      this.quat.transform(this.xVector, this.xVector).inplaceNormalize();\r\n      Vector3.normalize(this.eyePos, this.direction).inplaceNormalize();\r\n      Vector3.cross(this.direction, this.xVector, this.upVector).inplaceNormalize();\r\n      Vector3.add(this.target, Vector3.scale(this.direction, this.options.distance * this.scale), this.eyePos);\r\n      this._getCamera().lookAt(this.eyePos, this.target, this.upVector);\r\n      // this._loadCameraParams();\r\n      if (this.mouseDown) {\r\n        this.rotateX = 0;\r\n        this.rotateY = 0;\r\n      } else {\r\n        this.rotateX *= 1 - this.options.damping;\r\n        this.rotateY *= 1 - this.options.damping;\r\n        if (Math.abs(this.rotateX) < 0.0001) {\r\n          this.rotateX = 0;\r\n        }\r\n        if (Math.abs(this.rotateY) < 0.0001) {\r\n          this.rotateY = 0;\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
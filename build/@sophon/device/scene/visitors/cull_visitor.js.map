{"version":3,"file":"cull_visitor.js","sources":["../../../../../libs/device/src/scene/visitors/cull_visitor.ts"],"sourcesContent":["import { ClipState, AABB } from '@sophon/base';\r\nimport { GraphNode } from '../graph_node';\r\nimport { OctreeNode } from '../octree';\r\nimport { Mesh } from '../mesh';\r\nimport { Terrain } from '../terrain';\r\nimport { RenderQueue } from '../render_queue';\r\nimport { RENDER_PASS_TYPE_SHADOWMAP } from '../values';\r\nimport type { Visitor } from '../../misc';\r\nimport type { Camera } from '../camera';\r\nimport type { RenderPass } from '../renderers';\r\nimport type { Drawable } from '../drawable';\r\n\r\nexport class CullVisitor implements Visitor {\r\n  /** @internal */\r\n  private _camera: Camera;\r\n  /** @internal */\r\n  private _skipClipTest: boolean;\r\n  /** @internal */\r\n  private _renderQueue: RenderQueue;\r\n  /** @internal */\r\n  private _renderPass: RenderPass;\r\n  /** @internal */\r\n  private _postCullHook: (camera: Camera, drawable: Drawable, castShadow: boolean, clipState: ClipState, box: AABB) => boolean;\r\n  constructor(renderPass: RenderPass, camera?: Camera) {\r\n    this._camera = camera || null;\r\n    this._renderQueue = new RenderQueue(renderPass);\r\n    this._skipClipTest = false;\r\n    this._renderPass = renderPass;\r\n    this._postCullHook = null;\r\n  }\r\n  get camera() {\r\n    return this._camera;\r\n  }\r\n  set camera(camera: Camera) {\r\n    this._camera = camera || null;\r\n  }\r\n  get renderPass(): RenderPass {\r\n    return this._renderPass;\r\n  }\r\n  get renderQueue() {\r\n    return this._renderQueue;\r\n  }\r\n  get frustum() {\r\n    return this._camera?.frustum || null;\r\n  }\r\n  get postCullHook(): (camera: Camera, drawable: Drawable, castShadow: boolean, clipState: ClipState, box: AABB) => boolean {\r\n    return this._postCullHook;\r\n  }\r\n  set postCullHook(hook: (camera: Camera, drawable: Drawable, castShadow: boolean, clipState: ClipState, box: AABB) => boolean) {\r\n    this._postCullHook = hook;\r\n  }\r\n  push(camera: Camera, drawable: Drawable, renderOrder: number, castShadow: boolean, clipState: ClipState, box: AABB) {\r\n    if (!this._postCullHook || this._postCullHook(camera, drawable, castShadow, clipState, box)) {\r\n      this.renderQueue.push(camera, drawable, renderOrder);\r\n    }\r\n  }\r\n  visit(target: unknown): unknown {\r\n    if (target instanceof Mesh) {\r\n      return this.visitMesh(target);\r\n    } else if (target instanceof OctreeNode) {\r\n      return this.visitOctreeNode(target);\r\n    } else if (target instanceof Terrain) {\r\n      return this.visitTerrain(target);\r\n    }\r\n  }\r\n  visitTerrain(node: Terrain) {\r\n    if (node.computedShowState !== GraphNode.SHOW_HIDE && (node.castShadow || this._renderPass.getRenderPassType() !== RENDER_PASS_TYPE_SHADOWMAP)) {\r\n      const clipState = this.getClipState(node);\r\n      if (clipState !== ClipState.NOT_CLIPPED) {\r\n        if (node.cull(this)) {\r\n          this.push(this._camera, node, node.computedRenderOrder, node.castShadow, clipState, node.getWorldBoundingVolume()?.toAABB());\r\n        }\r\n      }\r\n    }\r\n  }\r\n  visitMesh(node: Mesh) {\r\n    if (node.computedShowState !== GraphNode.SHOW_HIDE && (node.castShadow || this._renderPass.getRenderPassType() !== RENDER_PASS_TYPE_SHADOWMAP)) {\r\n      const clipState = this.getClipState(node);\r\n      if (clipState !== ClipState.NOT_CLIPPED) {\r\n        this.push(this._camera, node, node.computedRenderOrder, node.castShadow, clipState, node.getWorldBoundingVolume()?.toAABB());\r\n      }\r\n    }\r\n  }\r\n  visitOctreeNode(node: OctreeNode) {\r\n    const clipState =\r\n      node.getLevel() > 0\r\n        ? node.getBoxLoosed().getClipStateWithFrustum(this.frustum)\r\n        : ClipState.CLIPPED;\r\n    if (clipState !== ClipState.NOT_CLIPPED) {\r\n      const saveSkipFlag = this._skipClipTest;\r\n      this._skipClipTest = clipState === ClipState.A_INSIDE_B;\r\n      const nodes = node.getNodes();\r\n      for (let i = 0; i < nodes.length; i++) {\r\n        this.visit(nodes[i]);\r\n      }\r\n      this._skipClipTest = saveSkipFlag;\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n  /** @internal */\r\n  protected getClipState(node: GraphNode): ClipState {\r\n    let clipState: ClipState;\r\n    if (this._skipClipTest) {\r\n      clipState = ClipState.A_INSIDE_B;\r\n    } else if (node.computedClipMode === GraphNode.CLIP_DISABLED) {\r\n      clipState = ClipState.CLIPPED;\r\n    } else {\r\n      const bv = node.getWorldBoundingVolume();\r\n      clipState = bv ? bv.toAABB().getClipStateWithFrustum(this.frustum) : ClipState.CLIPPED;\r\n    }\r\n    return clipState;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
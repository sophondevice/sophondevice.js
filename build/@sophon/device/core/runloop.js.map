{"version":3,"file":"runloop.js","sources":["../../../../libs/device/src/core/runloop.ts"],"sourcesContent":["const runningLoopStack: RunLoop[] = [];\nconst runLoopQueue: RunLoop[] = [];\n\nfunction runLoopFunc() {\n  console.assert(runningLoopStack.length > 0, 'running loop stack error');\n  const currentLoop = runningLoopStack[runningLoopStack.length - 1];\n  currentLoop._processFrameTasks();\n\n  if (currentLoop.mainFunc(...currentLoop.runArgs)) {\n    console.assert(\n      runningLoopStack.length > 0 && runningLoopStack[runningLoopStack.length - 1] === currentLoop,\n      'running loop error'\n    );\n    runningLoopStack.pop();\n    currentLoop.atexit && currentLoop.atexit();\n  }\n\n  while (runLoopQueue.length > 0) {\n    const rl = runLoopQueue.splice(0, 1);\n    runningLoopStack.push(rl[0]);\n  }\n\n  if (runningLoopStack.length > 0) {\n    requestAnimationFrame(runLoopFunc);\n  }\n}\n\nexport interface IRunLoopOptions {\n  main: (...args: unknown[]) => boolean;\n  atexit?: () => void;\n  eventFilter?: (target: unknown, evt: unknown) => boolean;\n  noFrameEvents?: boolean;\n}\n\nexport class RunLoop {\n  /** @internal */\n  private _options: IRunLoopOptions;\n  /** @internal */\n  private _runArgs: unknown[];\n  /** @internal */\n  private _frameTasks: (() => void)[];\n  constructor(options?: IRunLoopOptions | ((...args: unknown[])=>boolean)) {\n    this._runArgs = [];\n    this._frameTasks = [];\n    this._options = {\n      main: null,\n      atexit: null,\n      eventFilter: null,\n      noFrameEvents: false,\n    };\n    if (options) {\n      if (typeof options === 'function') {\n        this._options.main = options;\n      } else {\n        Object.assign(this._options, options);\n      }\n    }\n  }\n  get eventFilter() {\n    return this._options.eventFilter;\n  }\n  set eventFilter(filter: (target: unknown, evt: unknown) => boolean) {\n    this._options.eventFilter = filter || null;\n  }\n  get noFrameEvents(): boolean {\n    return !!this._options.noFrameEvents;\n  }\n  set noFrameEvents(val: boolean) {\n    this._options.noFrameEvents = val;\n  }\n  get runArgs() {\n    return this._runArgs;\n  }\n  set runArgs(args) {\n    this._runArgs = args;\n  }\n  get mainFunc() {\n    return this._options.main;\n  }\n  set mainFunc(func: (...args: unknown[]) => boolean) {\n    this._options.main = func || null;\n  }\n  get atexit() {\n    return this._options.atexit;\n  }\n  set atexit(func: () => void) {\n    this._options.atexit = func || null;\n  }\n  scheduleNextFrame(task: () => void) {\n    task && this._frameTasks.push(task);\n  }\n  /** @internal */\n  _processFrameTasks() {\n    for (const f of this._frameTasks) {\n      f();\n    }\n    this._frameTasks = [];\n  }\n  run(...args: unknown[]) {\n    console.assert(!!this._options.main, 'invalid runloop main function')\n    this._runArgs = [...args];\n    if (runningLoopStack.indexOf(this) < 0) {\n      if (runningLoopStack.length === 0) {\n        console.assert(runLoopQueue.length === 0, 'run loop queue error');\n        runningLoopStack.push(this);\n        runLoopFunc();\n      } else if (runLoopQueue.indexOf(this) < 0) {\n        runLoopQueue.push(this);\n      }\n    }\n  }\n  static current(): RunLoop {\n    return runningLoopStack[runningLoopStack.length - 1];\n  }\n}\n"],"names":[],"mappings":"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"}
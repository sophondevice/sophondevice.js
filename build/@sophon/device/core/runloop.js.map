{"version":3,"file":"runloop.js","sources":["../../../../libs/device/src/core/runloop.ts"],"sourcesContent":["const runningLoopStack: RunLoop[] = [];\r\nconst runLoopQueue: RunLoop[] = [];\r\n\r\nfunction runLoopFunc() {\r\n  console.assert(runningLoopStack.length > 0, 'running loop stack error');\r\n  const currentLoop = runningLoopStack[runningLoopStack.length - 1];\r\n  currentLoop._processFrameTasks();\r\n\r\n  if (currentLoop.mainFunc(...currentLoop.runArgs)) {\r\n    console.assert(\r\n      runningLoopStack.length > 0 && runningLoopStack[runningLoopStack.length - 1] === currentLoop,\r\n      'running loop error'\r\n    );\r\n    runningLoopStack.pop();\r\n    currentLoop.atexit && currentLoop.atexit();\r\n  }\r\n\r\n  while (runLoopQueue.length > 0) {\r\n    const rl = runLoopQueue.splice(0, 1);\r\n    runningLoopStack.push(rl[0]);\r\n  }\r\n\r\n  if (runningLoopStack.length > 0) {\r\n    requestAnimationFrame(runLoopFunc);\r\n  }\r\n}\r\n\r\nexport interface IRunLoopOptions {\r\n  main: (...args: unknown[]) => boolean;\r\n  atexit?: () => void;\r\n  eventFilter?: (target: unknown, evt: unknown) => boolean;\r\n  noFrameEvents?: boolean;\r\n}\r\n\r\nexport class RunLoop {\r\n  /** @internal */\r\n  private _options: IRunLoopOptions;\r\n  /** @internal */\r\n  private _runArgs: unknown[];\r\n  /** @internal */\r\n  private _frameTasks: (() => void)[];\r\n  constructor(options?: IRunLoopOptions | ((...args: unknown[])=>boolean)) {\r\n    this._runArgs = [];\r\n    this._frameTasks = [];\r\n    this._options = {\r\n      main: null,\r\n      atexit: null,\r\n      eventFilter: null,\r\n      noFrameEvents: false,\r\n    };\r\n    if (options) {\r\n      if (typeof options === 'function') {\r\n        this._options.main = options;\r\n      } else {\r\n        Object.assign(this._options, options);\r\n      }\r\n    }\r\n  }\r\n  get eventFilter() {\r\n    return this._options.eventFilter;\r\n  }\r\n  set eventFilter(filter: (target: unknown, evt: unknown) => boolean) {\r\n    this._options.eventFilter = filter || null;\r\n  }\r\n  get noFrameEvents(): boolean {\r\n    return !!this._options.noFrameEvents;\r\n  }\r\n  set noFrameEvents(val: boolean) {\r\n    this._options.noFrameEvents = val;\r\n  }\r\n  get runArgs() {\r\n    return this._runArgs;\r\n  }\r\n  set runArgs(args) {\r\n    this._runArgs = args;\r\n  }\r\n  get mainFunc() {\r\n    return this._options.main;\r\n  }\r\n  set mainFunc(func: (...args: unknown[]) => boolean) {\r\n    this._options.main = func || null;\r\n  }\r\n  get atexit() {\r\n    return this._options.atexit;\r\n  }\r\n  set atexit(func: () => void) {\r\n    this._options.atexit = func || null;\r\n  }\r\n  scheduleNextFrame(task: () => void) {\r\n    task && this._frameTasks.push(task);\r\n  }\r\n  /** @internal */\r\n  _processFrameTasks() {\r\n    for (const f of this._frameTasks) {\r\n      f();\r\n    }\r\n    this._frameTasks = [];\r\n  }\r\n  run(...args: unknown[]) {\r\n    console.assert(!!this._options.main, 'invalid runloop main function')\r\n    this._runArgs = [...args];\r\n    if (runningLoopStack.indexOf(this) < 0) {\r\n      if (runningLoopStack.length === 0) {\r\n        console.assert(runLoopQueue.length === 0, 'run loop queue error');\r\n        runningLoopStack.push(this);\r\n        runLoopFunc();\r\n      } else if (runLoopQueue.indexOf(this) < 0) {\r\n        runLoopQueue.push(this);\r\n      }\r\n    }\r\n  }\r\n  static current(): RunLoop {\r\n    return runningLoopStack[runningLoopStack.length - 1];\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
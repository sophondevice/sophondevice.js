{"version":3,"file":"image_manager.js","sources":["../../../libs/dom/src/image_manager.ts"],"sourcesContent":["import { TextureAtlas } from './texture_atlas';\nimport { AtlasManager, IAtlasInfo } from './atlas_manager';\nimport type { GUIRenderer } from './renderer';\n\nexport class ImageManager {\n  /** @internal */\n  protected _renderer: GUIRenderer;\n  /** @internal */\n  protected _atlasManager: AtlasManager;\n  /** @internal */\n  protected _cachedImages: { [name: string]: TextureAtlas };\n  /** @internal */\n  protected _urlImages: { [url: string]: TextureAtlas };\n  constructor(renderer: GUIRenderer) {\n    this._renderer = renderer;\n    this._cachedImages = {};\n    this._urlImages = {};\n    this._atlasManager = new AtlasManager(this._renderer, 1024, 1024, 0, false);\n    this._atlasManager.atlasTextureRestoreHandler = async tex => {\n      if (!this._atlasManager.isEmpty()) {\n        this._atlasManager.clear();\n        this._createBuiltinImages();\n      }\n    };\n    this._createBuiltinImages();\n  }\n  get renderer() {\n    return this._renderer;\n  }\n  getImage(name: string): TextureAtlas {\n    return this._cachedImages[name] || null;\n  }\n  dispose() {\n    this._cachedImages = {};\n    this._urlImages = {};\n  }\n  /** @internal */\n  private _createBuiltinImages() {\n    let cvs = document.createElement('canvas');\n    cvs.width = 256;\n    cvs.height = 256;\n    const ctx = cvs.getContext('2d', { alpha: true });\n    ctx.imageSmoothingEnabled = false;\n    let offsetX = 0;\n    let offsetY = 0;\n\n    // 测量stroke偏移\n    ctx.lineWidth = 1;\n    ctx.strokeStyle = '#ffffff';\n    ctx.clearRect(0, 0, 10, 2);\n    ctx.beginPath();\n    ctx.moveTo(0, 0);\n    ctx.lineTo(10, 0);\n    ctx.stroke();\n    const bitmap = ctx.getImageData(0, 0, 10, 2);\n    if (bitmap.data[5 * 4 + 3] < 255) {\n      offsetX = 0.5;\n      offsetY = 0.5;\n    }\n\n    let size = 10;\n    let atlasInfo: IAtlasInfo;\n    ctx.fillStyle = '#ffffff';\n\n    // input\n    ctx.strokeStyle = '#000000';\n    ctx.lineWidth = 1;\n    ctx.clearRect(0, 0, size, size);\n    ctx.beginPath();\n    const radius = (size - 2) / 2;\n    ctx.ellipse(1 + radius + offsetX, 1 + radius + offsetY, radius, radius, 0, 0, 2 * Math.PI);\n    ctx.fill();\n    ctx.stroke();\n    atlasInfo = this._atlasManager.pushCanvas('default.input', ctx, 0, 0, size, size);\n    this._cachedImages['default.input'] = new TextureAtlas(\n      this._atlasManager.getAtlasTexture(atlasInfo.atlasIndex),\n      { x: atlasInfo.uMin, y: atlasInfo.vMin },\n      { x: atlasInfo.uMax, y: atlasInfo.vMax },\n      { x: 0.5, y: 0.5 },\n      { x: 0.5, y: 0.5 },\n    );\n\n    // button\n    ctx.clearRect(0, 0, size, size);\n    ctx.beginPath();\n    ctx.ellipse(1 + radius + offsetX, 1 + radius + offsetY, radius, radius, 0, 0, 2 * Math.PI);\n    ctx.fill();\n    atlasInfo = this._atlasManager.pushCanvas('default.button', ctx, 0, 0, size, size);\n    this._cachedImages['default.button'] = new TextureAtlas(\n      this._atlasManager.getAtlasTexture(atlasInfo.atlasIndex),\n      { x: atlasInfo.uMin, y: atlasInfo.vMin },\n      { x: atlasInfo.uMax, y: atlasInfo.vMax },\n      { x: 0.5, y: 0.5 },\n      { x: 0.5, y: 0.5 },\n    );\n\n    size = 32;\n    ctx.fillStyle = '#ffffff';\n    ctx.fillRect(0, 0, size, size);\n    ctx.fillStyle = '#aaaaaa';\n    pathTriangle(ctx, ORIENTATION_VERTICAL, 16, 10, -10, 10, 14);\n    ctx.fill();\n    atlasInfo = this._atlasManager.pushCanvas('default.scrollbar.down', ctx, 0, 0, size, size);\n    this._cachedImages['default.scrollbar.down'] = new TextureAtlas(\n      this._atlasManager.getAtlasTexture(atlasInfo.atlasIndex),\n      { x: atlasInfo.uMin, y: atlasInfo.vMin },\n      { x: atlasInfo.uMax, y: atlasInfo.vMax },\n    );\n\n    ctx.fillStyle = '#ffffff';\n    ctx.fillRect(0, 0, size, size);\n    ctx.fillStyle = '#aaaaaa';\n    pathTriangle(ctx, ORIENTATION_VERTICAL, 16, 24, -10, 10, -14);\n    ctx.fill();\n    atlasInfo = this._atlasManager.pushCanvas('default.scrollbar.up', ctx, 0, 0, size, size);\n    this._cachedImages['default.scrollbar.up'] = new TextureAtlas(\n      this._atlasManager.getAtlasTexture(atlasInfo.atlasIndex),\n      { x: atlasInfo.uMin, y: atlasInfo.vMin },\n      { x: atlasInfo.uMax, y: atlasInfo.vMax },\n    );\n\n    ctx.fillStyle = '#ffffff';\n    ctx.fillRect(0, 0, size, size);\n    ctx.fillStyle = '#aaaaaa';\n    pathTriangle(ctx, ORIENTATION_HORIZONAL, 24, 16, -10, 10, -14);\n    ctx.fill();\n    atlasInfo = this._atlasManager.pushCanvas('default.scrollbar.left', ctx, 0, 0, size, size);\n    this._cachedImages['default.scrollbar.left'] = new TextureAtlas(\n      this._atlasManager.getAtlasTexture(atlasInfo.atlasIndex),\n      { x: atlasInfo.uMin, y: atlasInfo.vMin },\n      { x: atlasInfo.uMax, y: atlasInfo.vMax },\n    );\n\n    ctx.fillStyle = '#ffffff';\n    ctx.fillRect(0, 0, size, size);\n    ctx.fillStyle = '#aaaaaa';\n    pathTriangle(ctx, ORIENTATION_HORIZONAL, 10, 16, -10, 10, 14);\n    ctx.fill();\n    atlasInfo = this._atlasManager.pushCanvas('default.scrollbar.right', ctx, 0, 0, size, size);\n    this._cachedImages['default.scrollbar.right'] = new TextureAtlas(\n      this._atlasManager.getAtlasTexture(atlasInfo.atlasIndex),\n      { x: atlasInfo.uMin, y: atlasInfo.vMin },\n      { x: atlasInfo.uMax, y: atlasInfo.vMax },\n    );\n\n    cvs = null;\n  }\n}\n\nconst ORIENTATION_HORIZONAL = 0;\nconst ORIENTATION_VERTICAL = 1;\n\nfunction pathTriangle(\n  ctx: CanvasRenderingContext2D,\n  orientation: number,\n  anchorX: number,\n  anchorY: number,\n  left: number,\n  right: number,\n  top: number,\n) {\n  ctx.beginPath();\n  if (orientation === ORIENTATION_VERTICAL) {\n    ctx.moveTo(anchorX + left, anchorY);\n    ctx.lineTo(anchorX + right, anchorY);\n    ctx.lineTo(anchorX, anchorY + top);\n  } else {\n    ctx.moveTo(anchorX, anchorY + left);\n    ctx.lineTo(anchorX, anchorY + right);\n    ctx.lineTo(anchorX + top, anchorY);\n  }\n  ctx.closePath();\n}\n"],"names":[],"mappings":"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"}
{"version":3,"file":"font.js","sources":["../../../libs/dom/src/font.ts"],"sourcesContent":["export class FontCanvas {\n  private static _canvas: HTMLCanvasElement = null;\n  private static _context: CanvasRenderingContext2D = null;\n  private static _currentFont: string = null;\n  static get canvas() {\n    this._realize();\n    return this._canvas;\n  }\n  static get context() {\n    this._realize();\n    return this._context;\n  }\n  static get font() {\n    return this.context.font;\n  }\n  static set font(font: string) {\n    this.context.font = font;\n  }\n  private static _realize() {\n    if (!this._canvas) {\n      this._canvas = document.createElement('canvas');\n      this._canvas.width = 512;\n      this._canvas.height = 512;\n      this._canvas.style.left = '-10000px';\n      this._canvas.style.position = 'absolute';\n      document.body.appendChild(this._canvas);\n      this._context = this._canvas.getContext('2d', {\n        willReadFrequently: true\n      });\n      this._context.textBaseline = 'top';\n      this._context.textAlign = 'left';\n      this._context.fillStyle = 'transparent';\n      this._context.fillRect(0, 0, this._canvas.width, this._canvas.height);\n      this._context.fillStyle = '#ffffff';\n      this._context.imageSmoothingEnabled = true;\n    }\n  }\n}\n\nexport class Font {\n  /** @internal */\n  private static fontCache: {\n    [name: string]: {\n      [scale: number]: Font\n    }\n  } = {};\n  /** @internal */\n  private _name: string;\n  /** @internal */\n  private _nameScaled: string;\n  /** @internal */\n  private _scale: number;\n  /** @internal */\n  private _size: number;\n  /** @internal */\n  private _family: string;\n  /** @internal */\n  private _top: number;\n  /** @internal */\n  private _bottom: number;\n  /** @internal */\n  private _topScaled: number;\n  /** @internal */\n  private _bottomScaled: number;\n  constructor(name: string, scale: number) {\n    this._top = 0;\n    this._bottom = 0;\n    this._size = 0;\n    this._topScaled = 0;\n    this._bottomScaled = 0;\n    this._family = '';\n    this._scale = scale;\n    this._name = name;\n    this._nameScaled = null;\n    if (this._name) {\n      this._normalizeFont();\n    }\n  }\n  static fetchFont(name: string, scale: number): Font {\n    let fontlist = this.fontCache[name];\n    if (!fontlist) {\n      fontlist = {};\n      this.fontCache[name] = fontlist;\n    }\n    let font = fontlist[scale];\n    if (!font) {\n      font = new Font(name, scale);\n      fontlist[scale] = font;\n    }\n    return font;\n  }\n  get fontName(): string {\n    return this._name;\n  }\n  set fontName(name: string) {\n    this._name = name;\n    this._normalizeFont();\n  }\n  get fontNameScaled(): string {\n    return this._nameScaled;\n  }\n  get size(): number {\n    return this._size;\n  }\n  get family(): string {\n    return this._family;\n  }\n  get top(): number {\n    return this._top;\n  }\n  get bottom(): number {\n    return this._bottom;\n  }\n  get maxHeight(): number {\n    return this._bottom - this._top + 1;\n  }\n  get topScaled(): number {\n    return this._topScaled;\n  }\n  get bottomScaled(): number {\n    return this._bottomScaled;\n  }\n  get maxHeightScaled(): number {\n    return this._bottomScaled - this._topScaled + 1;\n  }\n  equalTo(other: Font): boolean {\n    return this._size === other._size && this._family === other._family;\n  }\n  /** @internal */\n  private _measureFontHeight(fontName: string): { size: number, family: string, top: number, bottom: number } {\n    const oldFont = FontCanvas.context.font;\n    const oldTextBaseline = FontCanvas.context.textBaseline;\n    const oldFillStyle = FontCanvas.context.fillStyle;\n\n    const fontParts = fontName.split(/\\s+/);\n    console.assert(fontParts.length >= 2, 'normalize font failed');\n    const sizePart = fontParts[fontParts.length - 2];\n    console.assert(sizePart.slice(sizePart.length - 2) === 'px', 'normalize font failed');\n    const size = parseInt(sizePart.substring(0, sizePart.length - 2));\n    const family = fontParts[fontParts.length - 1];\n\n    FontCanvas.context.font = fontName;\n    const testString = 'bdfghijklpq国美|_~';\n    const metric = FontCanvas.context.measureText(testString);\n    let top: number, bottom: number;\n    top = 0;\n    bottom = size - 1;\n    const extra = 10;\n    const halfExtra = extra >> 1;\n    const maxWidth = Math.ceil(metric.width) + extra;\n    const maxHeight = size + extra;\n    FontCanvas.context.clearRect(0, 0, maxWidth, maxHeight);\n    FontCanvas.context.textBaseline = 'top';\n    FontCanvas.context.fillStyle = '#ffffff';\n    FontCanvas.context.fillText(testString, halfExtra, halfExtra);\n    const bitmap = FontCanvas.context.getImageData(0, 0, maxWidth, maxHeight);\n    const pixels = bitmap.data;\n    for (let i = 0; i < maxWidth * maxHeight; i++) {\n      if (pixels[i * 4 + 3] > 0) {\n        top = Math.floor(i / maxWidth);\n        break;\n      }\n    }\n    for (let i = maxWidth * maxHeight - 1; i >= 0; i--) {\n      if (pixels[i * 4 + 3] > 0) {\n        bottom = Math.floor(i / maxWidth);\n        break;\n      }\n    }\n    top -= halfExtra;\n    bottom -= halfExtra;\n    FontCanvas.context.font = oldFont;\n    FontCanvas.context.textBaseline = oldTextBaseline;\n    FontCanvas.context.fillStyle = oldFillStyle;\n\n    return { size, family, top, bottom };\n  }\n  /** @internal */\n  private _normalizeFont(): void {\n    const info = this._measureFontHeight(this._name);\n    this._nameScaled = `${Math.round(info.size * this._scale)}px ${info.family}`;\n    const infoScaled = this._measureFontHeight(this._nameScaled);\n    this._size = info.size;\n    this._family = info.family;\n    this._top = info.top;\n    this._bottom = info.bottom;\n    this._topScaled = infoScaled.top;\n    this._bottomScaled = infoScaled.bottom;\n  }\n}\n"],"names":[],"mappings":"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"}
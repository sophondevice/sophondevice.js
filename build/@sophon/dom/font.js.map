{"version":3,"file":"font.js","sources":["../../../libs/dom/src/font.ts"],"sourcesContent":["export class FontCanvas {\r\n  private static _canvas: HTMLCanvasElement = null;\r\n  private static _context: CanvasRenderingContext2D = null;\r\n  private static _currentFont: string = null;\r\n  static get canvas() {\r\n    this._realize();\r\n    return this._canvas;\r\n  }\r\n  static get context() {\r\n    this._realize();\r\n    return this._context;\r\n  }\r\n  static get font() {\r\n    return this.context.font;\r\n  }\r\n  static set font(font: string) {\r\n    this.context.font = font;\r\n  }\r\n  private static _realize() {\r\n    if (!this._canvas) {\r\n      this._canvas = document.createElement('canvas');\r\n      this._canvas.width = 512;\r\n      this._canvas.height = 512;\r\n      this._canvas.style.left = '-10000px';\r\n      this._canvas.style.position = 'absolute';\r\n      document.body.appendChild(this._canvas);\r\n      this._context = this._canvas.getContext('2d', {\r\n        willReadFrequently: true\r\n      });\r\n      this._context.textBaseline = 'top';\r\n      this._context.textAlign = 'left';\r\n      this._context.fillStyle = 'transparent';\r\n      this._context.fillRect(0, 0, this._canvas.width, this._canvas.height);\r\n      this._context.fillStyle = '#ffffff';\r\n      this._context.imageSmoothingEnabled = true;\r\n    }\r\n  }\r\n}\r\n\r\nexport class Font {\r\n  /** @internal */\r\n  private static fontCache: {\r\n    [name: string]: {\r\n      [scale: number]: Font\r\n    }\r\n  } = {};\r\n  /** @internal */\r\n  private _name: string;\r\n  /** @internal */\r\n  private _nameScaled: string;\r\n  /** @internal */\r\n  private _scale: number;\r\n  /** @internal */\r\n  private _size: number;\r\n  /** @internal */\r\n  private _family: string;\r\n  /** @internal */\r\n  private _top: number;\r\n  /** @internal */\r\n  private _bottom: number;\r\n  /** @internal */\r\n  private _topScaled: number;\r\n  /** @internal */\r\n  private _bottomScaled: number;\r\n  constructor(name: string, scale: number) {\r\n    this._top = 0;\r\n    this._bottom = 0;\r\n    this._size = 0;\r\n    this._topScaled = 0;\r\n    this._bottomScaled = 0;\r\n    this._family = '';\r\n    this._scale = scale;\r\n    this._name = name;\r\n    this._nameScaled = null;\r\n    if (this._name) {\r\n      this._normalizeFont();\r\n    }\r\n  }\r\n  static fetchFont(name: string, scale: number): Font {\r\n    let fontlist = this.fontCache[name];\r\n    if (!fontlist) {\r\n      fontlist = {};\r\n      this.fontCache[name] = fontlist;\r\n    }\r\n    let font = fontlist[scale];\r\n    if (!font) {\r\n      font = new Font(name, scale);\r\n      fontlist[scale] = font;\r\n    }\r\n    return font;\r\n  }\r\n  get fontName(): string {\r\n    return this._name;\r\n  }\r\n  set fontName(name: string) {\r\n    this._name = name;\r\n    this._normalizeFont();\r\n  }\r\n  get fontNameScaled(): string {\r\n    return this._nameScaled;\r\n  }\r\n  get size(): number {\r\n    return this._size;\r\n  }\r\n  get family(): string {\r\n    return this._family;\r\n  }\r\n  get top(): number {\r\n    return this._top;\r\n  }\r\n  get bottom(): number {\r\n    return this._bottom;\r\n  }\r\n  get maxHeight(): number {\r\n    return this._bottom - this._top + 1;\r\n  }\r\n  get topScaled(): number {\r\n    return this._topScaled;\r\n  }\r\n  get bottomScaled(): number {\r\n    return this._bottomScaled;\r\n  }\r\n  get maxHeightScaled(): number {\r\n    return this._bottomScaled - this._topScaled + 1;\r\n  }\r\n  equalTo(other: Font): boolean {\r\n    return this._size === other._size && this._family === other._family;\r\n  }\r\n  /** @internal */\r\n  private _measureFontHeight(fontName: string): { size: number, family: string, top: number, bottom: number } {\r\n    const oldFont = FontCanvas.context.font;\r\n    const oldTextBaseline = FontCanvas.context.textBaseline;\r\n    const oldFillStyle = FontCanvas.context.fillStyle;\r\n\r\n    const fontParts = fontName.split(/\\s+/);\r\n    console.assert(fontParts.length >= 2, 'normalize font failed');\r\n    const sizePart = fontParts[fontParts.length - 2];\r\n    console.assert(sizePart.slice(sizePart.length - 2) === 'px', 'normalize font failed');\r\n    const size = parseInt(sizePart.substring(0, sizePart.length - 2));\r\n    const family = fontParts[fontParts.length - 1];\r\n\r\n    FontCanvas.context.font = fontName;\r\n    const testString = 'bdfghijklpq国美|_~';\r\n    const metric = FontCanvas.context.measureText(testString);\r\n    let top: number, bottom: number;\r\n    top = 0;\r\n    bottom = size - 1;\r\n    const extra = 10;\r\n    const halfExtra = extra >> 1;\r\n    const maxWidth = Math.ceil(metric.width) + extra;\r\n    const maxHeight = size + extra;\r\n    FontCanvas.context.clearRect(0, 0, maxWidth, maxHeight);\r\n    FontCanvas.context.textBaseline = 'top';\r\n    FontCanvas.context.fillStyle = '#ffffff';\r\n    FontCanvas.context.fillText(testString, halfExtra, halfExtra);\r\n    const bitmap = FontCanvas.context.getImageData(0, 0, maxWidth, maxHeight);\r\n    const pixels = bitmap.data;\r\n    for (let i = 0; i < maxWidth * maxHeight; i++) {\r\n      if (pixels[i * 4 + 3] > 0) {\r\n        top = Math.floor(i / maxWidth);\r\n        break;\r\n      }\r\n    }\r\n    for (let i = maxWidth * maxHeight - 1; i >= 0; i--) {\r\n      if (pixels[i * 4 + 3] > 0) {\r\n        bottom = Math.floor(i / maxWidth);\r\n        break;\r\n      }\r\n    }\r\n    top -= halfExtra;\r\n    bottom -= halfExtra;\r\n    FontCanvas.context.font = oldFont;\r\n    FontCanvas.context.textBaseline = oldTextBaseline;\r\n    FontCanvas.context.fillStyle = oldFillStyle;\r\n\r\n    return { size, family, top, bottom };\r\n  }\r\n  /** @internal */\r\n  private _normalizeFont(): void {\r\n    const info = this._measureFontHeight(this._name);\r\n    this._nameScaled = `${Math.round(info.size * this._scale)}px ${info.family}`;\r\n    const infoScaled = this._measureFontHeight(this._nameScaled);\r\n    this._size = info.size;\r\n    this._family = info.family;\r\n    this._top = info.top;\r\n    this._bottom = info.bottom;\r\n    this._topScaled = infoScaled.top;\r\n    this._bottomScaled = infoScaled.bottom;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}